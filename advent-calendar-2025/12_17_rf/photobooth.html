<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Booth</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Press Start 2P', monospace;
            background: #2a1a3a;
            overflow: hidden;
            min-height: 100vh;
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: pixelated;
        }
        #webcam {
            position: fixed;
            opacity: 0;
            pointer-events: none;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 100, 100, 0.9);
            border: 3px solid #aa0000;
            border-radius: 8px;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 1000;
        }
        .back-button:hover { background: rgba(255, 50, 50, 1); }
    </style>
</head>
<body>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="gameCanvas"></canvas>
    <button class="back-button" onclick="exitGame()">EXIT (ESC)</button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('webcam');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const keys = {};
        let state = 'intro'; // 'intro', 'posing', 'countdown', 'flash', 'photo', 'billyPhoto'
        let countdown = 3;
        let countdownTimer = 0;
        let flashOpacity = 0;
        let photoTaken = false;
        let showBillyPhoto = false;
        let capturedImage = null;
        let webcamActive = false;
        let webcamError = false;

        // Get today's date formatted
        function getTodayDate() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = now.getFullYear();
            return `${month}/${day}/${year}`;
        }
        const todayDate = getTodayDate();

        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === 'Escape') exitGame();

            if (e.key === ' ') {
                if (state === 'intro') {
                    state = 'posing';
                    startWebcam();
                } else if (state === 'posing') {
                    state = 'countdown';
                    countdown = 3;
                    countdownTimer = 60;
                } else if (state === 'photo') {
                    showBillyPhoto = true;
                    state = 'billyPhoto';
                } else if (state === 'billyPhoto') {
                    exitGame();
                }
            }
        });

        document.addEventListener('keyup', (e) => { keys[e.key] = false; });

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
                });
                video.srcObject = stream;
                webcamActive = true;
            } catch (err) {
                console.log('Webcam not available:', err);
                webcamError = true;
            }
        }

        function capturePhoto() {
            if (webcamActive && video.readyState >= 2) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                // Mirror the image for selfie effect
                tempCtx.translate(tempCanvas.width, 0);
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(video, 0, 0);
                capturedImage = tempCanvas;
            }
        }

        function stopWebcam() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function exitGame() {
            stopWebcam();
            if (window.parent && window.parent !== window) {
                window.parent.postMessage('closeMinigame', '*');
            } else {
                window.history.back();
            }
        }

        function update() {
            if (state === 'countdown') {
                countdownTimer--;
                if (countdownTimer <= 0) {
                    countdown--;
                    countdownTimer = 60;
                    if (countdown <= 0) {
                        capturePhoto();
                        state = 'flash';
                        flashOpacity = 1;
                        photoTaken = true;
                    }
                }
            }

            if (state === 'flash') {
                flashOpacity -= 0.03;
                if (flashOpacity <= 0) {
                    flashOpacity = 0;
                    state = 'photo';
                }
            }
        }

        function render() {
            // Booth interior background
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#4a2a6a');
            grad.addColorStop(1, '#2a1a3a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Booth curtains
            ctx.fillStyle = '#8B0000';
            ctx.fillRect(0, 0, 80, canvas.height);
            ctx.fillRect(canvas.width - 80, 0, 80, canvas.height);

            // Curtain folds
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#6B0000' : '#9B0000';
                ctx.fillRect(i * 16, 0, 16, canvas.height);
                ctx.fillRect(canvas.width - 80 + i * 16, 0, 16, canvas.height);
            }

            // Booth seat
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(100, canvas.height - 150, canvas.width - 200, 150);
            ctx.fillStyle = '#6a6a6a';
            ctx.fillRect(100, canvas.height - 150, canvas.width - 200, 20);

            // Camera
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(canvas.width / 2 - 40, 50, 80, 60);
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 80, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = webcamActive ? '#4aff4a' : '#4a90d9';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 80, 18, 0, Math.PI * 2);
            ctx.fill();

            // Red recording light
            ctx.fillStyle = state === 'countdown' ? '#ff0000' : '#440000';
            ctx.beginPath();
            ctx.arc(canvas.width / 2 + 30, 60, 5, 0, Math.PI * 2);
            ctx.fill();

            if (state === 'intro') {
                drawIntroScreen();
            } else if (state === 'posing' || state === 'countdown') {
                drawPosing();
                if (state === 'countdown') {
                    drawCountdown();
                }
            } else if (state === 'flash') {
                drawPosing();
            } else if (state === 'photo') {
                drawPhotoResult();
            } else if (state === 'billyPhoto') {
                drawBillyPhoto();
            }

            // Flash effect
            if (flashOpacity > 0) {
                ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function drawIntroScreen() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 250, canvas.height / 2 - 150, 500, 300);

            ctx.fillStyle = '#ffd700';
            ctx.font = '24px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('PHOTO BOOTH', canvas.width / 2, canvas.height / 2 - 80);

            ctx.fillStyle = '#fff';
            ctx.font = '12px "Press Start 2P"';
            ctx.fillText('Strike a pose!', canvas.width / 2, canvas.height / 2 - 20);
            ctx.fillText('Smile for the camera!', canvas.width / 2, canvas.height / 2 + 20);
            ctx.fillText('', canvas.width / 2, canvas.height / 2 + 50);

            ctx.fillStyle = '#7cfc00';
            ctx.font = '14px "Press Start 2P"';
            ctx.fillText('Press SPACE to start', canvas.width / 2, canvas.height / 2 + 110);
        }

        function drawPosing() {
            // Live webcam preview area
            const previewW = Math.min(500, canvas.width - 200);
            const previewH = previewW * 0.75;
            const previewX = canvas.width / 2 - previewW / 2;
            const previewY = canvas.height / 2 - previewH / 2 - 30;

            // Preview frame
            ctx.fillStyle = '#333';
            ctx.fillRect(previewX - 10, previewY - 10, previewW + 20, previewH + 20);

            if (webcamActive && video.readyState >= 2) {
                // Mirror and draw live feed
                ctx.save();
                ctx.translate(previewX + previewW, previewY);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, previewW, previewH);
                ctx.restore();
            } else if (webcamError) {
                ctx.fillStyle = '#4a2a6a';
                ctx.fillRect(previewX, previewY, previewW, previewH);
                ctx.fillStyle = '#ff6b9d';
                ctx.font = '14px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('Camera not available', canvas.width / 2, canvas.height / 2 - 20);
                ctx.fillStyle = '#fff';
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText('(Using pixel Fede instead)', canvas.width / 2, canvas.height / 2 + 10);
                // Draw pixel Fede as fallback
                drawFedePose(canvas.width / 2, canvas.height / 2 + 80, 'normal');
            } else {
                ctx.fillStyle = '#4a2a6a';
                ctx.fillRect(previewX, previewY, previewW, previewH);
                ctx.fillStyle = '#fff';
                ctx.font = '12px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('Loading camera...', canvas.width / 2, canvas.height / 2);
            }

            // Cute frame overlay (optional decorations)
            ctx.strokeStyle = '#ff6b9d';
            ctx.lineWidth = 4;
            ctx.strokeRect(previewX - 5, previewY - 5, previewW + 10, previewH + 10);

            // Corner hearts
            const corners = [
                [previewX - 15, previewY - 15],
                [previewX + previewW + 5, previewY - 15],
                [previewX - 15, previewY + previewH + 5],
                [previewX + previewW + 5, previewY + previewH + 5]
            ];
            ctx.fillStyle = '#ff6b9d';
            for (const [hx, hy] of corners) {
                drawHeart(ctx, hx, hy, 8);
            }

            // Instructions
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 150, canvas.height - 100, 300, 60);

            ctx.fillStyle = '#fff';
            ctx.font = '12px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('Strike a pose!', canvas.width / 2, canvas.height - 75);

            ctx.fillStyle = '#7cfc00';
            ctx.font = '10px "Press Start 2P"';
            ctx.fillText('SPACE to take photo', canvas.width / 2, canvas.height - 50);
        }

        function drawCountdown() {
            ctx.fillStyle = '#ff0000';
            ctx.font = '120px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText(countdown.toString(), canvas.width / 2, canvas.height / 2);
        }

        function drawPhotoResult() {
            // Photo frame (polaroid style)
            const photoW = 300;
            const photoH = 400;
            const photoX = canvas.width / 2 - photoW / 2;
            const photoY = canvas.height / 2 - photoH / 2 - 30;

            // White border
            ctx.fillStyle = '#fff';
            ctx.fillRect(photoX - 20, photoY - 20, photoW + 40, photoH + 80);

            // Photo area
            if (capturedImage) {
                // Draw captured selfie
                const imgAspect = capturedImage.width / capturedImage.height;
                const frameAspect = photoW / photoH;
                let drawW, drawH, offsetX = 0, offsetY = 0;

                if (imgAspect > frameAspect) {
                    drawH = photoH;
                    drawW = photoH * imgAspect;
                    offsetX = -(drawW - photoW) / 2;
                } else {
                    drawW = photoW;
                    drawH = photoW / imgAspect;
                    offsetY = -(drawH - photoH) / 2;
                }

                ctx.save();
                ctx.beginPath();
                ctx.rect(photoX, photoY, photoW, photoH);
                ctx.clip();
                ctx.drawImage(capturedImage, photoX + offsetX, photoY + offsetY, drawW, drawH);
                ctx.restore();

                // Add fun decorations on top of photo
                drawPhotoDecorations(photoX, photoY, photoW, photoH);
            } else {
                // Fallback pixel art
                ctx.fillStyle = '#4a2a6a';
                ctx.fillRect(photoX, photoY, photoW, photoH);
                ctx.fillStyle = '#6B0000';
                ctx.fillRect(photoX, photoY, 30, photoH);
                ctx.fillRect(photoX + photoW - 30, photoY, 30, photoH);
                drawFedePose(photoX + photoW / 2, photoY + photoH - 100, 'normal', 0.8);

                // Add fun decorations
                drawPhotoDecorations(photoX, photoY, photoW, photoH);
            }

            // Date stamp
            ctx.fillStyle = '#ff6600';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText(todayDate, photoX + photoW - 10, photoY + photoH - 10);

            // Caption
            ctx.fillStyle = '#333';
            ctx.font = '12px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('FUN WORLD!', canvas.width / 2, photoY + photoH + 45);

            // Hint
            ctx.fillStyle = '#ffd700';
            ctx.font = '10px "Press Start 2P"';
            ctx.fillText('Press SPACE - someone left a photo here!', canvas.width / 2, canvas.height - 50);
        }

        function drawBillyPhoto() {
            // Billy's forgotten photo
            const photoW = 300;
            const photoH = 400;
            const photoX = canvas.width / 2 - photoW / 2;
            const photoY = canvas.height / 2 - photoH / 2 - 30;

            // Slightly crumpled/old polaroid
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(-0.05);
            ctx.translate(-canvas.width / 2, -canvas.height / 2);

            // Yellowed border
            ctx.fillStyle = '#f5f0dc';
            ctx.fillRect(photoX - 20, photoY - 20, photoW + 40, photoH + 80);

            // Photo area
            ctx.fillStyle = '#4a2a6a';
            ctx.fillRect(photoX, photoY, photoW, photoH);

            // Booth background
            ctx.fillStyle = '#6B0000';
            ctx.fillRect(photoX, photoY, 30, photoH);
            ctx.fillRect(photoX + photoW - 30, photoY, 30, photoH);

            // Draw Billy in photo (muscular, grey t-shirt, black hair)
            drawBillyPose(photoX + photoW / 2, photoY + photoH - 100, 0.8);

            // Old date stamp
            ctx.fillStyle = '#ff6600';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText(todayDate, photoX + photoW - 10, photoY + photoH - 10);

            // Billy's handwriting
            ctx.fillStyle = '#333';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('BILLY <3', canvas.width / 2, photoY + photoH + 35);
            ctx.font = '8px "Press Start 2P"';
            ctx.fillText('esperando a Fede', canvas.width / 2, photoY + photoH + 55);

            ctx.restore();

            // Dialog
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(canvas.width / 2 - 200, 40, 400, 80);
            ctx.fillStyle = '#fff';
            ctx.font = '11px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('Fede: "Billy estuvo acÃ¡!"', canvas.width / 2, 70);
            ctx.fillText('"Tengo que encontrarlo!"', canvas.width / 2, 100);

            // Exit hint
            ctx.fillStyle = '#7cfc00';
            ctx.font = '10px "Press Start 2P"';
            ctx.fillText('Press SPACE to continue', canvas.width / 2, canvas.height - 40);
        }

        function drawPhotoDecorations(photoX, photoY, photoW, photoH) {
            // Add cute decorations on top of the photo

            // Corner stars
            ctx.fillStyle = '#ffd700';
            drawStar(photoX + 25, photoY + 30, 12, 5);
            drawStar(photoX + photoW - 25, photoY + 30, 10, 5);
            drawStar(photoX + 20, photoY + photoH - 40, 8, 5);
            drawStar(photoX + photoW - 20, photoY + photoH - 40, 10, 5);

            // Sparkles scattered
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 8; i++) {
                const sx = photoX + 30 + Math.sin(i * 1.7) * (photoW - 60) * 0.5 + (photoW - 60) * 0.5;
                const sy = photoY + 50 + Math.cos(i * 2.3) * (photoH - 100) * 0.5 + (photoH - 100) * 0.5;
                drawSparkle(sx, sy, 4 + (i % 3) * 2);
            }

            // Hearts
            ctx.fillStyle = '#ff6b9d';
            drawHeart(ctx, photoX + photoW - 40, photoY + 60, 12);
            drawHeart(ctx, photoX + 35, photoY + photoH - 70, 10);

            // "FUN WORLD" banner at top
            ctx.fillStyle = 'rgba(255, 107, 157, 0.8)';
            ctx.fillRect(photoX + 20, photoY + 10, photoW - 40, 25);
            ctx.fillStyle = '#fff';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('FUN WORLD!', photoX + photoW / 2, photoY + 27);
        }

        function drawStar(cx, cy, radius, points) {
            ctx.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const r = i % 2 === 0 ? radius : radius * 0.4;
                const angle = (i * Math.PI) / points - Math.PI / 2;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
        }

        function drawSparkle(x, y, size) {
            ctx.fillRect(x - size / 2, y - 1, size, 2);
            ctx.fillRect(x - 1, y - size / 2, 2, size);
        }

        function drawHeart(context, x, y, size) {
            context.beginPath();
            context.moveTo(x, y + size / 4);
            context.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + size / 4);
            context.bezierCurveTo(x - size / 2, y + size / 2, x, y + size * 0.75, x, y + size);
            context.bezierCurveTo(x, y + size * 0.75, x + size / 2, y + size / 2, x + size / 2, y + size / 4);
            context.bezierCurveTo(x + size / 2, y, x, y, x, y + size / 4);
            context.fill();
        }

        function drawFedePose(x, y, pose, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale * 4, scale * 4);

            const p = 1;

            // Body (burgundy jacket)
            ctx.fillStyle = '#722f37';
            ctx.fillRect(-5*p, 4*p, 10*p, 12*p);

            // White shirt
            ctx.fillStyle = '#fff';
            ctx.fillRect(-3*p, 6*p, 6*p, 8*p);

            // Head
            ctx.fillStyle = '#e8c4a0';
            ctx.fillRect(-4*p, -6*p, 8*p, 9*p);

            // Hair
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(-4*p, -8*p, 8*p, 4*p);
            ctx.fillRect(-5*p, -6*p, 2*p, 4*p);
            ctx.fillRect(3*p, -6*p, 2*p, 4*p);

            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(-3*p, -2*p, 2*p, p);
            ctx.fillRect(1*p, -2*p, 2*p, p);

            // Mouth
            ctx.fillRect(-2*p, 1*p, 4*p, p);

            // Arms
            ctx.fillStyle = '#722f37';
            ctx.fillRect(5*p, 6*p, 3*p, 6*p);
            ctx.fillRect(-8*p, 6*p, 3*p, 6*p);

            // Legs
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(-4*p, 16*p, 3*p, 6*p);
            ctx.fillRect(1*p, 16*p, 3*p, 6*p);

            ctx.restore();
        }

        function drawBillyPose(x, y, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale * 4, scale * 4);

            const p = 1;

            // Grey t-shirt (muscular)
            ctx.fillStyle = '#555';
            ctx.fillRect(-6*p, 4*p, 12*p, 14*p);
            // Shirt wrinkles
            ctx.fillStyle = '#444';
            ctx.fillRect(-4*p, 6*p, 2*p, 8*p);
            ctx.fillRect(2*p, 6*p, 2*p, 8*p);
            // Broader shoulders
            ctx.fillRect(-8*p, 4*p, 3*p, 5*p);
            ctx.fillRect(5*p, 4*p, 3*p, 5*p);

            // Muscular arms (skin)
            ctx.fillStyle = '#e8c4a0';
            ctx.fillRect(-9*p, 6*p, 3*p, 6*p);
            ctx.fillRect(6*p, 6*p, 3*p, 6*p);

            // Head (broader)
            ctx.fillRect(-5*p, -6*p, 10*p, 11*p);

            // Black messy hair
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(-5*p, -9*p, 10*p, 5*p);
            ctx.fillRect(-6*p, -7*p, 2*p, 4*p);
            ctx.fillRect(4*p, -7*p, 2*p, 4*p);
            // Messy tuft
            ctx.fillRect(-3*p, -10*p, 3*p, 2*p);

            // Happy eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(-3*p, -2*p, 2*p, p);
            ctx.fillRect(1*p, -2*p, 2*p, p);

            // Big smile
            ctx.fillRect(-2*p, 2*p, 4*p, p);
            ctx.fillRect(-1*p, 3*p, 2*p, p);

            // Flexing pose (arms up)
            ctx.fillStyle = '#e8c4a0';
            ctx.fillRect(-11*p, 0*p, 4*p, 5*p);
            ctx.fillRect(7*p, 0*p, 4*p, 5*p);

            // Jeans
            ctx.fillStyle = '#3d5a80';
            ctx.fillRect(-4*p, 18*p, 3*p, 6*p);
            ctx.fillRect(1*p, 18*p, 3*p, 6*p);

            ctx.restore();
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>

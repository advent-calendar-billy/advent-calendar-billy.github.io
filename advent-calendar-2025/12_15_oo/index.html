<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Pixel Casino</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a0a2e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            border: 4px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .money-display {
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0a2e 100%);
            border: 3px solid #ffd700;
            border-radius: 8px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 0 #aa8800, inset 0 2px 0 rgba(255,255,255,0.1);
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #ffc107, #ff9800);
            border-radius: 50%;
            border: 2px solid #b8860b;
            box-shadow: inset -2px -2px 0 rgba(0,0,0,0.3), inset 2px 2px 0 rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #8b4513;
            font-weight: bold;
            animation: spin-coin 2s linear infinite;
        }

        @keyframes spin-coin {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }

        .money-amount {
            color: #7cfc00;
            font-size: 14px;
            text-shadow: 2px 2px 0 #000;
        }

        .goal-display {
            background: linear-gradient(180deg, #4a1a6e 0%, #2d1b4e 100%);
            border: 3px solid #ff69b4;
            border-radius: 8px;
            padding: 8px 16px;
            color: #ff69b4;
            font-size: 10px;
            text-shadow: 2px 2px 0 #000;
            box-shadow: 0 4px 0 #aa4477, inset 0 2px 0 rgba(255,255,255,0.1);
        }

        #interactHint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 8px 16px;
            color: #fff;
            font-size: 10px;
            display: none;
            animation: bounce 0.5s ease infinite alternate;
            z-index: 10;
        }

        @keyframes bounce {
            from { transform: translateX(-50%) translateY(0); }
            to { transform: translateX(-50%) translateY(-5px); }
        }

        #minigameOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .minigame-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .minigame-container.active {
            display: flex;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4444;
            border: 3px solid #aa0000;
            border-radius: 8px;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #880000;
            transition: transform 0.1s;
        }

        .close-btn:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #880000;
        }

        /* ========== SLOT MACHINE STYLES ========== */
        .slot-machine-wrapper {
            display: flex;
            align-items: stretch;
            gap: 0;
        }

        .slot-machine {
            background: linear-gradient(180deg, #2c1810 0%, #1a0f0a 50%, #2c1810 100%);
            border: 8px solid #8b4513;
            border-right: none;
            border-radius: 20px 0 0 20px;
            padding: 20px 25px 20px 20px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .slot-machine::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 3px solid #ffd700;
            border-radius: 12px;
            pointer-events: none;
        }

        .slot-top-display {
            background: linear-gradient(180deg, #000 0%, #1a1a2e 100%);
            border: 4px solid #ffd700;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .slot-title {
            color: #ffd700;
            font-size: 18px;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff6600;
            animation: glow-text 2s ease-in-out infinite alternate;
        }

        @keyframes glow-text {
            from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff6600; }
            to { text-shadow: 0 0 20px #ffd700, 0 0 40px #ff6600, 0 0 60px #ff3300; }
        }

        .slot-subtitle {
            color: #00ffff;
            font-size: 8px;
            margin-top: 5px;
        }

        .bonus-indicator {
            background: linear-gradient(180deg, #4a0080 0%, #2a0050 100%);
            border: 3px solid #ff00ff;
            border-radius: 8px;
            padding: 8px 15px;
            margin-bottom: 15px;
            display: none;
            animation: bonus-pulse 0.5s ease infinite alternate;
        }

        .bonus-indicator.active {
            display: block;
        }

        @keyframes bonus-pulse {
            from { transform: scale(1); box-shadow: 0 0 10px #ff00ff; }
            to { transform: scale(1.02); box-shadow: 0 0 30px #ff00ff, 0 0 50px #ff00ff; }
        }

        /* MEGA BONUS flashing lights */
        .mega-bonus-active {
            animation: mega-flash 0.2s ease infinite alternate;
        }

        @keyframes mega-flash {
            0% {
                box-shadow: 0 0 50px #ff0000, inset 0 0 30px rgba(255, 0, 0, 0.3);
                border-color: #ff0000;
            }
            25% {
                box-shadow: 0 0 50px #ffff00, inset 0 0 30px rgba(255, 255, 0, 0.3);
                border-color: #ffff00;
            }
            50% {
                box-shadow: 0 0 50px #00ff00, inset 0 0 30px rgba(0, 255, 0, 0.3);
                border-color: #00ff00;
            }
            75% {
                box-shadow: 0 0 50px #00ffff, inset 0 0 30px rgba(0, 255, 255, 0.3);
                border-color: #00ffff;
            }
            100% {
                box-shadow: 0 0 50px #ff00ff, inset 0 0 30px rgba(255, 0, 255, 0.3);
                border-color: #ff00ff;
            }
        }

        .mega-bonus-indicator {
            background: linear-gradient(180deg, #ffd700 0%, #ff6600 50%, #ff0000 100%);
            border: 4px solid #fff;
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 15px;
            text-align: center;
            animation: mega-pulse 0.3s ease infinite alternate, mega-shake 0.1s ease infinite;
        }

        @keyframes mega-pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        @keyframes mega-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .mega-bonus-text {
            color: #fff;
            font-size: 16px;
            text-shadow: 2px 2px 0 #000, 0 0 20px #fff;
            animation: rainbow-text 0.5s linear infinite;
        }

        @keyframes rainbow-text {
            0% { color: #ff0000; }
            17% { color: #ff7f00; }
            33% { color: #ffff00; }
            50% { color: #00ff00; }
            67% { color: #0000ff; }
            83% { color: #8b00ff; }
            100% { color: #ff0000; }
        }

        .bonus-text {
            color: #fff;
            font-size: 12px;
            text-align: center;
        }

        .bonus-spins {
            color: #ffff00;
            font-size: 16px;
        }

        .reels-frame {
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 50%, #1a1a1a 100%);
            border: 6px solid #333;
            border-radius: 15px;
            padding: 10px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 0 20px rgba(255,215,0,0.2);
            position: relative;
        }

        .reels-container {
            display: flex;
            gap: 8px;
            background: linear-gradient(180deg, #000 0%, #111 50%, #000 100%);
            padding: 15px;
            border-radius: 10px;
            position: relative;
        }

        .reel {
            width: 90px;
            height: 210px;
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.5) 100%);
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .reel-strip {
            display: flex;
            flex-direction: column;
            transition: transform 0.1s linear;
        }

        .reel-symbol {
            width: 86px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #2a2a3a 0%, #1a1a2a 50%, #2a2a3a 100%);
            border-bottom: 1px solid #333;
        }

        .reel-symbol svg {
            width: 55px;
            height: 55px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .reel-symbol.winner {
            animation: symbol-win 0.3s ease infinite alternate;
            background: linear-gradient(180deg, #4a3a1a 0%, #3a2a0a 50%, #4a3a1a 100%);
        }

        @keyframes symbol-win {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .win-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 70px;
            top: 70px;
            border: 3px solid #ffd700;
            border-left: none;
            border-right: none;
            pointer-events: none;
            box-shadow: 0 0 10px #ffd700;
        }

        .slot-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lines-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .lines-label {
            color: #ffd700;
            font-size: 8px;
        }

        .lines-btns {
            display: flex;
            gap: 4px;
        }

        .line-btn {
            width: 28px;
            height: 28px;
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border: 2px solid #555;
            border-radius: 5px;
            color: #888;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .line-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        .line-btn.active {
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border-color: #ffec80;
            color: #000;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .line-btn.zombie-line.active {
            background: linear-gradient(180deg, #7cfc00 0%, #558b2f 100%);
            border-color: #9cff40;
            color: #000;
            box-shadow: 0 0 10px rgba(124, 252, 0, 0.5);
        }

        .total-bet-display {
            background: #000;
            border: 3px solid #ff6600;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 100px;
            text-align: center;
        }

        .bet-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Payline indicators on reels */
        .payline-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .payline-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .payline-marker.active {
            opacity: 1;
            animation: payline-pulse 0.5s ease infinite alternate;
        }

        .payline-line {
            position: absolute;
            height: 4px;
            transform-origin: left center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .payline-line.active {
            opacity: 0.8;
            animation: payline-glow 0.5s ease infinite alternate;
        }

        @keyframes payline-pulse {
            from { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 5px currentColor; }
            to { transform: translate(-50%, -50%) scale(1.3); box-shadow: 0 0 15px currentColor; }
        }

        @keyframes payline-glow {
            from { box-shadow: 0 0 5px currentColor; }
            to { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
        }

        .winning-symbol {
            animation: symbol-flash 0.3s ease infinite alternate;
        }

        @keyframes symbol-flash {
            from { filter: brightness(1) drop-shadow(0 0 5px currentColor); }
            to { filter: brightness(1.5) drop-shadow(0 0 15px currentColor); }
        }

        /* Special/Scatter symbol glow effect */
        .reel-symbol.special-symbol svg {
            animation: special-glow 1s ease-in-out infinite alternate;
        }

        @keyframes special-glow {
            from {
                filter: drop-shadow(0 0 8px #ffd700) drop-shadow(0 0 15px #ff6600);
            }
            to {
                filter: drop-shadow(0 0 15px #ffd700) drop-shadow(0 0 30px #ff6600) drop-shadow(0 0 45px #ff3300);
            }
        }

        .reel-symbol.special-symbol.zombie-special svg {
            animation: zombie-special-glow 1s ease-in-out infinite alternate;
        }

        @keyframes zombie-special-glow {
            from {
                filter: drop-shadow(0 0 8px #ff69b4) drop-shadow(0 0 15px #ff1493);
            }
            to {
                filter: drop-shadow(0 0 15px #ff69b4) drop-shadow(0 0 30px #ff1493) drop-shadow(0 0 45px #ff00ff);
            }
        }

        /* Floating money display - always visible */
        #floatingMoney {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #1a0a2e 0%, #0d0518 100%);
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 10px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.1);
            animation: float-pulse 2s ease-in-out infinite;
        }

        @keyframes float-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), inset 0 0 25px rgba(255, 215, 0, 0.2); }
        }

        .floating-coin {
            width: 32px;
            height: 32px;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #ffc107, #ff9800);
            border-radius: 50%;
            border: 3px solid #b8860b;
            box-shadow: inset -3px -3px 0 rgba(0,0,0,0.3), inset 3px 3px 0 rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #8b4513;
            font-weight: bold;
            font-family: 'Press Start 2P', monospace;
            animation: spin-coin 2s linear infinite;
        }

        .floating-amount {
            color: #7cfc00;
            font-size: 18px;
            font-family: 'Press Start 2P', monospace;
            text-shadow: 2px 2px 0 #000, 0 0 10px #7cfc00;
        }

        .floating-debt {
            color: #aaaaaa;
            font-size: 14px;
            font-family: 'Press Start 2P', monospace;
            text-shadow: 2px 2px 0 #000;
            display: block;
        }

        .floating-debt.active {
            color: #ff4444;
            animation: debt-pulse 0.5s ease infinite alternate;
        }

        @keyframes debt-pulse {
            from { text-shadow: 2px 2px 0 #000; }
            to { text-shadow: 2px 2px 0 #000, 0 0 10px #ff0000; }
        }

        /* Death Screen */
        #deathScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #deathScreen.active {
            display: flex;
        }

        .death-content {
            text-align: center;
            color: #ff0000;
        }

        .death-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 48px;
            margin-bottom: 30px;
            animation: death-flash 0.5s ease infinite alternate;
        }

        @keyframes death-flash {
            from { color: #ff0000; text-shadow: 0 0 20px #ff0000; }
            to { color: #880000; text-shadow: 0 0 10px #880000; }
        }

        .death-message {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .death-subtitle {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: #888888;
            margin-bottom: 40px;
        }

        .death-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 15px 30px;
            background: #ff0000;
            color: #ffffff;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .death-btn:hover {
            background: #ff4444;
            transform: scale(1.1);
        }

        /* Win Screen */
        #winScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 50, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #winScreen.active {
            display: flex;
        }

        .win-content {
            text-align: center;
            color: #00ff00;
        }

        .win-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 48px;
            margin-bottom: 30px;
            animation: win-flash 0.5s ease infinite alternate;
        }

        @keyframes win-flash {
            from { color: #00ff00; text-shadow: 0 0 20px #00ff00; }
            to { color: #ffd700; text-shadow: 0 0 20px #ffd700; }
        }

        .win-speech {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }

        .win-speech .speaker {
            color: #ffd700;
            margin-bottom: 5px;
        }

        .win-speech .text {
            color: #ffffff;
        }

        .win-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 15px 30px;
            background: #00aa00;
            color: #ffffff;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 30px;
        }

        .win-btn:hover {
            background: #00cc00;
            transform: scale(1.1);
        }

        /* Shark dialog styles */
        #sharkDialog {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #1a3a5a 0%, #0a1a2a 100%);
            border: 4px solid #4a6fa5;
            border-radius: 15px;
            padding: 20px;
            max-width: 500px;
            z-index: 200;
            display: none;
            box-shadow: 0 0 30px rgba(74, 111, 165, 0.5);
        }

        #sharkDialog.active {
            display: block;
            animation: dialog-appear 0.3s ease;
        }

        @keyframes dialog-appear {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .shark-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a6fa5;
        }

        .shark-portrait {
            width: 60px;
            height: 60px;
            background: linear-gradient(180deg, #3a5a8a 0%, #2a4a7a 100%);
            border-radius: 50%;
            border: 3px solid #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .shark-name {
            color: #ffd700;
            font-size: 14px;
            text-shadow: 2px 2px 0 #000;
        }

        .shark-title {
            color: #888;
            font-size: 8px;
            margin-top: 5px;
        }

        .shark-text {
            color: #fff;
            font-size: 11px;
            line-height: 1.8;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .shark-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .shark-btn {
            background: linear-gradient(180deg, #4a6fa5 0%, #3a5a8a 100%);
            border: 3px solid #6a8fc5;
            border-radius: 8px;
            padding: 10px 15px;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shark-btn:hover {
            background: linear-gradient(180deg, #5a8fc5 0%, #4a7fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #2a4a6a;
        }

        .shark-btn.gold {
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border-color: #ffec80;
            color: #000;
        }

        .shark-btn.gold:hover {
            background: linear-gradient(180deg, #ffec80 0%, #daa520 100%);
        }

        .shark-btn.red {
            background: linear-gradient(180deg, #c62828 0%, #8b0000 100%);
            border-color: #ef5350;
        }

        .shark-btn.red:hover {
            background: linear-gradient(180deg, #ef5350 0%, #c62828 100%);
        }

        .loan-options {
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .loan-options.active {
            display: flex;
        }

        .loan-amount-btn {
            width: 100%;
        }

        /* Companion comment bubble */
        #companionBubble {
            position: absolute;
            background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
            border: 3px solid #333;
            border-radius: 15px;
            padding: 8px 12px;
            font-size: 10px;
            font-family: 'Press Start 2P', monospace;
            color: #333;
            max-width: 200px;
            z-index: 50;
            display: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        #companionBubble.active {
            display: block;
            animation: bubble-pop 0.3s ease;
        }

        #companionBubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 12px solid #333;
        }

        #companionBubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #fff;
        }

        /* Fede speech bubble */
        #fedeBubble {
            position: absolute;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border: 3px solid #1976d2;
            border-radius: 12px;
            padding: 8px 12px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: #1a1a1a;
            display: none;
            z-index: 100;
            max-width: 180px;
            text-align: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        #fedeBubble.active {
            display: block;
            animation: bubble-pop 0.3s ease;
        }

        #fedeBubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 12px solid #1976d2;
        }

        #fedeBubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #bbdefb;
        }

        @keyframes bubble-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* NPC Dialog */
        #npcDialog {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2a 100%);
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            min-width: 300px;
            z-index: 150;
            display: none;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        #npcDialog.active {
            display: block;
        }

        .npc-dialog-text {
            color: #fff;
            font-size: 11px;
            line-height: 1.8;
            margin-bottom: 15px;
            text-align: center;
        }

        .npc-dialog-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .npc-dialog-btn {
            background: linear-gradient(180deg, #4a4a6a 0%, #2a2a4a 100%);
            border: 2px solid #6a6a8a;
            border-radius: 8px;
            padding: 8px 15px;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 9px;
            cursor: pointer;
        }

        .npc-dialog-btn:hover {
            background: linear-gradient(180deg, #6a6a8a 0%, #4a4a6a 100%);
        }

        .npc-dialog-btn.gold {
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border-color: #ffec80;
            color: #000;
        }

        /* Room name display */
        #roomName {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 10px 20px;
            color: #ffd700;
            font-size: 12px;
            font-family: 'Press Start 2P', monospace;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        #roomName.show {
            opacity: 1;
        }

        /* Room transition overlay */
        #roomTransition {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #roomTransition.active {
            opacity: 1;
            pointer-events: auto;
        }

        .bet-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border: 3px solid #8b6914;
            border-radius: 50%;
            color: #000;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 3px 0 #5d4e37;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bet-btn:hover {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #5d4e37;
        }

        .bet-display {
            background: #000;
            border: 3px solid #ffd700;
            border-radius: 8px;
            padding: 8px 15px;
            min-width: 120px;
            text-align: center;
        }

        .bet-label {
            color: #888;
            font-size: 8px;
        }

        .bet-amount {
            color: #7cfc00;
            font-size: 14px;
        }

        .spin-btn {
            background: linear-gradient(180deg, #ff0000 0%, #cc0000 50%, #990000 100%);
            border: 4px solid #ffd700;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            color: #ffd700;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 6px 0 #660000, 0 0 20px rgba(255,0,0,0.5);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spin-btn:hover:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #660000, 0 0 30px rgba(255,0,0,0.7);
        }

        .spin-btn:disabled {
            background: linear-gradient(180deg, #666 0%, #444 50%, #333 100%);
            box-shadow: 0 6px 0 #222;
            cursor: not-allowed;
        }

        /* Lever Section */
        .lever-section {
            background: linear-gradient(180deg, #4a3020 0%, #2a1810 100%);
            border: 8px solid #8b4513;
            border-left: 4px solid #6b3510;
            border-radius: 0 20px 20px 0;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.3);
        }

        .lever-track {
            width: 20px;
            height: 200px;
            background: linear-gradient(90deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
            border-radius: 10px;
            position: relative;
            border: 2px solid #555;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .lever-handle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #ff4444, #cc0000, #880000);
            border: 4px solid #ffd700;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 -5px 10px rgba(0,0,0,0.3);
            transition: top 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            top: 0;
            z-index: 5;
        }

        .lever-handle:active {
            cursor: grabbing;
        }

        .lever-handle.pulled {
            top: 150px;
        }

        .lever-handle::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
            border-radius: 50%;
        }

        .lever-rod {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            background: linear-gradient(90deg, #666 0%, #999 50%, #666 100%);
            border-radius: 4px;
            top: 25px;
            height: 25px;
            transition: height 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .lever-rod.extended {
            height: 175px;
        }

        .lever-label {
            color: #ffd700;
            font-size: 8px;
            margin-top: 15px;
            text-align: center;
            text-shadow: 1px 1px 0 #000;
        }

        /* Win Display */
        .win-display {
            background: linear-gradient(180deg, #000 0%, #1a0a2e 100%);
            border: 4px solid #ffd700;
            border-radius: 10px;
            padding: 10px 20px;
            margin-top: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .win-text {
            color: #ffd700;
            font-size: 14px;
            text-align: center;
            text-shadow: 0 0 10px #ffd700;
        }

        .win-text.big-win {
            animation: big-win 0.2s ease infinite alternate;
            font-size: 18px;
        }

        @keyframes big-win {
            from { transform: scale(1); color: #ffd700; }
            to { transform: scale(1.1); color: #ff6600; }
        }

        /* Paytable */
        .paytable-btn {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border: 2px solid #ffd700;
            border-radius: 5px;
            color: #ffd700;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* ========== ZOMBIE THEME STYLES ========== */
        .slot-machine.zombie-theme {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%);
            border-color: #4a0080;
        }

        .slot-machine.zombie-theme::before {
            border-color: #7c4dff;
        }

        .zombie-display {
            background: linear-gradient(180deg, #1a0030 0%, #0d001a 100%);
            border-color: #7c4dff;
        }

        .zombie-title {
            color: #7cfc00;
            text-shadow: 0 0 10px #7cfc00, 0 0 20px #00ff00;
            animation: zombie-glow 2s ease-in-out infinite alternate;
        }

        @keyframes zombie-glow {
            from { text-shadow: 0 0 10px #7cfc00, 0 0 20px #00ff00; }
            to { text-shadow: 0 0 20px #7cfc00, 0 0 40px #00ff00, 0 0 60px #004400; }
        }

        .zombie-frame {
            background: linear-gradient(180deg, #0d0d0d 0%, #000 50%, #0d0d0d 100%);
            border-color: #4a0080;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 0 20px rgba(124,77,255,0.3);
        }

        .zombie-spin {
            background: linear-gradient(180deg, #7c4dff 0%, #5e35b1 50%, #4527a0 100%);
            border-color: #7cfc00;
            box-shadow: 0 6px 0 #311b92, 0 0 20px rgba(124,77,255,0.5);
        }

        /* ========== LUCKY 7 FREE SPINS THEME STYLES ========== */
        .slot-machine.lucky7-theme {
            background: linear-gradient(180deg, #3d0a0a 0%, #1a0505 50%, #3d0a0a 100%);
            border-color: #ffd700;
        }

        .slot-machine.lucky7-theme::before {
            border-color: #ff6600;
        }

        .lucky7-display {
            background: linear-gradient(180deg, #3d0a0a 0%, #1a0505 100%);
            border-color: #ffd700;
        }

        .lucky7-title {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff6600;
            animation: lucky7-glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes lucky7-glow {
            from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff6600; }
            to { text-shadow: 0 0 20px #ffd700, 0 0 40px #ff6600, 0 0 60px #ff0000; }
        }

        .lucky7-frame {
            background: linear-gradient(180deg, #1a0505 0%, #000 50%, #1a0505 100%);
            border-color: #ffd700;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 0 20px rgba(255,215,0,0.3);
        }

        .lucky7-spin {
            background: linear-gradient(180deg, #ffd700 0%, #daa520 50%, #b8860b 100%);
            border-color: #ff6600;
            color: #000;
            box-shadow: 0 6px 0 #8b6914, 0 0 20px rgba(255,215,0,0.5);
        }

        .lucky7-spin:hover {
            background: linear-gradient(180deg, #ffec8b 0%, #ffd700 50%, #daa520 100%);
        }

        .lucky7-line {
            background: linear-gradient(180deg, #b8860b 0%, #8b6914 100%);
            border-color: #ffd700;
        }

        .lucky7-line:hover, .lucky7-line.active {
            background: linear-gradient(180deg, #daa520 0%, #b8860b 100%);
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .lucky7-lever-section {
            background: linear-gradient(90deg, #3d0a0a 0%, #1a0505 100%);
            border-color: #ffd700;
        }

        .lucky7-lever {
            background: linear-gradient(180deg, #ffd700 0%, #daa520 50%, #b8860b 100%);
        }

        .auto-spin-indicator {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #006400 0%, #004d00 100%);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 8px 20px;
            text-align: center;
            z-index: 100;
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 15px;
        }

        .auto-spin-indicator.active {
            display: flex;
            animation: pulse-glow 1s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px #ffd700; }
            50% { box-shadow: 0 0 20px #ffd700, 0 0 30px #00ff00; }
        }

        .lucky7-multiplier {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .auto-spin-count {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: #00ff00;
        }

        .sticky-clover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .frozen-clover {
            position: absolute;
            width: 88px;
            height: 68px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 40, 0, 0.92);
            box-shadow: inset 0 0 15px #00ff00;
            animation: clover-glow 0.5s ease-in-out infinite alternate;
        }

        .frozen-clover svg {
            width: 50px;
            height: 50px;
            filter: drop-shadow(0 0 6px #00ff00);
        }

        @keyframes clover-glow {
            from { box-shadow: 0 0 15px #00ff00, 0 0 30px #32cd32; }
            to { box-shadow: 0 0 25px #00ff00, 0 0 50px #32cd32; }
        }

        /* ========== PONG GAME STYLES ========== */
        .pong-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .pong-canvas {
            border: 4px solid #00ff00;
            background: #000;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }

        .pong-score {
            font-family: 'Press Start 2P', monospace;
            font-size: 24px;
            color: #00ff00;
            display: flex;
            gap: 100px;
        }

        .pong-score span {
            min-width: 50px;
            text-align: center;
        }

        .pong-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 32px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .pong-instructions {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: #888;
        }

        .pong-message {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            color: #ffff00;
            min-height: 24px;
        }

        .zombie-spin:hover:not(:disabled) {
            box-shadow: 0 3px 0 #311b92, 0 0 30px rgba(124,77,255,0.7);
        }

        .zombie-lever-section {
            background: linear-gradient(180deg, #2a1a3a 0%, #1a0d2a 100%);
            border-color: #4a0080;
        }

        .zombie-lever {
            background: radial-gradient(circle at 30% 30%, #7cfc00, #558b2f, #33691e);
            border-color: #7c4dff;
        }

        /* ========== ROULETTE STYLES ========== */
        .roulette-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .roulette-wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
        }

        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #ffd700;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            z-index: 10;
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-radius: 50%;
            border: 3px solid #8b4513;
            z-index: 5;
        }

        .roulette-board {
            display: grid;
            grid-template-columns: 50px repeat(12, 36px);
            grid-template-rows: repeat(3, 36px) 32px;
            gap: 0;
            background: #0a5c0a;
            padding: 10px;
            border: 4px solid #8b4513;
            border-radius: 8px;
            position: relative;
        }

        .board-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border: 2px solid #1a3d1a;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            text-shadow: 1px 1px 2px #000;
        }

        .board-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255,215,0,0.7);
            z-index: 5;
            border-color: #ffd700;
        }

        .board-cell .chip-stack {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .chip {
            width: 20px;
            height: 6px;
            border-radius: 50%;
            margin-top: -4px;
            border: 1px solid rgba(0,0,0,0.3);
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .chip:first-child {
            margin-top: 0;
        }

        .chip.red { background: linear-gradient(180deg, #e53935 0%, #c62828 100%); }
        .chip.blue { background: linear-gradient(180deg, #1e88e5 0%, #1565c0 100%); }
        .chip.green { background: linear-gradient(180deg, #43a047 0%, #2e7d32 100%); }
        .chip.black { background: linear-gradient(180deg, #424242 0%, #212121 100%); }
        .chip.gold { background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%); }

        .chip-amount {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #ffd700;
            font-size: 6px;
            padding: 1px 3px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .cell-red { background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); }
        .cell-black { background: linear-gradient(135deg, #424242 0%, #1a1a1a 100%); }
        .cell-green {
            background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%);
            grid-row: span 3;
            font-size: 18px;
        }
        .cell-bet {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            font-size: 9px;
        }
        .cell-bet.red-bet {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        }
        .cell-bet.black-bet {
            background: linear-gradient(135deg, #424242 0%, #1a1a1a 100%);
        }
        .cell-bet:hover {
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
        }

        /* Split bet spots - edges between numbers */
        .split-h {
            position: absolute;
            width: 16px;
            height: 8px;
            background: transparent;
            cursor: pointer;
            z-index: 15;
            border-radius: 4px;
        }
        .split-h:hover {
            background: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 8px #ffd700;
        }
        .split-v {
            position: absolute;
            width: 8px;
            height: 16px;
            background: transparent;
            cursor: pointer;
            z-index: 15;
            border-radius: 4px;
        }
        .split-v:hover {
            background: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 8px #ffd700;
        }
        /* Corner bet spots */
        .corner-bet {
            position: absolute;
            width: 12px;
            height: 12px;
            background: transparent;
            cursor: pointer;
            z-index: 20;
            border-radius: 50%;
        }
        .corner-bet:hover {
            background: rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 10px #ffd700;
        }

        .roulette-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .roulette-btn {
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border: 3px solid #8b4513;
            border-radius: 8px;
            color: #000;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #5d4e37;
        }

        .roulette-btn:hover:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #5d4e37;
        }

        .roulette-btn:disabled {
            background: #666;
            border-color: #444;
            cursor: not-allowed;
        }

        .roulette-result {
            font-size: 16px;
            color: #ffd700;
            text-shadow: 2px 2px 0 #000;
            min-height: 25px;
        }

        /* ========== BLACKJACK STYLES ========== */
        .blackjack-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .cards-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
        }

        .hand {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .hand-label {
            color: #ffd700;
            font-size: 12px;
            text-shadow: 2px 2px 0 #000;
        }

        .cards {
            display: flex;
        }

        .card {
            width: 60px;
            height: 84px;
            background: linear-gradient(180deg, #fff 0%, #eee 100%);
            border: 3px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: -15px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .card:first-child { margin-left: 0; }
        .card.face-down {
            background: repeating-linear-gradient(45deg, #1a237e, #1a237e 5px, #283593 5px, #283593 10px);
        }
        .card-suit { font-size: 14px; }
        .card.red { color: #c62828; }
        .card.black { color: #212121; }

        .hand-value {
            background: #000;
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 5px 15px;
            color: #7cfc00;
            font-size: 14px;
        }

        .blackjack-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .bj-btn {
            background: linear-gradient(180deg, #4caf50 0%, #2e7d32 100%);
            border: 3px solid #1b5e20;
            border-radius: 8px;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 12px 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #0d3810;
        }

        .bj-btn:disabled {
            background: #666;
            border-color: #444;
            cursor: not-allowed;
        }

        .bj-btn.danger {
            background: linear-gradient(180deg, #f44336 0%, #c62828 100%);
            border-color: #b71c1c;
            box-shadow: 0 4px 0 #7f0000;
        }

        .blackjack-message {
            font-size: 16px;
            color: #ffd700;
            text-shadow: 2px 2px 0 #000;
            min-height: 25px;
        }

        /* Win Screen */
        #winScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .win-title {
            font-size: 28px;
            color: #ffd700;
            text-shadow: 4px 4px 0 #000;
            animation: rainbow 2s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes rainbow {
            0% { color: #ff0000; }
            17% { color: #ff8800; }
            33% { color: #ffff00; }
            50% { color: #00ff00; }
            67% { color: #0088ff; }
            83% { color: #8800ff; }
            100% { color: #ff0000; }
        }

        .win-amount {
            font-size: 40px;
            color: #7cfc00;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 40px;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall 3s linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .play-again-btn {
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
            border: 4px solid #8b4513;
            border-radius: 12px;
            color: #000;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            padding: 20px 40px;
            cursor: pointer;
            box-shadow: 0 8px 0 #5d4e37;
        }
    </style>
</head>
<body>
    <!-- Floating money display - always visible -->
    <div id="floatingMoney">
        <div class="floating-coin">$</div>
        <span class="floating-amount" id="floatingAmount">$10,000</span>
        <span class="floating-debt" id="floatingDebt">DEBT: $0</span>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="hud" style="display: none;">
            <div class="money-display">
                <div class="coin-icon">$</div>
                <span class="money-amount" id="moneyDisplay">$10,000</span>
            </div>
            <div class="goal-display">GOAL: $1,000,000</div>
            <div class="debt-display" id="debtHud" style="display: none;">
                <span class="debt-label">DEBT:</span>
                <span class="debt-amount" id="debtDisplay">$0</span>
            </div>
        </div>

        <div id="interactHint">SPACE to play!</div>

        <!-- Room transition overlay -->
        <div id="roomTransition"></div>

        <!-- Room name display -->
        <div id="roomName">Lucky Pixel Casino</div>

        <!-- Companion speech bubble -->
        <div id="companionBubble"></div>
        <!-- Fede speech bubble -->
        <div id="fedeBubble"></div>

        <!-- NPC Dialog -->
        <div id="npcDialog">
            <div class="npc-dialog-text" id="npcDialogText">Hello!</div>
            <div class="npc-dialog-buttons" id="npcDialogButtons">
                <button class="npc-dialog-btn" onclick="closeNPCDialog()">OK</button>
            </div>
        </div>

        <!-- Drink Menu -->
        <div id="drinkMenu" style="display: none;">
            <div class="npc-dialog-text">What'll it be?</div>
            <div class="npc-dialog-buttons">
                <button class="npc-dialog-btn gold" onclick="buyDrink('martini')">Martini $20</button>
                <button class="npc-dialog-btn gold" onclick="buyDrink('whiskey')">Whiskey $20</button>
                <button class="npc-dialog-btn gold" onclick="buyDrink('sake')">Sake $20</button>
                <button class="npc-dialog-btn" onclick="closeNPCDialog()">No thanks</button>
            </div>
        </div>

        <!-- Death Screen -->
        <div id="deathScreen">
            <div class="death-content">
                <div class="death-title">GAME OVER</div>
                <div class="death-message">The shark collected his debt...</div>
                <div class="death-subtitle">You should have paid what you owed.</div>
                <button class="death-btn" onclick="location.reload()">TRY AGAIN</button>
            </div>
        </div>

        <!-- Win Screen -->
        <div id="winScreen">
            <div class="win-content">
                <div class="win-title">YOU WIN!</div>
                <div class="win-speech">
                    <div class="speaker">Billy:</div>
                    <div class="text">"Somos ricos!"</div>
                </div>
                <div class="win-speech">
                    <div class="speaker">Fede:</div>
                    <div class="text">"Bueno, un millon no es tanto... nos quedamos un rato mas?"</div>
                </div>
                <button class="win-btn" onclick="location.reload()">PLAY AGAIN</button>
            </div>
        </div>

        <!-- Shark Loan Dialog -->
        <div id="sharkDialog">
            <div class="shark-header">
                <div class="shark-portrait"></div>
                <div>
                    <div class="shark-name">FINLEY</div>
                    <div class="shark-title">"Financial Advisor"</div>
                </div>
            </div>
            <div class="shark-text" id="sharkText">
                Hey there, small fry! Name's Finley.
            </div>
            <div class="shark-buttons" id="sharkChoices">
                <!-- Dynamic choices will be inserted here -->
            </div>
            <div class="loan-options" id="loanOptions">
                <button class="shark-btn gold loan-amount-btn" onclick="takeLoan(10000)">Borrow $10,000</button>
                <button class="shark-btn gold loan-amount-btn" onclick="takeLoan(50000)">Borrow $50,000</button>
                <button class="shark-btn gold loan-amount-btn" onclick="takeLoan(100000)">Borrow $100,000</button>
                <button class="shark-btn gold loan-amount-btn" onclick="takeLoan(500000)">Borrow $500,000 (YOLO)</button>
                <button class="shark-btn red" onclick="payBackDebt()" id="payBackBtn" style="display: none;">Pay Back Debt</button>
                <button class="shark-btn" onclick="closeSharkDialog()">No thanks, bye!</button>
            </div>
        </div>

        <div id="minigameOverlay">
            <button class="close-btn" onclick="closeMinigame()">ESC</button>

            <!-- Diamond Deluxe Slot Machine -->
            <div class="minigame-container" id="slotsGame">
                <div class="slot-machine-wrapper">
                    <div class="slot-machine">
                        <div class="slot-top-display">
                            <div class="slot-title">DIAMOND DELUXE</div>
                            <div class="slot-subtitle">SCATTER BONUS - 3+ GOLD BARS = FREE SPINS!</div>
                        </div>

                        <div class="bonus-indicator" id="bonusIndicator">
                            <div class="bonus-text">FREE SPINS!</div>
                            <div class="bonus-spins"><span id="freeSpinsCount">0</span> REMAINING</div>
                        </div>

                        <div class="reels-frame">
                            <div class="reels-container" id="reelsContainer">
                                <div class="reel" id="reel0"><div class="reel-strip"></div></div>
                                <div class="reel" id="reel1"><div class="reel-strip"></div></div>
                                <div class="reel" id="reel2"><div class="reel-strip"></div></div>
                                <div class="reel" id="reel3"><div class="reel-strip"></div></div>
                                <div class="reel" id="reel4"><div class="reel-strip"></div></div>
                                <canvas id="paylineCanvas" class="payline-overlay" width="490" height="210"></canvas>
                            </div>
                        </div>

                        <div class="slot-controls">
                            <div class="lines-section">
                                <div class="lines-label">LINES</div>
                                <div class="lines-btns">
                                    <button class="line-btn active" onclick="setLines(5)" data-lines="5">5</button>
                                    <button class="line-btn" onclick="setLines(10)" data-lines="10">10</button>
                                    <button class="line-btn" onclick="setLines(20)" data-lines="20">20</button>
                                    <button class="line-btn" onclick="setLines(50)" data-lines="50">50</button>
                                </div>
                            </div>
                            <div class="bet-section">
                                <button class="bet-btn" onclick="changeBet(-100)">-</button>
                                <div class="bet-display">
                                    <div class="bet-label">BET/LINE</div>
                                    <div class="bet-amount">$<span id="slotBet">100</span></div>
                                </div>
                                <button class="bet-btn" onclick="changeBet(100)">+</button>
                            </div>
                            <div class="total-bet-display">
                                <div class="bet-label">TOTAL</div>
                                <div class="bet-amount">$<span id="totalBet">500</span></div>
                            </div>
                            <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>
                        </div>

                        <div class="win-display">
                            <div class="win-text" id="slotMessage">PULL THE LEVER OR PRESS SPIN!</div>
                        </div>
                    </div>

                    <div class="lever-section">
                        <div class="lever-track">
                            <div class="lever-rod" id="leverRod"></div>
                            <div class="lever-handle" id="leverHandle"></div>
                        </div>
                        <div class="lever-label">PULL!</div>
                    </div>
                </div>
            </div>

            <!-- Zombie Fortune Slot Machine -->
            <div class="minigame-container" id="zombieSlotsGame">
                <div class="slot-machine-wrapper">
                    <div class="slot-machine zombie-theme">
                        <div class="slot-top-display zombie-display">
                            <div class="slot-title zombie-title">ZOMBIE FORTUNE</div>
                            <div class="slot-subtitle">SCATTER BONUS - 3+ BRAINS = FREE SPINS!</div>
                        </div>

                        <div class="bonus-indicator" id="zombieBonusIndicator">
                            <div class="bonus-text">FREE SPINS!</div>
                            <div class="bonus-spins"><span id="zombieFreeSpinsCount">0</span> REMAINING</div>
                        </div>

                        <div class="reels-frame zombie-frame">
                            <div class="reels-container" id="zombieReelsContainer">
                                <div class="reel" id="zombieReel0"><div class="reel-strip"></div></div>
                                <div class="reel" id="zombieReel1"><div class="reel-strip"></div></div>
                                <div class="reel" id="zombieReel2"><div class="reel-strip"></div></div>
                                <div class="reel" id="zombieReel3"><div class="reel-strip"></div></div>
                                <div class="reel" id="zombieReel4"><div class="reel-strip"></div></div>
                                <canvas id="zombiePaylineCanvas" class="payline-overlay" width="490" height="210"></canvas>
                            </div>
                        </div>

                        <div class="slot-controls">
                            <div class="lines-section">
                                <div class="lines-label">LINES</div>
                                <div class="lines-btns">
                                    <button class="line-btn zombie-line active" onclick="setZombieLines(5)" data-lines="5">5</button>
                                    <button class="line-btn zombie-line" onclick="setZombieLines(10)" data-lines="10">10</button>
                                    <button class="line-btn zombie-line" onclick="setZombieLines(20)" data-lines="20">20</button>
                                    <button class="line-btn zombie-line" onclick="setZombieLines(50)" data-lines="50">50</button>
                                </div>
                            </div>
                            <div class="bet-section">
                                <button class="bet-btn" onclick="changeZombieBet(-100)">-</button>
                                <div class="bet-display">
                                    <div class="bet-label">BET/LINE</div>
                                    <div class="bet-amount">$<span id="zombieSlotBet">100</span></div>
                                </div>
                                <button class="bet-btn" onclick="changeZombieBet(100)">+</button>
                            </div>
                            <div class="total-bet-display">
                                <div class="bet-label">TOTAL</div>
                                <div class="bet-amount">$<span id="zombieTotalBet">500</span></div>
                            </div>
                            <button class="spin-btn zombie-spin" id="zombieSpinBtn" onclick="zombieSpin()">SPIN</button>
                        </div>

                        <div class="win-display">
                            <div class="win-text" id="zombieSlotMessage">PULL THE LEVER OR PRESS SPIN!</div>
                        </div>
                    </div>

                    <div class="lever-section zombie-lever-section">
                        <div class="lever-track">
                            <div class="lever-rod" id="zombieLeverRod"></div>
                            <div class="lever-handle zombie-lever" id="zombieLeverHandle"></div>
                        </div>
                        <div class="lever-label">PULL!</div>
                    </div>
                </div>
            </div>

            <!-- Lucky 7 Free Spins Slot Machine -->
            <div class="minigame-container" id="lucky7SlotsGame">
                <div class="slot-machine-wrapper">
                    <div class="slot-machine lucky7-theme">
                        <div class="slot-top-display lucky7-display">
                            <div class="slot-title lucky7-title">LUCKY 7</div>
                            <div class="slot-subtitle">3+ SEVENS ANYWHERE = 5 FREE SPINS!</div>
                        </div>

                        <div class="auto-spin-indicator" id="lucky7AutoIndicator">
                            <div class="auto-spin-count">FREE SPINS: <span id="lucky7FreeSpinsCount">0</span></div>
                            <div class="lucky7-multiplier">x<span id="lucky7MultiplierDisplay">1</span></div>
                        </div>

                        <div class="reels-frame lucky7-frame">
                            <div class="reels-container" id="lucky7ReelsContainer">
                                <div class="reel" id="lucky7Reel0"><div class="reel-strip"></div></div>
                                <div class="reel" id="lucky7Reel1"><div class="reel-strip"></div></div>
                                <div class="reel" id="lucky7Reel2"><div class="reel-strip"></div></div>
                                <div class="reel" id="lucky7Reel3"><div class="reel-strip"></div></div>
                                <div class="reel" id="lucky7Reel4"><div class="reel-strip"></div></div>
                                <canvas id="lucky7PaylineCanvas" class="payline-overlay" width="490" height="210"></canvas>
                                <div class="sticky-clover-overlay" id="stickyCloverOverlay"></div>
                            </div>
                        </div>

                        <div class="slot-controls">
                            <div class="lines-section">
                                <div class="lines-label">LINES</div>
                                <div class="lines-btns">
                                    <button class="line-btn lucky7-line active" onclick="setLucky7Lines(5)" data-lines="5">5</button>
                                    <button class="line-btn lucky7-line" onclick="setLucky7Lines(10)" data-lines="10">10</button>
                                    <button class="line-btn lucky7-line" onclick="setLucky7Lines(20)" data-lines="20">20</button>
                                    <button class="line-btn lucky7-line" onclick="setLucky7Lines(50)" data-lines="50">50</button>
                                </div>
                            </div>
                            <div class="bet-section">
                                <button class="bet-btn" onclick="changeLucky7Bet(-100)">-</button>
                                <div class="bet-display">
                                    <div class="bet-label">BET/LINE</div>
                                    <div class="bet-amount">$<span id="lucky7SlotBet">100</span></div>
                                </div>
                                <button class="bet-btn" onclick="changeLucky7Bet(100)">+</button>
                            </div>
                            <div class="total-bet-display">
                                <div class="bet-label">TOTAL</div>
                                <div class="bet-amount">$<span id="lucky7TotalBet">500</span></div>
                            </div>
                            <button class="spin-btn lucky7-spin" id="lucky7SpinBtn" onclick="lucky7Spin()">SPIN</button>
                        </div>

                        <div class="win-display">
                            <div class="win-text" id="lucky7SlotMessage">PULL THE LEVER OR PRESS SPIN!</div>
                        </div>
                    </div>

                    <div class="lever-section lucky7-lever-section">
                        <div class="lever-track">
                            <div class="lever-rod" id="lucky7LeverRod"></div>
                            <div class="lever-handle lucky7-lever" id="lucky7LeverHandle"></div>
                        </div>
                        <div class="lever-label">PULL!</div>
                    </div>
                </div>
            </div>

            <!-- Roulette -->
            <div class="minigame-container" id="rouletteGame">
                <div class="roulette-game">
                    <div class="roulette-wheel-container">
                        <div class="wheel-pointer"></div>
                        <canvas id="rouletteWheel" width="250" height="250"></canvas>
                        <div class="wheel-center"></div>
                    </div>
                    <div class="roulette-result" id="rouletteResult"></div>
                    <div class="roulette-board" id="rouletteBoard"></div>
                    <div class="roulette-controls">
                        <button class="bet-btn" onclick="changeRouletteBet(-100)">-</button>
                        <div class="bet-display">
                            <div class="bet-label">CHIP</div>
                            <div class="bet-amount">$<span id="rouletteBet">100</span></div>
                        </div>
                        <button class="bet-btn" onclick="changeRouletteBet(100)">+</button>
                        <button class="roulette-btn" id="rouletteSpinBtn" onclick="spinRoulette()">SPIN!</button>
                        <button class="roulette-btn" onclick="clearRouletteBets()">CLEAR</button>
                    </div>
                </div>
            </div>

            <!-- Blackjack -->
            <div class="minigame-container" id="blackjackGame">
                <div class="blackjack-game">
                    <div class="cards-area">
                        <div class="hand">
                            <div class="hand-label">DEALER</div>
                            <div class="cards" id="dealerCards"></div>
                            <div class="hand-value" id="dealerValue">?</div>
                        </div>
                        <div class="hand">
                            <div class="hand-label">YOU</div>
                            <div class="cards" id="playerCards"></div>
                            <div class="hand-value" id="playerValue">0</div>
                        </div>
                    </div>
                    <div class="blackjack-message" id="bjMessage"></div>
                    <div class="blackjack-controls">
                        <button class="bet-btn" onclick="changeBjBet(-100)">-</button>
                        <div class="bet-display">
                            <div class="bet-label">BET</div>
                            <div class="bet-amount">$<span id="bjBet">100</span></div>
                        </div>
                        <button class="bet-btn" onclick="changeBjBet(100)">+</button>
                        <button class="bj-btn" id="dealBtn" onclick="dealCards()">DEAL</button>
                        <button class="bj-btn" id="hitBtn" onclick="hit()" disabled>HIT</button>
                        <button class="bj-btn danger" id="standBtn" onclick="stand()" disabled>STAND</button>
                    </div>
                </div>
            </div>

            <!-- Pong Game -->
            <div class="minigame-container" id="pongGame">
                <div class="pong-game">
                    <div class="pong-title">PONG</div>
                    <div class="pong-score">
                        <span id="pongPlayerScore">0</span>
                        <span>-</span>
                        <span id="pongCpuScore">0</span>
                    </div>
                    <canvas id="pongCanvas" class="pong-canvas" width="600" height="400"></canvas>
                    <div class="pong-message" id="pongMessage">Press SPACE to start!</div>
                    <div class="pong-instructions">Use UP/DOWN or W/S to move</div>
                </div>
            </div>
        </div>

        <div id="winScreen">
            <div class="win-title">JACKPOT! YOU WIN!</div>
            <div class="win-amount" id="finalAmount">$1,000,000</div>
            <button class="play-again-btn" onclick="resetGame()">PLAY AGAIN</button>
        </div>
    </div>

    <!-- SVG Symbol Definitions -->
    <svg style="display: none;">
        <defs>
            <!-- Diamond (Wild) -->
            <symbol id="sym-diamond" viewBox="0 0 100 100">
                <polygon points="50,5 95,40 50,95 5,40" fill="url(#diamond-grad)" stroke="#fff" stroke-width="2"/>
                <polygon points="50,15 80,40 50,80 20,40" fill="url(#diamond-inner)" opacity="0.6"/>
                <defs>
                    <linearGradient id="diamond-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#00ffff"/>
                        <stop offset="50%" style="stop-color:#0088ff"/>
                        <stop offset="100%" style="stop-color:#0044aa"/>
                    </linearGradient>
                    <linearGradient id="diamond-inner" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#00ffff"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- Gold Bar (Scatter/Bonus) -->
            <symbol id="sym-goldbar" viewBox="0 0 100 100">
                <rect x="10" y="35" width="80" height="40" rx="3" fill="url(#gold-grad)" stroke="#8b6914" stroke-width="2"/>
                <rect x="15" y="40" width="70" height="10" fill="url(#gold-shine)" opacity="0.5"/>
                <text x="50" y="62" text-anchor="middle" font-size="14" font-weight="bold" fill="#8b4513">GOLD</text>
                <polygon points="25,35 35,20 65,20 75,35" fill="url(#gold-grad)" stroke="#8b6914" stroke-width="2"/>
                <defs>
                    <linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffd700"/>
                        <stop offset="50%" style="stop-color:#ffec80"/>
                        <stop offset="100%" style="stop-color:#b8860b"/>
                    </linearGradient>
                    <linearGradient id="gold-shine" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#ffd700"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- Seven -->
            <symbol id="sym-seven" viewBox="0 0 100 100">
                <text x="50" y="75" text-anchor="middle" font-size="70" font-weight="bold" fill="url(#seven-grad)" stroke="#aa0000" stroke-width="2">7</text>
                <defs>
                    <linearGradient id="seven-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff4444"/>
                        <stop offset="50%" style="stop-color:#ff0000"/>
                        <stop offset="100%" style="stop-color:#aa0000"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- Cherry -->
            <symbol id="sym-cherry" viewBox="0 0 100 100">
                <path d="M50,15 Q70,5 75,25" stroke="#228b22" stroke-width="4" fill="none"/>
                <path d="M50,15 Q30,5 25,25" stroke="#228b22" stroke-width="4" fill="none"/>
                <ellipse cx="30" cy="60" rx="20" ry="22" fill="url(#cherry-grad)"/>
                <ellipse cx="70" cy="60" rx="20" ry="22" fill="url(#cherry-grad)"/>
                <ellipse cx="25" cy="52" rx="6" ry="8" fill="rgba(255,255,255,0.4)"/>
                <ellipse cx="65" cy="52" rx="6" ry="8" fill="rgba(255,255,255,0.4)"/>
                <ellipse cx="50" cy="12" rx="8" ry="5" fill="#228b22"/>
                <defs>
                    <radialGradient id="cherry-grad" cx="30%" cy="30%">
                        <stop offset="0%" style="stop-color:#ff4444"/>
                        <stop offset="100%" style="stop-color:#aa0000"/>
                    </radialGradient>
                </defs>
            </symbol>

            <!-- Bell -->
            <symbol id="sym-bell" viewBox="0 0 100 100">
                <ellipse cx="50" cy="75" rx="35" ry="15" fill="url(#bell-grad)"/>
                <path d="M20,75 Q20,30 50,25 Q80,30 80,75" fill="url(#bell-grad)" stroke="#b8860b" stroke-width="2"/>
                <circle cx="50" cy="85" r="8" fill="#b8860b"/>
                <rect x="45" y="15" width="10" height="15" rx="5" fill="#b8860b"/>
                <ellipse cx="35" cy="50" rx="8" ry="15" fill="rgba(255,255,255,0.3)"/>
                <defs>
                    <linearGradient id="bell-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffd700"/>
                        <stop offset="50%" style="stop-color:#ffec80"/>
                        <stop offset="100%" style="stop-color:#daa520"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- Star -->
            <symbol id="sym-star" viewBox="0 0 100 100">
                <polygon points="50,5 61,35 95,35 68,57 79,90 50,70 21,90 32,57 5,35 39,35"
                         fill="url(#star-grad)" stroke="#ff8c00" stroke-width="2"/>
                <polygon points="50,20 56,38 75,38 60,50 66,68 50,57 34,68 40,50 25,38 44,38"
                         fill="rgba(255,255,255,0.4)"/>
                <defs>
                    <linearGradient id="star-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffff00"/>
                        <stop offset="50%" style="stop-color:#ffd700"/>
                        <stop offset="100%" style="stop-color:#ff8c00"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- Crown -->
            <symbol id="sym-crown" viewBox="0 0 100 100">
                <path d="M10,70 L10,40 L30,55 L50,30 L70,55 L90,40 L90,70 Z" fill="url(#crown-grad)" stroke="#8b4513" stroke-width="2"/>
                <rect x="10" y="70" width="80" height="15" rx="3" fill="url(#crown-grad)" stroke="#8b4513" stroke-width="2"/>
                <circle cx="30" cy="40" r="6" fill="#ff0000" stroke="#8b0000" stroke-width="1"/>
                <circle cx="50" cy="32" r="6" fill="#00ff00" stroke="#008800" stroke-width="1"/>
                <circle cx="70" cy="40" r="6" fill="#0000ff" stroke="#000088" stroke-width="1"/>
                <circle cx="50" cy="77" r="5" fill="#ff00ff" stroke="#880088" stroke-width="1"/>
                <defs>
                    <linearGradient id="crown-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffd700"/>
                        <stop offset="100%" style="stop-color:#b8860b"/>
                    </linearGradient>
                </defs>
            </symbol>

            <!-- ===== ZOMBIE THEME SYMBOLS ===== -->

            <!-- Zombie (Wild) - Bright green zombie face -->
            <symbol id="sym-zombie" viewBox="0 0 100 100">
                <ellipse cx="50" cy="50" rx="35" ry="38" fill="#7cfc00" stroke="#32cd32" stroke-width="3"/>
                <ellipse cx="50" cy="50" rx="30" ry="33" fill="#98fb98"/>
                <ellipse cx="38" cy="42" rx="10" ry="8" fill="#fff"/>
                <ellipse cx="62" cy="42" rx="10" ry="8" fill="#fff"/>
                <circle cx="38" cy="44" r="5" fill="#ff0000"/>
                <circle cx="62" cy="44" r="5" fill="#ff0000"/>
                <circle cx="36" cy="43" r="2" fill="#fff"/>
                <circle cx="60" cy="43" r="2" fill="#fff"/>
                <path d="M35,65 Q50,75 65,65" stroke="#228b22" stroke-width="4" fill="none"/>
                <rect x="38" y="62" width="6" height="10" fill="#fff" stroke="#ccc" stroke-width="1"/>
                <rect x="47" y="62" width="6" height="10" fill="#fff" stroke="#ccc" stroke-width="1"/>
                <rect x="56" y="62" width="6" height="10" fill="#fff" stroke="#ccc" stroke-width="1"/>
                <text x="50" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="#ff0">WILD</text>
            </symbol>

            <!-- Brain (Scatter/Bonus) - Bright pink brain -->
            <symbol id="sym-brain" viewBox="0 0 100 100">
                <ellipse cx="50" cy="50" rx="40" ry="35" fill="#ff69b4" stroke="#ff1493" stroke-width="3"/>
                <ellipse cx="50" cy="50" rx="35" ry="30" fill="#ffb6c1"/>
                <path d="M25,40 Q35,25 50,30 Q65,25 75,40" stroke="#ff1493" stroke-width="4" fill="none"/>
                <path d="M30,55 Q40,48 50,55 Q60,48 70,55" stroke="#ff1493" stroke-width="3" fill="none"/>
                <path d="M35,70 Q45,63 55,70 Q65,63 70,70" stroke="#ff1493" stroke-width="3" fill="none"/>
                <path d="M50,30 L50,75" stroke="#ff1493" stroke-width="3"/>
                <text x="50" y="95" text-anchor="middle" font-size="10" font-weight="bold" fill="#ff1493">BONUS</text>
            </symbol>

            <!-- Skull - White skull with dark features -->
            <symbol id="sym-skull" viewBox="0 0 100 100">
                <ellipse cx="50" cy="42" rx="38" ry="32" fill="#fff" stroke="#ccc" stroke-width="2"/>
                <rect x="32" y="68" width="36" height="22" rx="3" fill="#fff" stroke="#ccc" stroke-width="2"/>
                <ellipse cx="35" cy="40" rx="12" ry="14" fill="#1a1a1a"/>
                <ellipse cx="65" cy="40" rx="12" ry="14" fill="#1a1a1a"/>
                <ellipse cx="35" cy="38" rx="4" ry="5" fill="#ff0000"/>
                <ellipse cx="65" cy="38" rx="4" ry="5" fill="#ff0000"/>
                <path d="M45,58 L50,65 L55,58" fill="#1a1a1a"/>
                <rect x="36" y="78" width="6" height="14" fill="#1a1a1a"/>
                <rect x="47" y="78" width="6" height="14" fill="#1a1a1a"/>
                <rect x="58" y="78" width="6" height="14" fill="#1a1a1a"/>
            </symbol>

            <!-- Bat - Purple bat with yellow eyes -->
            <symbol id="sym-bat" viewBox="0 0 100 100">
                <ellipse cx="50" cy="50" rx="15" ry="18" fill="#9932cc" stroke="#8b008b" stroke-width="2"/>
                <path d="M35,45 Q15,25 5,50 Q15,42 28,55 Q32,48 35,48" fill="#9932cc" stroke="#8b008b" stroke-width="1"/>
                <path d="M65,45 Q85,25 95,50 Q85,42 72,55 Q68,48 65,48" fill="#9932cc" stroke="#8b008b" stroke-width="1"/>
                <circle cx="43" cy="45" r="6" fill="#ffff00"/>
                <circle cx="57" cy="45" r="6" fill="#ffff00"/>
                <circle cx="43" cy="46" r="3" fill="#000"/>
                <circle cx="57" cy="46" r="3" fill="#000"/>
                <path d="M47,58 L50,65 L53,58" fill="#ff4444"/>
                <ellipse cx="45" cy="35" rx="4" ry="8" fill="#9932cc"/>
                <ellipse cx="55" cy="35" rx="4" ry="8" fill="#9932cc"/>
            </symbol>

            <!-- Potion - Bright purple/green potion -->
            <symbol id="sym-potion" viewBox="0 0 100 100">
                <rect x="40" y="12" width="20" height="18" rx="3" fill="#8b4513" stroke="#5d3a1a" stroke-width="2"/>
                <ellipse cx="50" cy="12" rx="10" ry="4" fill="#a0522d"/>
                <path d="M36,30 L32,78 Q32,90 50,90 Q68,90 68,78 L64,30 Z" fill="#00ff00" stroke="#32cd32" stroke-width="3"/>
                <ellipse cx="50" cy="78" rx="14" ry="6" fill="rgba(255,255,255,0.4)"/>
                <circle cx="40" cy="55" r="5" fill="rgba(255,255,255,0.6)"/>
                <circle cx="55" cy="65" r="6" fill="rgba(255,255,255,0.5)"/>
                <circle cx="45" cy="45" r="3" fill="rgba(255,255,255,0.7)"/>
                <circle cx="58" cy="50" r="4" fill="rgba(255,255,255,0.5)"/>
            </symbol>

            <!-- Moon - Bright yellow crescent moon -->
            <symbol id="sym-moon" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="38" fill="#ffff00" stroke="#ffd700" stroke-width="3"/>
                <circle cx="68" cy="50" r="32" fill="#1a0a3e"/>
                <circle cx="35" cy="35" r="4" fill="rgba(255,200,0,0.6)"/>
                <circle cx="40" cy="55" r="5" fill="rgba(255,200,0,0.5)"/>
                <circle cx="30" cy="48" r="3" fill="rgba(255,200,0,0.6)"/>
                <circle cx="25" cy="60" r="4" fill="rgba(255,200,0,0.4)"/>
            </symbol>

            <!-- Coffin - Brown coffin with cross -->
            <symbol id="sym-coffin" viewBox="0 0 100 100">
                <path d="M50,8 L75,25 L75,82 L62,95 L38,95 L25,82 L25,25 Z" fill="#8b4513" stroke="#5d3a1a" stroke-width="3"/>
                <path d="M50,18 L65,30 L65,72 L57,82 L43,82 L35,72 L35,30 Z" fill="#a0522d"/>
                <rect x="45" y="35" width="10" height="35" fill="#daa520"/>
                <rect x="38" y="48" width="24" height="10" fill="#daa520"/>
            </symbol>

            <!-- Clover - Green four-leaf clover -->
            <symbol id="sym-clover" viewBox="0 0 100 100">
                <ellipse cx="35" cy="35" rx="18" ry="20" fill="url(#clover-grad)" stroke="#228b22" stroke-width="2"/>
                <ellipse cx="65" cy="35" rx="18" ry="20" fill="url(#clover-grad)" stroke="#228b22" stroke-width="2"/>
                <ellipse cx="35" cy="60" rx="18" ry="20" fill="url(#clover-grad)" stroke="#228b22" stroke-width="2"/>
                <ellipse cx="65" cy="60" rx="18" ry="20" fill="url(#clover-grad)" stroke="#228b22" stroke-width="2"/>
                <rect x="46" y="70" width="8" height="25" rx="2" fill="#228b22"/>
                <ellipse cx="33" cy="32" rx="5" ry="6" fill="rgba(255,255,255,0.4)"/>
                <ellipse cx="63" cy="32" rx="5" ry="6" fill="rgba(255,255,255,0.4)"/>
                <defs>
                    <linearGradient id="clover-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#32cd32"/>
                        <stop offset="50%" style="stop-color:#228b22"/>
                        <stop offset="100%" style="stop-color:#006400"/>
                    </linearGradient>
                </defs>
            </symbol>
        </defs>
    </svg>

    <script>
        // ==================== GAME STATE ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        let money = 10000;
        let debt = 0;
        const GOAL = 1000000;
        let gameTime = 0;

        // Loan shark state
        let sharkDialogOpen = false;
        let sharkDialogStage = 0;
        // Shark dialog system with choices
        const sharkDialogTree = {
            start: {
                text: "Hey there, small fry! Name's Finley. I'm what you'd call a... *financial advisor*. First time at my establishment?",
                choices: [
                    { label: "First time, yeah!", next: "newbie" },
                    { label: "I've been around...", next: "veteran" },
                    { label: "Are you... a shark?", next: "shark_question" }
                ]
            },
            newbie: {
                text: "Fresh meat! I mean... fresh FRIEND! *nervously adjusts tie* So, feeling lucky today, or feeling BROKE?",
                choices: [
                    { label: "Super lucky!", next: "lucky" },
                    { label: "Dead broke...", next: "broke" }
                ]
            },
            veteran: {
                text: "Ohhh, a HIGH ROLLER! I like you already. My kind of fish... I mean, PERSON. So what brings you to ol' Finley?",
                choices: [
                    { label: "Need some funds", next: "need_money" },
                    { label: "Just browsing", next: "browsing" }
                ]
            },
            shark_question: {
                text: "*sweats nervously* A shark? ME? Nooo no no, I'm just a... very pointy business fish. With excellent teeth. For SMILING at customers!",
                choices: [
                    { label: "That's... reassuring?", next: "need_money" },
                    { label: "Your teeth are huge!", next: "teeth_joke" }
                ]
            },
            teeth_joke: {
                text: "These? *grins wider* The better to COUNT YOUR MONEY with, my dear! Hahaha! ...Ha. Okay that came out wrong. Anyway, need cash?",
                choices: [
                    { label: "Actually yes", next: "need_money" },
                    { label: "I'm scared now", next: "scared" }
                ]
            },
            scared: {
                text: "Scared?! Of little old ME? I'm a TEDDY SHARK! The friendliest loan shark in the seven seas! ...Wait, I mean oceans. I mean CASINO. Ugh.",
                choices: [
                    { label: "Okay, I trust you", next: "need_money" },
                    { label: "Bye Finley!", next: "goodbye" }
                ]
            },
            lucky: {
                text: "That's the SPIRIT! Nothing like a little confidence before making questionable financial decisions! So, interested in a small... investment?",
                choices: [
                    { label: "Tell me more", next: "need_money" },
                    { label: "What's the catch?", next: "catch" }
                ]
            },
            broke: {
                text: "Broke?! PERFECT! I mean... *ahem* ...that's very unfortunate. Luckily, your pal Finley has a solution! Interested?",
                choices: [
                    { label: "I'm listening...", next: "need_money" },
                    { label: "Sounds fishy", next: "fishy" }
                ]
            },
            fishy: {
                text: "FISHY?! How dare... okay yes, I'm literally a fish. But my LOANS aren't fishy! They're 100% legitimate! *hides contract behind back*",
                choices: [
                    { label: "Fine, show me", next: "need_money" },
                    { label: "No thanks", next: "goodbye" }
                ]
            },
            catch: {
                text: "Catch? There's no catch! Well... maybe a SMALL one. Like, pay me back or I'll... send you strongly worded letters. Yeah. Letters.",
                choices: [
                    { label: "Okay deal", next: "need_money" },
                    { label: "Letters?", next: "letters" }
                ]
            },
            letters: {
                text: "Very. Strongly. Worded. ...Written in ALL CAPS. With EXCLAMATION MARKS!!! Terrifying stuff. So... we good? Need some moolah?",
                choices: [
                    { label: "Hit me", next: "need_money" },
                    { label: "I'll pass", next: "goodbye" }
                ]
            },
            browsing: {
                text: "Browsing? At a LOAN SHARK's desk? That's like going to a dentist to window shop! Come on, you know you want some easy money~",
                choices: [
                    { label: "Okay, convince me", next: "need_money" },
                    { label: "Really just looking", next: "goodbye" }
                ]
            },
            need_money: {
                text: "EXCELLENT! So here's the fin... I mean FINE print: You pay me back whenever. No pressure. *crosses fins* So... how much ya need, friend?",
                choices: "loan_options"
            },
            goodbye: {
                text: "Alright, swim along then! Remember: Finley's ALWAYS here when you need him. Open 24/7. Like a very friendly, not-at-all-threatening convenience store!",
                choices: "close"
            }
        };

        // Particles
        const particles = [];

        // Ceiling lights
        const ceilingLights = [];
        for (let x = 80; x < 720; x += 80) {
            ceilingLights.push({ x, y: 50, hue: Math.random() * 360 });
        }

        // Floor sparkles
        const sparkles = [];
        for (let i = 0; i < 20; i++) {
            sparkles.push({
                x: Math.random() * 800,
                y: Math.random() * 600,
                life: Math.random() * 100,
                maxLife: 100 + Math.random() * 50
            });
        }

        // Player
        const player = {
            x: 400,
            y: 500,
            width: 32,
            height: 32,
            speed: 3,
            direction: 'up',
            frame: 0,
            frameTimer: 0,
            holdingDrink: null // null, 'martini', 'whiskey', or 'sake'
        };

        // ==================== ROOM SYSTEM ====================
        let currentRoom = 'casino';
        let roomTransitioning = false;

        // Spanish companion NPC
        const companion = {
            x: player.x - 40,
            y: player.y,
            direction: 'right',
            frame: 0,
            fearLevel: 0, // 0 = normal, 1 = worried, 2 = scared
            lastComment: 0,
            comments: [
                "Quizs deberamos ir a casa...",
                "Tengo miedo...",
                "Creo que tens un problema con el juego...",
                "Cunto tiempo llevamos ac?",
                "Quiero ir a bouldering...",
                "Cojemos?"
            ],
            worriedComments: [
                "Ay no, debs plata!",
                "Esto no me gusta nada...",
                "Cmo vamos a pagar eso?",
                "Tengo un mal presentimiento...",
                "Me prometiste que no ibas a tomar un prstamo..."
            ],
            scaredComments: [
                "VMONOS DE AC!",
                "Estamos en problemas!",
                "El tiburn nos va a comer!"
            ]
        };
        let companionComment = '';
        let companionCommentTimer = 0;

        // Shark chase state (activates when debt > $600K)
        let sharkChaseActive = false;
        let sharkChaseStarted = false; // true after 5 second delay
        let sharkChaseTimer = 0;
        let gameOver = false;
        let gameWon = false;

        // Room definitions
        const rooms = {
            casino: {
                name: 'Lucky Pixel Casino',
                bgColor: '#1a0a2e',
                exits: { right: 'lounge', down: 'sushi' },
                objects: [
                    // Diamond Deluxe Slot Machine
                    { x: 100, y: 180, width: 100, height: 100, type: 'slots', theme: 'diamond' },
                    // Zombie Fortune Slot Machine
                    { x: 250, y: 180, width: 100, height: 100, type: 'slots', theme: 'zombie' },
                    // Lucky 7 Free Spins Slot Machine
                    { x: 100, y: 320, width: 100, height: 100, type: 'slots', theme: 'lucky7' },
                    // Roulette tables
                    { x: 500, y: 150, width: 80, height: 80, type: 'roulette' },
                    { x: 620, y: 150, width: 80, height: 80, type: 'roulette' },
                    // Blackjack tables
                    { x: 500, y: 320, width: 80, height: 60, type: 'blackjack' },
                    { x: 620, y: 320, width: 80, height: 60, type: 'blackjack' },
                    // Decorations
                    { x: 30, y: 100, width: 40, height: 80, type: 'pillar' },
                    { x: 730, y: 100, width: 40, height: 80, type: 'pillar' },
                    { x: 30, y: 400, width: 40, height: 80, type: 'pillar' },
                    { x: 730, y: 400, width: 40, height: 80, type: 'pillar' },
                    { x: 380, y: 100, width: 40, height: 50, type: 'plant' },
                    { x: 440, y: 100, width: 40, height: 50, type: 'plant' },
                    { x: 360, y: 320, width: 80, height: 80, type: 'fountain' },
                    // Loan Shark (Finley the Shark)
                    { x: 50, y: 450, width: 60, height: 60, type: 'shark' },
                ],
                npcs: [
                    { x: 350, y: 200, direction: 'right', type: 'dealer', bobPhase: 0, interactText: "Good luck at the tables!" },
                    { x: 550, y: 250, direction: 'down', type: 'player_npc', bobPhase: 1, interactText: "I'm on a winning streak!" },
                    { x: 250, y: 350, direction: 'up', type: 'player_npc', bobPhase: 2, interactText: "Just one more spin..." },
                    { x: 650, y: 420, direction: 'left', type: 'security', bobPhase: 3, interactText: "No photos allowed." },
                    { x: 460, y: 420, direction: 'down', type: 'cat', bobPhase: 0, name: 'Whiskers', interactText: "*purrs*", action: 'pet' },
                ]
            },
            lounge: {
                name: 'The Tipsy Dolphin Lounge',
                bgColor: '#1a1a0a',
                exits: { left: 'casino' },
                objects: [
                    // Bar counter
                    { x: 200, y: 120, width: 400, height: 60, type: 'bar_counter' },
                    // Tables
                    { x: 100, y: 300, width: 60, height: 60, type: 'lounge_table' },
                    { x: 300, y: 300, width: 60, height: 60, type: 'lounge_table' },
                    { x: 500, y: 300, width: 60, height: 60, type: 'lounge_table' },
                    { x: 100, y: 450, width: 60, height: 60, type: 'lounge_table' },
                    { x: 300, y: 450, width: 60, height: 60, type: 'lounge_table' },
                    { x: 500, y: 450, width: 60, height: 60, type: 'lounge_table' },
                    // Decorations
                    { x: 30, y: 100, width: 40, height: 80, type: 'pillar' },
                    { x: 730, y: 100, width: 40, height: 80, type: 'pillar' },
                    { x: 650, y: 200, width: 80, height: 120, type: 'jukebox' },
                    { x: 650, y: 400, width: 60, height: 80, type: 'arcade' },
                ],
                npcs: [
                    { x: 400, y: 140, direction: 'down', type: 'bartender', bobPhase: 0, interactText: "What'll it be?", action: 'drink_menu' },
                    { x: 120, y: 320, direction: 'right', type: 'drunk', bobPhase: 1, interactText: "*hic* ...best night ever..." },
                    { x: 520, y: 320, direction: 'left', type: 'player_npc', bobPhase: 2, interactText: "The casino took everything..." },
                    { x: 320, y: 470, direction: 'up', type: 'player_npc', bobPhase: 0, interactText: "First time here!" },
                ]
            },
            sushi: {
                name: 'Sakura Sushi Bar',
                bgColor: '#0a1a1a',
                exits: { up: 'casino' },
                objects: [
                    // Sushi conveyor belt (curved)
                    { x: 150, y: 150, width: 500, height: 80, type: 'sushi_bar' },
                    // Tables
                    { x: 100, y: 350, width: 80, height: 60, type: 'sushi_table' },
                    { x: 300, y: 350, width: 80, height: 60, type: 'sushi_table' },
                    { x: 500, y: 350, width: 80, height: 60, type: 'sushi_table' },
                    { x: 200, y: 480, width: 80, height: 60, type: 'sushi_table' },
                    { x: 400, y: 480, width: 80, height: 60, type: 'sushi_table' },
                    // Decorations
                    { x: 650, y: 300, width: 80, height: 150, type: 'aquarium' },
                    { x: 30, y: 400, width: 50, height: 80, type: 'bonsai' },
                ],
                npcs: [
                    { x: 400, y: 170, direction: 'down', type: 'sushi_chef', bobPhase: 0, interactText: "Irasshaimase! Fresh fish today!", action: 'sushi_menu' },
                    { x: 140, y: 370, direction: 'right', type: 'player_npc', bobPhase: 1, interactText: "This unagi is amazing!" },
                    { x: 540, y: 370, direction: 'left', type: 'businessman', bobPhase: 2, interactText: "Best sushi in town." },
                    { x: 440, y: 500, direction: 'up', type: 'tourist', bobPhase: 3, interactText: "I don't know what to order!" },
                ]
            }
        };

        // Get current room's objects (for backward compatibility)
        function getCurrentObjects() {
            return rooms[currentRoom].objects;
        }

        function getCurrentNPCs() {
            return rooms[currentRoom].npcs;
        }

        const keys = {};

        // Use room system - these getters return current room's objects/NPCs
        const casinoObjects = { get items() { return getCurrentObjects(); } };
        Object.defineProperty(window, 'casinoObjects', {
            get: function() { return getCurrentObjects(); }
        });

        let nearObject = null;
        let nearNPC = null;
        let currentMinigame = null;

        // ==================== SLOT MACHINE STATE ====================
        // Symbol definitions for Diamond Deluxe theme - BOOSTED PAYOUTS!
        const slotSymbols = [
            { id: 'diamond', name: 'Diamond', wild: true, payout: { 3: 100, 4: 500, 5: 2500 } },
            { id: 'goldbar', name: 'Gold Bar', scatter: true, payout: { 3: 10, 4: 50, 5: 250 }, freeSpins: { 3: 10, 4: 20, 5: 30 } },
            { id: 'seven', name: 'Seven', payout: { 3: 75, 4: 250, 5: 1000 } },
            { id: 'crown', name: 'Crown', payout: { 3: 50, 4: 150, 5: 600 } },
            { id: 'bell', name: 'Bell', payout: { 3: 30, 4: 100, 5: 400 } },
            { id: 'star', name: 'Star', payout: { 3: 20, 4: 60, 5: 200 } },
            { id: 'cherry', name: 'Cherry', payout: { 3: 10, 4: 30, 5: 100 } },
        ];

        // Weighted symbol distribution - Diamond Deluxe is GENEROUS (pays big!)
        const symbolWeights = {
            'diamond': 8,    // Wild appears more often
            'goldbar': 10,   // Bonus scatter more common
            'seven': 15,     // High payer more common
            'crown': 18,
            'bell': 20,
            'star': 20,
            'cherry': 20
        };

        // Payline patterns - each is an array of row indices for each reel [reel0, reel1, reel2, reel3, reel4]
        // Row 0 = top, Row 1 = middle, Row 2 = bottom
        const paylines = [
            // Lines 1-10
            [1, 1, 1, 1, 1],  // Line 1: Middle straight
            [0, 0, 0, 0, 0],  // Line 2: Top straight
            [2, 2, 2, 2, 2],  // Line 3: Bottom straight
            [0, 1, 2, 1, 0],  // Line 4: V shape
            [2, 1, 0, 1, 2],  // Line 5: Inverted V
            [0, 0, 1, 2, 2],  // Line 6: Diagonal down
            [2, 2, 1, 0, 0],  // Line 7: Diagonal up
            [1, 0, 0, 0, 1],  // Line 8: Top arch
            [1, 2, 2, 2, 1],  // Line 9: Bottom arch
            [0, 1, 0, 1, 0],  // Line 10: Zigzag top
            // Lines 11-20
            [2, 1, 2, 1, 2],  // Line 11: Zigzag bottom
            [1, 0, 1, 0, 1],  // Line 12: Wave top
            [1, 2, 1, 2, 1],  // Line 13: Wave bottom
            [0, 0, 0, 1, 2],  // Line 14: Late drop
            [2, 2, 2, 1, 0],  // Line 15: Late rise
            [0, 1, 1, 1, 0],  // Line 16: Flat top bump
            [2, 1, 1, 1, 2],  // Line 17: Flat bottom bump
            [1, 1, 0, 1, 1],  // Line 18: Top dip
            [1, 1, 2, 1, 1],  // Line 19: Bottom dip
            [0, 2, 0, 2, 0],  // Line 20: Big zigzag
            // Lines 21-30
            [2, 0, 2, 0, 2],  // Line 21: Big zigzag alt
            [0, 0, 1, 0, 0],  // Line 22: Top with middle dip
            [2, 2, 1, 2, 2],  // Line 23: Bottom with middle bump
            [1, 0, 1, 2, 1],  // Line 24: S curve
            [1, 2, 1, 0, 1],  // Line 25: S curve reverse
            [0, 1, 2, 2, 2],  // Line 26: Drop to bottom
            [2, 1, 0, 0, 0],  // Line 27: Rise to top
            [0, 0, 2, 2, 0],  // Line 28: W shape
            [2, 2, 0, 0, 2],  // Line 29: M shape
            [1, 0, 2, 0, 1],  // Line 30: Diamond
            // Lines 31-40
            [0, 2, 1, 2, 0],  // Line 31: Hourglass
            [2, 0, 1, 0, 2],  // Line 32: Hourglass inverted
            [0, 1, 1, 0, 0],  // Line 33: Top slope
            [2, 1, 1, 2, 2],  // Line 34: Bottom slope
            [0, 0, 0, 0, 1],  // Line 35: Top with end dip
            [0, 0, 0, 0, 2],  // Line 36: Top diagonal end
            [2, 2, 2, 2, 1],  // Line 37: Bottom with end rise
            [2, 2, 2, 2, 0],  // Line 38: Bottom diagonal end
            [1, 0, 0, 1, 2],  // Line 39: Staircase down
            [1, 2, 2, 1, 0],  // Line 40: Staircase up
            // Lines 41-50
            [0, 1, 0, 0, 1],  // Line 41: Top bumpy
            [2, 1, 2, 2, 1],  // Line 42: Bottom bumpy
            [1, 1, 0, 0, 0],  // Line 43: Rise right
            [1, 1, 2, 2, 2],  // Line 44: Drop right
            [0, 0, 0, 1, 1],  // Line 45: Top to middle
            [2, 2, 2, 1, 1],  // Line 46: Bottom to middle
            [1, 0, 2, 1, 0],  // Line 47: Crazy wave
            [1, 2, 0, 1, 2],  // Line 48: Crazy wave alt
            [0, 2, 2, 2, 0],  // Line 49: U shape
            [2, 0, 0, 0, 2],  // Line 50: Inverted U
        ];

        // Payline colors for highlighting (cycle through for 50 lines)
        const paylineColors = [
            '#ff0000', '#00ff00', '#0088ff', '#ffff00', '#ff00ff',
            '#00ffff', '#ff8800', '#88ff00', '#ff0088', '#8800ff',
            '#ff4444', '#44ff44', '#4488ff', '#ffff44', '#ff44ff',
            '#44ffff', '#ffaa44', '#aaff44', '#ff44aa', '#aa44ff',
            '#ff6666', '#66ff66', '#6688ff', '#ffff66', '#ff66ff',
            '#66ffff', '#ffcc66', '#ccff66', '#ff66cc', '#cc66ff',
            '#ff8888', '#88ff88', '#8888ff', '#ffff88', '#ff88ff',
            '#88ffff', '#ffdd88', '#ddff88', '#ff88dd', '#dd88ff',
            '#ffaaaa', '#aaffaa', '#aaaaff', '#ffffaa', '#ffaaff',
            '#aaffff', '#ffeeaa', '#eeffaa', '#ffaaee', '#eeaaff',
        ];

        let slotBet = 200;
        let slotLines = 5;  // Number of active paylines
        let freeSpins = 0;
        let isSpinning = false;
        let reelResults = [[], [], [], [], []];
        let bonusMultiplier = 1;
        let isMegaBonus = false; // 5% chance mega bonus with 20 free spins
        let winningLines = [];  // Track which lines won for highlighting

        // Lever state
        let leverPulled = false;

        // ==================== ZOMBIE SLOT MACHINE STATE ====================
        // Symbol definitions for Zombie Fortune theme
        const zombieSymbols = [
            { id: 'zombie', name: 'Zombie', wild: true, payout: { 3: 50, 4: 200, 5: 1000 } },
            { id: 'brain', name: 'Brain', scatter: true, payout: { 3: 5, 4: 20, 5: 100 }, freeSpins: { 3: 8, 4: 15, 5: 25 } },
            { id: 'skull', name: 'Skull', payout: { 3: 30, 4: 100, 5: 500 } },
            { id: 'coffin', name: 'Coffin', payout: { 3: 20, 4: 75, 5: 300 } },
            { id: 'bat', name: 'Bat', payout: { 3: 15, 4: 50, 5: 200 } },
            { id: 'potion', name: 'Potion', payout: { 3: 10, 4: 30, 5: 100 } },
            { id: 'moon', name: 'Moon', payout: { 3: 5, 4: 15, 5: 50 } },
        ];

        // Zombie Fortune is STINGY - rarely pays out
        const zombieWeights = {
            'zombie': 1,     // Wild very rare
            'brain': 2,      // Bonus scatter rare
            'skull': 4,      // High payers rare
            'coffin': 6,
            'bat': 15,
            'potion': 25,
            'moon': 35       // Low payer very common
        };

        let zombieBet = 100;
        let zombieLines = 5;  // Number of active paylines
        let zombieFreeSpins = 0;
        let isZombieSpinning = false;
        let zombieReelResults = [[], [], [], [], []];
        let zombieBonusMultiplier = 1;
        let isZombieMegaBonus = false;
        let zombieLeverPulled = false;
        let zombieWinningLines = [];  // Track which lines won
        let currentSlotTheme = 'diamond'; // Track which slot is being played

        // ==================== LUCKY 7 FREE SPINS SLOT MACHINE STATE ====================
        // Symbol definitions for Lucky 7 theme - simple classic symbols (easier to win)
        const lucky7Symbols = [
            { id: 'seven', name: 'Lucky 7', wild: true, payout: { 3: 77, 4: 777, 5: 7777 } },
            { id: 'clover', name: 'Clover', payout: { 3: 30, 4: 100, 5: 500 } },
            { id: 'cherry', name: 'Cherry', payout: { 3: 15, 4: 50, 5: 200 } },
            { id: 'bell', name: 'Bell', payout: { 3: 10, 4: 30, 5: 100 } },
        ];

        // Lucky 7 weights - easier odds with fewer symbols
        const lucky7Weights = {
            'seven': 12,     // Wild
            'clover': 8,     // Rare - triggers multiplier during free spins
            'cherry': 38,
            'bell': 42
        };

        let lucky7Bet = 300;
        let lucky7Lines = 5;
        let lucky7FreeSpins = 0;
        let isLucky7Spinning = false;
        let lucky7ReelResults = [[], [], [], [], []];
        let lucky7LeverPulled = false;
        let lucky7WinningLines = [];
        let isLucky7AutoSpinning = false;
        let stickyCloverPositions = new Set(); // Track "reel,row" positions with sticky clovers
        let lucky7Multiplier = 1; // Multiplier during free spins
        let lucky7AccumulatedWins = 0; // Accumulated winnings during free spins

        // ==================== ROULETTE STATE ====================
        const rouletteNumbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        let rouletteBet = 100;
        let rouletteBets = {};  // Changed to object to track by position
        let isRouletteSpinning = false;
        let wheelRotation = 0;

        // ==================== BLACKJACK STATE ====================
        let bjBet = 100;
        let playerHand = [];
        let dealerHand = [];
        let deck = [];
        let bjGameActive = false;

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            // Debug: Press 0 to add $100K
            if (e.key === '0') {
                updateMoney(100000);
                return;
            }
            // Space closes simple NPC dialogs
            if (e.key === ' ' && npcDialogOpen) {
                e.preventDefault();
                closeNPCDialog();
                return;
            }
            if (e.key === ' ' && !currentMinigame && !sharkDialogOpen && !npcDialogOpen && !roomTransitioning) {
                e.preventDefault();
                if (nearObject) {
                    if (nearObject.type === 'shark') {
                        openSharkDialog();
                    } else if (nearObject.type === 'bar_counter') {
                        // Find bartender NPC to trigger drink menu
                        openNPCDialog({ action: 'drink_menu', interactText: "What'll it be?" });
                    } else if (nearObject.type === 'sushi_bar') {
                        openNPCDialog({ action: 'sushi_menu', interactText: "Irasshaimase!" });
                    } else {
                        openMinigame(nearObject.type, nearObject.theme);
                    }
                } else if (nearNPC) {
                    openNPCDialog(nearNPC);
                }
            }
            if (e.key === 'Escape') {
                if (npcDialogOpen) {
                    closeNPCDialog();
                } else if (sharkDialogOpen) {
                    closeSharkDialog();
                } else if (currentMinigame) {
                    closeMinigame();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Lever interaction
        const leverHandle = document.getElementById('leverHandle');
        const leverRod = document.getElementById('leverRod');

        leverHandle.addEventListener('click', pullLever);
        leverHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            pullLever();
        });

        function pullLever() {
            if (isSpinning || leverPulled) return;

            leverPulled = true;
            leverHandle.classList.add('pulled');
            leverRod.classList.add('extended');

            setTimeout(() => {
                leverHandle.classList.remove('pulled');
                leverRod.classList.remove('extended');
                leverPulled = false;
                spin();
            }, 500);
        }

        // Zombie Lever interaction
        const zombieLeverHandle = document.getElementById('zombieLeverHandle');
        const zombieLeverRod = document.getElementById('zombieLeverRod');

        zombieLeverHandle.addEventListener('click', pullZombieLever);
        zombieLeverHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            pullZombieLever();
        });

        function pullZombieLever() {
            if (isZombieSpinning || zombieLeverPulled) return;

            zombieLeverPulled = true;
            zombieLeverHandle.classList.add('pulled');
            zombieLeverRod.classList.add('extended');

            setTimeout(() => {
                zombieLeverHandle.classList.remove('pulled');
                zombieLeverRod.classList.remove('extended');
                zombieLeverPulled = false;
                zombieSpin();
            }, 500);
        }

        // ==================== SLOT MACHINE FUNCTIONS ====================
        function getWeightedSymbol() {
            const totalWeight = Object.values(symbolWeights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;

            for (const symbol of slotSymbols) {
                random -= symbolWeights[symbol.id];
                if (random <= 0) return symbol;
            }
            return slotSymbols[slotSymbols.length - 1];
        }

        function createSymbolElement(symbol, isZombie = false) {
            const div = document.createElement('div');
            div.className = 'reel-symbol';
            div.dataset.symbol = symbol.id;

            // Add glow effect for special (scatter/wild) symbols
            if (symbol.scatter || symbol.wild) {
                div.classList.add('special-symbol');
                if (isZombie) {
                    div.classList.add('zombie-special');
                }
            }

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');

            const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            use.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#sym-${symbol.id}`);

            svg.appendChild(use);
            div.appendChild(svg);

            return div;
        }

        function initializeReels() {
            for (let i = 0; i < 5; i++) {
                const reel = document.getElementById(`reel${i}`);
                const strip = reel.querySelector('.reel-strip');
                strip.innerHTML = '';

                // Create initial symbols (need enough for spinning animation)
                for (let j = 0; j < 20; j++) {
                    const symbol = getWeightedSymbol();
                    strip.appendChild(createSymbolElement(symbol));
                }
            }
        }

        function setLines(lines) {
            if (freeSpins > 0 || isSpinning) return;
            slotLines = lines;
            // Update button states
            document.querySelectorAll('#slotsGame .line-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.lines) === lines);
            });
            updateTotalBet();
        }

        function changeBet(amount) {
            if (freeSpins > 0 || isSpinning) return; // Can't change bet during free spins or spinning
            slotBet = Math.max(100, Math.min(10000, slotBet + amount));
            document.getElementById('slotBet').textContent = slotBet;
            updateTotalBet();
        }

        function updateTotalBet() {
            const total = slotBet * slotLines;
            document.getElementById('totalBet').textContent = total.toLocaleString();
        }

        function spin() {
            if (isSpinning) return;

            const totalBet = slotBet * slotLines;

            // Check if using free spin or regular bet
            if (freeSpins > 0) {
                freeSpins--;
                document.getElementById('freeSpinsCount').textContent = freeSpins;
                if (freeSpins === 0) {
                    document.getElementById('bonusIndicator').classList.remove('active');
                    bonusMultiplier = 1;
                }
            } else {
                if (money < totalBet) {
                    document.getElementById('slotMessage').textContent = 'NOT ENOUGH MONEY!';
                    return;
                }
                updateMoney(-totalBet);
            }

            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('slotMessage').textContent = '';
            document.getElementById('slotMessage').classList.remove('big-win');
            winningLines = [];

            // Clear payline canvas
            const paylineCtx = document.getElementById('paylineCanvas').getContext('2d');
            paylineCtx.clearRect(0, 0, 490, 210);

            // Clear previous winners
            document.querySelectorAll('#reelsContainer .reel-symbol.winner').forEach(el => el.classList.remove('winner'));
            document.querySelectorAll('#reelsContainer .reel-symbol').forEach(el => el.style.boxShadow = '');

            // Generate results for each reel
            reelResults = [];
            for (let i = 0; i < 5; i++) {
                const reelSymbols = [];
                for (let j = 0; j < 3; j++) {
                    reelSymbols.push(getWeightedSymbol());
                }
                reelResults.push(reelSymbols);
            }

            // Animate each reel - longer spin time
            for (let i = 0; i < 5; i++) {
                spinReel(i, 1500 + i * 400);
            }

            // Evaluate after all reels stop
            setTimeout(() => {
                evaluateSlots();
            }, 1500 + 5 * 400 + 600);
        }

        function spinReel(reelIndex, duration) {
            const reel = document.getElementById(`reel${reelIndex}`);
            const strip = reel.querySelector('.reel-strip');

            // Clear and rebuild strip with final results at the end
            strip.innerHTML = '';

            // Add more spinning symbols for longer spin
            for (let i = 0; i < 25; i++) {
                strip.appendChild(createSymbolElement(getWeightedSymbol()));
            }

            // Add final result symbols
            for (let i = 0; i < 3; i++) {
                strip.appendChild(createSymbolElement(reelResults[reelIndex][i]));
            }

            // Animate
            strip.style.transition = 'none';
            strip.style.transform = 'translateY(0)';

            requestAnimationFrame(() => {
                strip.style.transition = `transform ${duration}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
                strip.style.transform = `translateY(-${25 * 70}px)`;
            });
        }

        function evaluateSlots() {
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;

            let totalWin = 0;
            let message = '';
            winningLines = [];

            // Check for scatter bonus (3+ Gold Bars anywhere on all reels)
            const allSymbols = reelResults.flat();
            const totalScatters = allSymbols.filter(s => s.scatter).length;

            if (totalScatters >= 3) {
                const goldBar = slotSymbols.find(s => s.scatter);
                const newFreeSpins = goldBar.freeSpins[Math.min(totalScatters, 5)] || goldBar.freeSpins[5];
                freeSpins += newFreeSpins;
                bonusMultiplier = 2;
                document.getElementById('freeSpinsCount').textContent = freeSpins;
                document.getElementById('bonusIndicator').classList.add('active');

                totalWin += slotBet * slotLines * goldBar.payout[Math.min(totalScatters, 5)];
                message = `BONUS! ${newFreeSpins} FREE SPINS!`;
            }

            // 5% chance of MEGA BONUS - 20 free spins with flashing lights!
            if (!isMegaBonus && freeSpins === 0 && Math.random() < 0.05) {
                isMegaBonus = true;
                freeSpins = 20;
                bonusMultiplier = 3;
                document.getElementById('freeSpinsCount').textContent = freeSpins;
                document.getElementById('bonusIndicator').classList.add('active');
                document.getElementById('bonusIndicator').innerHTML = `
                    <div class="mega-bonus-indicator">
                        <div class="mega-bonus-text">MEGA JACKPOT BONUS!</div>
                    </div>
                    <div class="bonus-spins"><span id="freeSpinsCount">${freeSpins}</span> FREE SPINS!</div>
                `;
                document.querySelector('.slot-machine').classList.add('mega-bonus-active');
                message = 'MEGA JACKPOT! 20 FREE SPINS x3 MULTIPLIER!';
            }

            // Check each active payline
            const seenWinPaths = new Set(); // Track unique winning paths to avoid visual duplicates

            for (let lineIndex = 0; lineIndex < slotLines; lineIndex++) {
                const payline = paylines[lineIndex];
                const lineSymbols = payline.map((row, reelIndex) => reelResults[reelIndex][row]);

                // Find consecutive matches from left
                let consecutiveCount = 1;
                let currentSymbol = lineSymbols[0];
                let wildCount = currentSymbol.wild ? 1 : 0;

                for (let i = 1; i < 5; i++) {
                    const sym = lineSymbols[i];
                    if (sym.id === currentSymbol.id || sym.wild || currentSymbol.wild) {
                        consecutiveCount++;
                        if (sym.wild) wildCount++;
                        if (currentSymbol.wild && !sym.wild) {
                            currentSymbol = sym;
                        }
                    } else {
                        break;
                    }
                }

                // Calculate payout for this line (minimum 4 symbols to win)
                if (consecutiveCount >= 4 && !currentSymbol.scatter) {
                    const payout = currentSymbol.payout[consecutiveCount] || currentSymbol.payout[5];
                    let winAmount = slotBet * payout * bonusMultiplier;

                    if (wildCount > 0) {
                        winAmount *= (1 + wildCount * 0.5);
                    }

                    totalWin += winAmount;

                    // Create a unique key for this winning path (positions of winning symbols)
                    const pathKey = payline.slice(0, consecutiveCount).join(',') + ':' + currentSymbol.id;

                    // Only add to visual winning lines if we haven't seen this exact path
                    if (!seenWinPaths.has(pathKey)) {
                        seenWinPaths.add(pathKey);
                        winningLines.push({
                            lineIndex,
                            consecutiveCount,
                            symbol: currentSymbol
                        });
                    }
                }
            }

            // Draw winning lines and highlight symbols
            if (winningLines.length > 0) {
                drawWinningPaylines('paylineCanvas', winningLines, reelResults);

                if (!message) {
                    if (winningLines.length === 1) {
                        message = `LINE ${winningLines[0].lineIndex + 1}: ${winningLines[0].consecutiveCount}x ${winningLines[0].symbol.name}!`;
                    } else {
                        message = `${winningLines.length} WINNING LINES!`;
                    }
                }
            }

            // Apply winnings
            if (totalWin > 0) {
                updateMoney(Math.floor(totalWin));
                const finalMessage = message + ` +$${Math.floor(totalWin).toLocaleString()}`;
                document.getElementById('slotMessage').textContent = finalMessage;

                if (totalWin >= slotBet * slotLines * 20) {
                    document.getElementById('slotMessage').classList.add('big-win');
                }
            } else {
                document.getElementById('slotMessage').textContent = freeSpins > 0 ? `${freeSpins} FREE SPINS LEFT!` : 'TRY AGAIN!';
            }

            // Auto-spin if free spins remaining
            autoSpinIfFreeSpins();
        }

        function drawWinningPaylines(canvasId, lines, results) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            const reelWidth = 90;
            const symbolHeight = 70;
            const reelGap = 8;
            const padding = 15;

            lines.forEach((winLine) => {
                const lineIndex = winLine.lineIndex;
                const payline = paylines[lineIndex];
                const color = paylineColors[lineIndex];
                const consecutiveCount = winLine.consecutiveCount;

                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                ctx.beginPath();

                for (let reelIndex = 0; reelIndex < consecutiveCount; reelIndex++) {
                    const row = payline[reelIndex];
                    const x = padding + reelIndex * (reelWidth + reelGap) + reelWidth / 2;
                    const y = row * symbolHeight + symbolHeight / 2;

                    if (reelIndex === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    // Highlight winning symbol
                    const reel = document.getElementById(`reel${reelIndex}`);
                    const symbols = reel.querySelectorAll('.reel-symbol');
                    const symbolIdx = 25 + row;
                    if (symbols[symbolIdx]) {
                        symbols[symbolIdx].style.boxShadow = `0 0 15px ${color}, inset 0 0 10px ${color}`;
                    }
                }

                ctx.stroke();

                // Draw circles at each point
                for (let reelIndex = 0; reelIndex < consecutiveCount; reelIndex++) {
                    const row = payline[reelIndex];
                    const x = padding + reelIndex * (reelWidth + reelGap) + reelWidth / 2;
                    const y = row * symbolHeight + symbolHeight / 2;

                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                ctx.shadowBlur = 0;
            });
        }

        // Auto-spin for free spins (2 second delay during mega bonus)
        function autoSpinIfFreeSpins() {
            if (freeSpins > 0 && !isSpinning) {
                const delay = isMegaBonus ? 2000 : 1500;
                setTimeout(() => {
                    spin();
                }, delay);
            } else if (freeSpins === 0 && isMegaBonus) {
                // Mega bonus ended - reset
                isMegaBonus = false;
                document.querySelector('.slot-machine').classList.remove('mega-bonus-active');
                document.getElementById('bonusIndicator').innerHTML = `
                    <div class="bonus-text">FREE SPINS!</div>
                    <div class="bonus-spins"><span id="freeSpinsCount">0</span> REMAINING</div>
                `;
            }
        }

        // ==================== ZOMBIE SLOT MACHINE FUNCTIONS ====================
        function getZombieWeightedSymbol() {
            const totalWeight = Object.values(zombieWeights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;

            for (const symbol of zombieSymbols) {
                random -= zombieWeights[symbol.id];
                if (random <= 0) return symbol;
            }
            return zombieSymbols[zombieSymbols.length - 1];
        }

        function initializeZombieReels() {
            for (let i = 0; i < 5; i++) {
                const reel = document.getElementById(`zombieReel${i}`);
                const strip = reel.querySelector('.reel-strip');
                strip.innerHTML = '';

                for (let j = 0; j < 20; j++) {
                    const symbol = getZombieWeightedSymbol();
                    strip.appendChild(createSymbolElement(symbol, true));
                }
            }
        }

        function setZombieLines(lines) {
            if (zombieFreeSpins > 0 || isZombieSpinning) return;
            zombieLines = lines;
            document.querySelectorAll('#zombieSlotsGame .line-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.lines) === lines);
            });
            updateZombieTotalBet();
        }

        function changeZombieBet(amount) {
            if (zombieFreeSpins > 0 || isZombieSpinning) return;
            zombieBet = Math.max(100, Math.min(10000, zombieBet + amount));
            document.getElementById('zombieSlotBet').textContent = zombieBet;
            updateZombieTotalBet();
        }

        function updateZombieTotalBet() {
            const total = zombieBet * zombieLines;
            document.getElementById('zombieTotalBet').textContent = total.toLocaleString();
        }

        function zombieSpin() {
            if (isZombieSpinning) return;

            const totalBet = zombieBet * zombieLines;

            if (zombieFreeSpins > 0) {
                zombieFreeSpins--;
                document.getElementById('zombieFreeSpinsCount').textContent = zombieFreeSpins;
                if (zombieFreeSpins === 0) {
                    document.getElementById('zombieBonusIndicator').classList.remove('active');
                    zombieBonusMultiplier = 1;
                }
            } else {
                if (money < totalBet) {
                    document.getElementById('zombieSlotMessage').textContent = 'NOT ENOUGH MONEY!';
                    return;
                }
                updateMoney(-totalBet);
            }

            isZombieSpinning = true;
            document.getElementById('zombieSpinBtn').disabled = true;
            document.getElementById('zombieSlotMessage').textContent = '';
            document.getElementById('zombieSlotMessage').classList.remove('big-win');
            zombieWinningLines = [];

            // Clear payline canvas
            const paylineCtx = document.getElementById('zombiePaylineCanvas').getContext('2d');
            paylineCtx.clearRect(0, 0, 490, 210);

            document.querySelectorAll('#zombieReelsContainer .reel-symbol.winner').forEach(el => el.classList.remove('winner'));
            document.querySelectorAll('#zombieReelsContainer .reel-symbol').forEach(el => el.style.boxShadow = '');

            zombieReelResults = [];
            for (let i = 0; i < 5; i++) {
                const reelSymbols = [];
                for (let j = 0; j < 3; j++) {
                    reelSymbols.push(getZombieWeightedSymbol());
                }
                zombieReelResults.push(reelSymbols);
            }

            for (let i = 0; i < 5; i++) {
                spinZombieReel(i, 1500 + i * 400);
            }

            setTimeout(() => {
                evaluateZombieSlots();
            }, 1500 + 5 * 400 + 600);
        }

        function spinZombieReel(reelIndex, duration) {
            const reel = document.getElementById(`zombieReel${reelIndex}`);
            const strip = reel.querySelector('.reel-strip');

            strip.innerHTML = '';

            for (let i = 0; i < 25; i++) {
                strip.appendChild(createSymbolElement(getZombieWeightedSymbol(), true));
            }

            for (let i = 0; i < 3; i++) {
                strip.appendChild(createSymbolElement(zombieReelResults[reelIndex][i], true));
            }

            strip.style.transition = 'none';
            strip.style.transform = 'translateY(0)';

            requestAnimationFrame(() => {
                strip.style.transition = `transform ${duration}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
                strip.style.transform = `translateY(-${25 * 70}px)`;
            });
        }

        function evaluateZombieSlots() {
            isZombieSpinning = false;
            document.getElementById('zombieSpinBtn').disabled = false;

            let totalWin = 0;
            let message = '';
            zombieWinningLines = [];

            // Check for scatter bonus (3+ Brains anywhere)
            const allSymbols = zombieReelResults.flat();
            const totalScatters = allSymbols.filter(s => s.scatter).length;

            if (totalScatters >= 3) {
                const brain = zombieSymbols.find(s => s.scatter);
                const newFreeSpins = brain.freeSpins[Math.min(totalScatters, 5)] || brain.freeSpins[5];
                zombieFreeSpins += newFreeSpins;
                zombieBonusMultiplier = 2;
                document.getElementById('zombieFreeSpinsCount').textContent = zombieFreeSpins;
                document.getElementById('zombieBonusIndicator').classList.add('active');

                totalWin += zombieBet * zombieLines * brain.payout[Math.min(totalScatters, 5)];
                message = `BRAINS! ${newFreeSpins} FREE SPINS!`;
            }

            // 5% chance of MEGA BONUS - 20 free spins with flashing lights!
            if (!isZombieMegaBonus && zombieFreeSpins === 0 && Math.random() < 0.05) {
                isZombieMegaBonus = true;
                zombieFreeSpins = 20;
                zombieBonusMultiplier = 3;
                document.getElementById('zombieFreeSpinsCount').textContent = zombieFreeSpins;
                document.getElementById('zombieBonusIndicator').classList.add('active');
                document.getElementById('zombieBonusIndicator').innerHTML = `
                    <div class="mega-bonus-indicator">
                        <div class="mega-bonus-text">ZOMBIE MEGA JACKPOT!</div>
                    </div>
                    <div class="bonus-spins"><span id="zombieFreeSpinsCount">${zombieFreeSpins}</span> FREE SPINS!</div>
                `;
                document.querySelector('.slot-machine.zombie-theme').classList.add('mega-bonus-active');
                message = 'UNDEAD JACKPOT! 20 FREE SPINS x3 MULTIPLIER!';
            }

            // Check each active payline
            const seenWinPaths = new Set();

            for (let lineIndex = 0; lineIndex < zombieLines; lineIndex++) {
                const payline = paylines[lineIndex];
                const lineSymbols = payline.map((row, reelIndex) => zombieReelResults[reelIndex][row]);

                let consecutiveCount = 1;
                let currentSymbol = lineSymbols[0];
                let wildCount = currentSymbol.wild ? 1 : 0;

                for (let i = 1; i < 5; i++) {
                    const sym = lineSymbols[i];
                    if (sym.id === currentSymbol.id || sym.wild || currentSymbol.wild) {
                        consecutiveCount++;
                        if (sym.wild) wildCount++;
                        if (currentSymbol.wild && !sym.wild) {
                            currentSymbol = sym;
                        }
                    } else {
                        break;
                    }
                }

                if (consecutiveCount >= 4 && !currentSymbol.scatter) {
                    const payout = currentSymbol.payout[consecutiveCount] || currentSymbol.payout[5];
                    let winAmount = zombieBet * payout * zombieBonusMultiplier;

                    if (wildCount > 0) {
                        winAmount *= (1 + wildCount * 0.5);
                    }

                    totalWin += winAmount;

                    // Deduplicate overlapping visual paths
                    const pathKey = payline.slice(0, consecutiveCount).join(',') + ':' + currentSymbol.id;
                    if (!seenWinPaths.has(pathKey)) {
                        seenWinPaths.add(pathKey);
                        zombieWinningLines.push({
                            lineIndex,
                            consecutiveCount,
                            symbol: currentSymbol
                        });
                    }
                }
            }

            // Draw winning lines
            if (zombieWinningLines.length > 0) {
                drawZombieWinningPaylines(zombieWinningLines);

                if (!message) {
                    if (zombieWinningLines.length === 1) {
                        message = `LINE ${zombieWinningLines[0].lineIndex + 1}: ${zombieWinningLines[0].consecutiveCount}x ${zombieWinningLines[0].symbol.name}!`;
                    } else {
                        message = `${zombieWinningLines.length} WINNING LINES!`;
                    }
                }
            }

            if (totalWin > 0) {
                updateMoney(Math.floor(totalWin));
                const finalMessage = message + ` +$${Math.floor(totalWin).toLocaleString()}`;
                document.getElementById('zombieSlotMessage').textContent = finalMessage;

                if (totalWin >= zombieBet * zombieLines * 20) {
                    document.getElementById('zombieSlotMessage').classList.add('big-win');
                }
            } else {
                document.getElementById('zombieSlotMessage').textContent = zombieFreeSpins > 0 ? `${zombieFreeSpins} FREE SPINS LEFT!` : 'TRY AGAIN!';
            }

            // Auto-spin if free spins remaining
            autoZombieSpinIfFreeSpins();
        }

        function drawZombieWinningPaylines(lines) {
            const canvas = document.getElementById('zombiePaylineCanvas');
            const ctx = canvas.getContext('2d');

            const reelWidth = 90;
            const symbolHeight = 70;
            const reelGap = 8;
            const padding = 15;

            lines.forEach((winLine) => {
                const lineIndex = winLine.lineIndex;
                const payline = paylines[lineIndex];
                const color = paylineColors[lineIndex];
                const consecutiveCount = winLine.consecutiveCount;

                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                ctx.beginPath();

                for (let reelIndex = 0; reelIndex < consecutiveCount; reelIndex++) {
                    const row = payline[reelIndex];
                    const x = padding + reelIndex * (reelWidth + reelGap) + reelWidth / 2;
                    const y = row * symbolHeight + symbolHeight / 2;

                    if (reelIndex === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    // Highlight winning symbol
                    const reel = document.getElementById(`zombieReel${reelIndex}`);
                    const symbols = reel.querySelectorAll('.reel-symbol');
                    const symbolIdx = 25 + row;
                    if (symbols[symbolIdx]) {
                        symbols[symbolIdx].style.boxShadow = `0 0 15px ${color}, inset 0 0 10px ${color}`;
                    }
                }

                ctx.stroke();

                // Draw circles at each point
                for (let reelIndex = 0; reelIndex < consecutiveCount; reelIndex++) {
                    const row = payline[reelIndex];
                    const x = padding + reelIndex * (reelWidth + reelGap) + reelWidth / 2;
                    const y = row * symbolHeight + symbolHeight / 2;

                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                ctx.shadowBlur = 0;
            });
        }

        // Auto-spin for zombie free spins
        function autoZombieSpinIfFreeSpins() {
            if (zombieFreeSpins > 0 && !isZombieSpinning) {
                const delay = isZombieMegaBonus ? 2000 : 1500;
                setTimeout(() => {
                    zombieSpin();
                }, delay);
            } else if (zombieFreeSpins === 0 && isZombieMegaBonus) {
                // Mega bonus ended - reset
                isZombieMegaBonus = false;
                document.querySelector('.slot-machine.zombie-theme').classList.remove('mega-bonus-active');
                document.getElementById('zombieBonusIndicator').innerHTML = `
                    <div class="bonus-text">FREE SPINS!</div>
                    <div class="bonus-spins"><span id="zombieFreeSpinsCount">0</span> REMAINING</div>
                `;
            }
        }

        // ==================== LUCKY 7 FREE SPINS SLOT MACHINE FUNCTIONS ====================
        function getWeightedLucky7Symbol() {
            const totalWeight = Object.values(lucky7Weights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;

            for (const symbol of lucky7Symbols) {
                random -= lucky7Weights[symbol.id];
                if (random <= 0) return symbol;
            }
            return lucky7Symbols[lucky7Symbols.length - 1];
        }

        function createLucky7SymbolElement(symbol) {
            const div = document.createElement('div');
            div.className = 'reel-symbol';
            div.dataset.symbol = symbol.id;

            // Add glow effect for wild symbols
            if (symbol.wild) {
                div.classList.add('special-symbol');
            }

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');

            const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            use.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#sym-${symbol.id}`);

            svg.appendChild(use);
            div.appendChild(svg);

            return div;
        }

        function initializeLucky7Reels() {
            for (let reelIndex = 0; reelIndex < 5; reelIndex++) {
                const reel = document.getElementById(`lucky7Reel${reelIndex}`);
                const strip = reel.querySelector('.reel-strip');
                strip.innerHTML = '';

                // Generate symbols for this reel
                for (let i = 0; i < 20; i++) {
                    const symbol = getWeightedLucky7Symbol();
                    strip.appendChild(createLucky7SymbolElement(symbol));
                }

                strip.style.transform = 'translateY(0px)';
            }
        }

        function setLucky7Lines(lines) {
            lucky7Lines = lines;
            document.querySelectorAll('.lucky7-line').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.lines) === lines);
            });
            document.getElementById('lucky7TotalBet').textContent = (lucky7Bet * lucky7Lines).toLocaleString();
        }

        function changeLucky7Bet(amount) {
            lucky7Bet = Math.max(100, Math.min(10000, lucky7Bet + amount));
            document.getElementById('lucky7SlotBet').textContent = lucky7Bet.toLocaleString();
            document.getElementById('lucky7TotalBet').textContent = (lucky7Bet * lucky7Lines).toLocaleString();
        }

        function lucky7Spin() {
            if (isLucky7Spinning) return;

            const totalBet = lucky7Bet * lucky7Lines;
            const isFreeSpinning = lucky7FreeSpins > 0;

            if (!isFreeSpinning && money < totalBet) {
                document.getElementById('lucky7SlotMessage').textContent = 'NOT ENOUGH MONEY!';
                return;
            }

            if (!isFreeSpinning) {
                updateMoney(-totalBet);
            } else {
                lucky7FreeSpins--;
                document.getElementById('lucky7FreeSpinsCount').textContent = lucky7FreeSpins;
            }

            isLucky7Spinning = true;
            document.getElementById('lucky7SpinBtn').disabled = true;
            document.getElementById('lucky7SlotMessage').textContent = 'SPINNING...';

            // Clear previous winning line highlights
            const paylineCanvas = document.getElementById('lucky7PaylineCanvas');
            const ctx = paylineCanvas.getContext('2d');
            ctx.clearRect(0, 0, paylineCanvas.width, paylineCanvas.height);

            // Determine results for each reel
            lucky7ReelResults = [];
            for (let reelIndex = 0; reelIndex < 5; reelIndex++) {
                const reelSymbols = [];
                for (let row = 0; row < 3; row++) {
                    reelSymbols.push(getWeightedLucky7Symbol());
                }
                lucky7ReelResults.push(reelSymbols);
            }

            // Animate reels
            animateLucky7Reels();
        }

        function animateLucky7Reels() {
            const reelDelays = [0, 200, 400, 600, 800];
            let reelsComplete = 0;

            reelDelays.forEach((delay, reelIndex) => {
                setTimeout(() => {
                    const reel = document.getElementById(`lucky7Reel${reelIndex}`);
                    const strip = reel.querySelector('.reel-strip');

                    // Generate new strip with results at the end
                    strip.innerHTML = '';
                    for (let i = 0; i < 27; i++) {
                        strip.appendChild(createLucky7SymbolElement(getWeightedLucky7Symbol()));
                    }
                    // Add the actual results at the end
                    lucky7ReelResults[reelIndex].forEach(symbol => {
                        strip.appendChild(createLucky7SymbolElement(symbol));
                    });

                    strip.style.transition = 'none';
                    strip.style.transform = 'translateY(0px)';

                    setTimeout(() => {
                        strip.style.transition = 'transform 1.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                        strip.style.transform = `translateY(-${27 * 70}px)`;
                    }, 50);

                    setTimeout(() => {
                        reelsComplete++;
                        if (reelsComplete === 5) {
                            setTimeout(checkLucky7Results, 300);
                        }
                    }, 1550);
                }, delay);
            });
        }

        function checkLucky7Results() {
            let totalWin = 0;
            let message = '';
            lucky7WinningLines = [];

            // Count sevens anywhere on the visible reels
            let sevenCount = 0;
            for (let reel of lucky7ReelResults) {
                for (let symbol of reel) {
                    if (symbol.id === 'seven') sevenCount++;
                }
            }

            // 3 or more sevens anywhere triggers 5 free spins
            if (lucky7FreeSpins === 0 && !isLucky7AutoSpinning && sevenCount >= 3) {
                lucky7FreeSpins = 5;
                isLucky7AutoSpinning = true;
                stickyCloverPositions.clear();
                lucky7Multiplier = 1;
                lucky7AccumulatedWins = 0; // Reset accumulated wins
                clearFrozenClovers(); // Clear any leftover visuals
                document.getElementById('lucky7AutoIndicator').classList.add('active');
                document.getElementById('lucky7FreeSpinsCount').textContent = lucky7FreeSpins;
                document.getElementById('lucky7MultiplierDisplay').textContent = lucky7Multiplier;
                message = `${sevenCount} SEVENS! 5 FREE SPINS WON!`;
            }

            // During free spins, check for new clovers and freeze them
            let newClovers = 0;
            if (isLucky7AutoSpinning) {
                for (let reelIndex = 0; reelIndex < 5; reelIndex++) {
                    for (let row = 0; row < 3; row++) {
                        const symbol = lucky7ReelResults[reelIndex][row];
                        const posKey = `${reelIndex},${row}`;
                        if (symbol.id === 'clover' && !stickyCloverPositions.has(posKey)) {
                            stickyCloverPositions.add(posKey);
                            lucky7Multiplier++;
                            newClovers++;
                            addFrozenClover(reelIndex, row);
                        }
                    }
                }
                if (newClovers > 0) {
                    document.getElementById('lucky7MultiplierDisplay').textContent = lucky7Multiplier;
                }
            }

            // Check each active payline (frozen clover positions block/break the chain)
            for (let lineIndex = 0; lineIndex < lucky7Lines; lineIndex++) {
                const payline = paylines[lineIndex];
                // Get symbols, but mark frozen positions as null
                const lineSymbols = payline.map((row, reelIndex) => {
                    const posKey = `${reelIndex},${row}`;
                    if (stickyCloverPositions.has(posKey)) {
                        return null; // Frozen position - doesn't count
                    }
                    return lucky7ReelResults[reelIndex][row];
                });

                // Skip if first position is frozen
                if (lineSymbols[0] === null) continue;

                let consecutiveCount = 1;
                let currentSymbol = lineSymbols[0];
                let wildCount = currentSymbol.wild ? 1 : 0;

                for (let i = 1; i < 5; i++) {
                    const sym = lineSymbols[i];
                    // Frozen position breaks the chain
                    if (sym === null) break;
                    if (sym.id === currentSymbol.id || sym.wild || currentSymbol.wild) {
                        consecutiveCount++;
                        if (sym.wild) wildCount++;
                        if (currentSymbol.wild && !sym.wild) {
                            currentSymbol = sym;
                        }
                    } else {
                        break;
                    }
                }

                if (consecutiveCount >= 3) {
                    const payout = currentSymbol.payout[consecutiveCount] || currentSymbol.payout[5];
                    let winAmount = lucky7Bet * payout;
                    if (wildCount > 0 && !currentSymbol.wild) {
                        winAmount *= (1 + wildCount * 0.5);
                    }
                    totalWin += winAmount;
                    lucky7WinningLines.push({ lineIndex, count: consecutiveCount, symbol: currentSymbol });
                }
            }

            if (totalWin > 0) {
                if (isLucky7AutoSpinning) {
                    // During free spins, accumulate wins (don't add to money yet)
                    lucky7AccumulatedWins += totalWin;
                    message = message || `+$${totalWin.toLocaleString()} (TOTAL: $${lucky7AccumulatedWins.toLocaleString()})`;
                } else {
                    // Normal spin - add to money directly
                    updateMoney(totalWin);
                    message = message || `WIN $${totalWin.toLocaleString()}!`;
                }
                drawLucky7WinningLines();
            } else if (!message) {
                if (newClovers > 0) {
                    message = `+${newClovers} CLOVER! x${lucky7Multiplier}`;
                    if (lucky7AccumulatedWins > 0) {
                        message += ` (TOTAL: $${lucky7AccumulatedWins.toLocaleString()})`;
                    }
                } else {
                    if (isLucky7AutoSpinning && lucky7AccumulatedWins > 0) {
                        message = `TOTAL: $${lucky7AccumulatedWins.toLocaleString()}`;
                    } else {
                        message = lucky7FreeSpins > 0 ? `${lucky7FreeSpins} FREE SPINS LEFT` : 'TRY AGAIN!';
                    }
                }
            }

            document.getElementById('lucky7SlotMessage').textContent = message;
            isLucky7Spinning = false;
            document.getElementById('lucky7SpinBtn').disabled = false;

            // Continue auto-spinning if free spins remaining
            if (lucky7FreeSpins > 0 && isLucky7AutoSpinning) {
                setTimeout(() => {
                    if (lucky7FreeSpins > 0) {
                        lucky7Spin();
                    }
                }, 800);
            } else if (lucky7FreeSpins === 0 && isLucky7AutoSpinning) {
                // Free spins ended - apply multiplier to accumulated wins
                isLucky7AutoSpinning = false;
                document.getElementById('lucky7AutoIndicator').classList.remove('active');

                const finalPayout = lucky7AccumulatedWins * lucky7Multiplier;
                if (finalPayout > 0) {
                    updateMoney(finalPayout);
                    const finalMsg = `BONUS COMPLETE! $${lucky7AccumulatedWins.toLocaleString()} x${lucky7Multiplier} = $${finalPayout.toLocaleString()}!`;
                    document.getElementById('lucky7SlotMessage').textContent = finalMsg;
                } else {
                    document.getElementById('lucky7SlotMessage').textContent = 'FREE SPINS COMPLETE!';
                }

                stickyCloverPositions.clear();
                lucky7Multiplier = 1;
                lucky7AccumulatedWins = 0;
                clearFrozenClovers();
            }
        }

        function addFrozenClover(reelIndex, row) {
            const overlay = document.getElementById('stickyCloverOverlay');
            const cloverDiv = document.createElement('div');
            cloverDiv.className = 'frozen-clover';
            cloverDiv.dataset.pos = `${reelIndex},${row}`;

            // Position: 15px padding + reel positions (90px wide + 8px gap)
            const x = 15 + reelIndex * 98 + 1;
            const y = 15 + row * 70 + 1;
            cloverDiv.style.left = x + 'px';
            cloverDiv.style.top = y + 'px';

            // Create clover SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');
            const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            use.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#sym-clover');
            svg.appendChild(use);
            cloverDiv.appendChild(svg);

            overlay.appendChild(cloverDiv);
        }

        function clearFrozenClovers() {
            const overlay = document.getElementById('stickyCloverOverlay');
            overlay.innerHTML = '';
        }

        function drawLucky7WinningLines() {
            const canvas = document.getElementById('lucky7PaylineCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const colors = ['#ffd700', '#00ff00', '#ff6600', '#00ffff', '#ff00ff'];

            lucky7WinningLines.forEach((win, idx) => {
                const payline = paylines[win.lineIndex];
                const color = colors[idx % colors.length];

                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                ctx.beginPath();

                payline.forEach((row, reelIndex) => {
                    const x = 10 + reelIndex * 98 + 45;
                    const y = row * 70 + 35;
                    if (reelIndex === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();
            });
        }

        // ==================== ROULETTE FUNCTIONS ====================
        // Standard roulette board layout (columns, from bottom row to top)
        const boardLayout = [
            [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36],  // top row
            [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35],  // middle row
            [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34]   // bottom row
        ];

        function initRouletteBoard() {
            const board = document.getElementById('rouletteBoard');
            board.innerHTML = '';
            rouletteBets = {};

            // Zero - spans all 3 rows
            const zero = createBoardCell('0', 'cell-green', '0');
            zero.style.gridColumn = '1';
            zero.style.gridRow = '1 / 4';
            board.appendChild(zero);

            // Create number grid - proper roulette layout
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 12; col++) {
                    const num = boardLayout[row][col];
                    const isRed = redNumbers.includes(num);
                    const cell = createBoardCell(num.toString(), isRed ? 'cell-red' : 'cell-black', num.toString());
                    cell.style.gridColumn = (col + 2).toString();
                    cell.style.gridRow = (row + 1).toString();
                    cell.id = `cell-${num}`;
                    board.appendChild(cell);

                    // Add horizontal split bet (between this number and the one to the right)
                    if (col < 11) {
                        const rightNum = boardLayout[row][col + 1];
                        const splitH = document.createElement('div');
                        splitH.className = 'split-h';
                        splitH.style.right = '-6px';
                        splitH.style.top = '50%';
                        splitH.style.transform = 'translateY(-50%)';
                        splitH.title = `Split: ${num}/${rightNum} (18:1)`;
                        splitH.onclick = (e) => {
                            e.stopPropagation();
                            placeSplitBet(`split-${Math.min(num,rightNum)}-${Math.max(num,rightNum)}`, splitH, [num, rightNum]);
                        };
                        cell.appendChild(splitH);
                    }

                    // Add vertical split bet (between this number and the one below)
                    if (row < 2) {
                        const belowNum = boardLayout[row + 1][col];
                        const splitV = document.createElement('div');
                        splitV.className = 'split-v';
                        splitV.style.bottom = '-6px';
                        splitV.style.left = '50%';
                        splitV.style.transform = 'translateX(-50%)';
                        splitV.title = `Split: ${num}/${belowNum} (18:1)`;
                        splitV.onclick = (e) => {
                            e.stopPropagation();
                            placeSplitBet(`split-${Math.min(num,belowNum)}-${Math.max(num,belowNum)}`, splitV, [num, belowNum]);
                        };
                        cell.appendChild(splitV);
                    }

                    // Add corner bet (intersection of 4 numbers)
                    if (row < 2 && col < 11) {
                        const topLeft = num;
                        const topRight = boardLayout[row][col + 1];
                        const bottomLeft = boardLayout[row + 1][col];
                        const bottomRight = boardLayout[row + 1][col + 1];
                        const corner = document.createElement('div');
                        corner.className = 'corner-bet';
                        corner.style.right = '-8px';
                        corner.style.bottom = '-8px';
                        corner.title = `Corner: ${topLeft}/${topRight}/${bottomLeft}/${bottomRight} (9:1)`;
                        corner.onclick = (e) => {
                            e.stopPropagation();
                            placeCornerBet(`corner-${topLeft}-${topRight}-${bottomLeft}-${bottomRight}`, corner, [topLeft, topRight, bottomLeft, bottomRight]);
                        };
                        cell.appendChild(corner);
                    }
                }
            }

            // Special bets row - improved styling
            const specialBets = [
                { label: ' RED', key: 'red', extraClass: 'red-bet' },
                { label: ' BLK', key: 'black', extraClass: 'black-bet' },
                { label: 'ODD', key: 'odd', extraClass: '' },
                { label: 'EVEN', key: 'even', extraClass: '' },
                { label: '1-18', key: 'low', extraClass: '' },
                { label: '19-36', key: 'high', extraClass: '' }
            ];

            specialBets.forEach((bet, i) => {
                const cell = createBoardCell(bet.label, `cell-bet ${bet.extraClass}`, bet.key);
                cell.style.gridColumn = `${(i * 2) + 2} / span 2`;
                cell.style.gridRow = '4';
                board.appendChild(cell);
            });
        }

        function createBoardCell(label, className, betKey) {
            const cell = document.createElement('div');
            cell.className = `board-cell ${className}`;
            cell.textContent = label;
            cell.dataset.bet = betKey;
            cell.onclick = () => placeBet(betKey, cell);
            return cell;
        }

        function placeSplitBet(betKey, element, numbers) {
            if (isRouletteSpinning) return;
            if (money < rouletteBet) {
                document.getElementById('rouletteResult').textContent = 'NOT ENOUGH!';
                return;
            }
            updateMoney(-rouletteBet);
            if (!rouletteBets[betKey]) {
                rouletteBets[betKey] = { amount: 0, numbers: numbers, type: 'split' };
            }
            rouletteBets[betKey].amount += rouletteBet;
            updateSplitChipDisplay(element, rouletteBets[betKey].amount);
        }

        function placeCornerBet(betKey, element, numbers) {
            if (isRouletteSpinning) return;
            if (money < rouletteBet) {
                document.getElementById('rouletteResult').textContent = 'NOT ENOUGH!';
                return;
            }
            updateMoney(-rouletteBet);
            if (!rouletteBets[betKey]) {
                rouletteBets[betKey] = { amount: 0, numbers: numbers, type: 'corner' };
            }
            rouletteBets[betKey].amount += rouletteBet;
            updateSplitChipDisplay(element, rouletteBets[betKey].amount);
        }

        function updateSplitChipDisplay(element, amount) {
            let chip = element.querySelector('.mini-chip');
            if (!chip) {
                chip = document.createElement('div');
                chip.className = 'mini-chip';
                chip.style.cssText = 'position:absolute;width:10px;height:10px;background:linear-gradient(180deg,#ffd700,#b8860b);border-radius:50%;border:1px solid #8b4513;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;';
                element.appendChild(chip);
            }
            // Show amount on hover via title
            element.title += ` - $${amount}`;
        }

        function placeBet(betKey, cell) {
            if (isRouletteSpinning) return;
            if (money < rouletteBet) {
                document.getElementById('rouletteResult').textContent = 'NOT ENOUGH!';
                return;
            }

            // Deduct bet immediately
            updateMoney(-rouletteBet);

            // Add to bets - use new object structure for consistency
            if (!rouletteBets[betKey]) {
                rouletteBets[betKey] = { amount: 0, type: 'straight' };
            }
            rouletteBets[betKey].amount += rouletteBet;

            // Update visual chips
            updateChipDisplay(cell, rouletteBets[betKey].amount);
        }

        function updateChipDisplay(cell, amount) {
            let stack = cell.querySelector('.chip-stack');
            if (!stack) {
                stack = document.createElement('div');
                stack.className = 'chip-stack';
                cell.appendChild(stack);
            }

            // Clear existing chips
            stack.innerHTML = '';

            // Determine chip breakdown
            const chipValues = [
                { value: 1000, color: 'gold' },
                { value: 500, color: 'black' },
                { value: 100, color: 'green' },
            ];

            let remaining = amount;
            const chips = [];

            for (const chipType of chipValues) {
                while (remaining >= chipType.value && chips.length < 8) {
                    chips.push(chipType.color);
                    remaining -= chipType.value;
                }
            }

            // Create chip elements
            chips.forEach(color => {
                const chip = document.createElement('div');
                chip.className = `chip ${color}`;
                stack.appendChild(chip);
            });

            // Add amount label
            if (chips.length > 0) {
                const label = document.createElement('div');
                label.className = 'chip-amount';
                label.textContent = `$${amount}`;
                stack.appendChild(label);
            }
        }

        function clearRouletteBets() {
            // Refund all bets
            const totalBets = Object.values(rouletteBets).reduce((sum, bet) => sum + (bet.amount || 0), 0);
            if (totalBets > 0) {
                updateMoney(totalBets);
            }

            rouletteBets = {};
            document.querySelectorAll('.chip-stack').forEach(stack => stack.remove());
            document.querySelectorAll('.mini-chip').forEach(chip => chip.remove());
        }

        function changeRouletteBet(amount) {
            rouletteBet = Math.max(100, Math.min(10000, rouletteBet + amount));
            document.getElementById('rouletteBet').textContent = rouletteBet;
        }

        function drawRouletteWheel() {
            const wheelCanvas = document.getElementById('rouletteWheel');
            const wctx = wheelCanvas.getContext('2d');
            const centerX = 125;
            const centerY = 125;
            const radius = 115;

            wctx.clearRect(0, 0, 250, 250);
            wctx.save();
            wctx.translate(centerX, centerY);
            wctx.rotate(wheelRotation);
            wctx.translate(-centerX, -centerY);

            const segmentAngle = (Math.PI * 2) / 37;

            for (let i = 0; i < 37; i++) {
                const angle = i * segmentAngle - Math.PI / 2;
                const num = rouletteNumbers[i];

                wctx.beginPath();
                wctx.moveTo(centerX, centerY);
                wctx.arc(centerX, centerY, radius, angle, angle + segmentAngle);
                wctx.closePath();

                if (num === 0) {
                    wctx.fillStyle = '#2e7d32';
                } else if (redNumbers.includes(num)) {
                    wctx.fillStyle = '#c62828';
                } else {
                    wctx.fillStyle = '#212121';
                }
                wctx.fill();

                // Number text
                wctx.save();
                wctx.translate(centerX, centerY);
                wctx.rotate(angle + segmentAngle / 2);
                wctx.fillStyle = '#fff';
                wctx.font = '9px "Press Start 2P"';
                wctx.textAlign = 'center';
                wctx.fillText(num.toString(), radius - 18, 3);
                wctx.restore();
            }

            // Wheel border
            wctx.beginPath();
            wctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            wctx.strokeStyle = '#8b4513';
            wctx.lineWidth = 8;
            wctx.stroke();

            // Inner circle
            wctx.beginPath();
            wctx.arc(centerX, centerY, 35, 0, Math.PI * 2);
            wctx.fillStyle = '#4a2810';
            wctx.fill();

            wctx.restore();
        }

        function spinRoulette() {
            if (isRouletteSpinning) return;

            const totalBet = Object.values(rouletteBets).reduce((sum, bet) => sum + (bet.amount || 0), 0);
            if (totalBet === 0) {
                document.getElementById('rouletteResult').textContent = 'PLACE A BET!';
                return;
            }

            isRouletteSpinning = true;
            document.getElementById('rouletteSpinBtn').disabled = true;
            document.getElementById('rouletteResult').textContent = '';

            const result = Math.floor(Math.random() * 37);
            const resultNum = rouletteNumbers[result];

            const segmentAngle = (Math.PI * 2) / 37;
            const targetAngle = -(result * segmentAngle) + Math.PI / 2;
            const spins = 5 + Math.random() * 3;
            const finalRotation = wheelRotation + spins * Math.PI * 2 + targetAngle - (wheelRotation % (Math.PI * 2));

            const startRotation = wheelRotation;
            const startTime = Date.now();
            const duration = 4000;

            function animateWheel() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);

                wheelRotation = startRotation + (finalRotation - startRotation) * eased;
                drawRouletteWheel();

                if (progress < 1) {
                    requestAnimationFrame(animateWheel);
                } else {
                    evaluateRoulette(resultNum);
                }
            }

            animateWheel();
        }

        function evaluateRoulette(result) {
            isRouletteSpinning = false;
            document.getElementById('rouletteSpinBtn').disabled = false;

            const isRed = redNumbers.includes(result);
            const isBlack = result !== 0 && !isRed;
            const isOdd = result % 2 === 1;
            const isEven = result !== 0 && result % 2 === 0;
            const isLow = result >= 1 && result <= 18;
            const isHigh = result >= 19 && result <= 36;

            let totalWin = 0;

            for (const [betKey, bet] of Object.entries(rouletteBets)) {
                const amount = bet.amount || 0;
                let multiplier = 0;

                // Handle split bets (2 numbers) - pays 18:1
                if (bet.type === 'split' && bet.numbers) {
                    if (bet.numbers.includes(result)) {
                        multiplier = 18;
                    }
                }
                // Handle corner bets (4 numbers) - pays 9:1
                else if (bet.type === 'corner' && bet.numbers) {
                    if (bet.numbers.includes(result)) {
                        multiplier = 9;
                    }
                }
                // Straight number bet - pays 36:1
                else if (betKey === result.toString()) {
                    multiplier = 36;
                }
                // Outside bets - pay 2:1
                else if (betKey === 'red' && isRed) {
                    multiplier = 2;
                } else if (betKey === 'black' && isBlack) {
                    multiplier = 2;
                } else if (betKey === 'odd' && isOdd) {
                    multiplier = 2;
                } else if (betKey === 'even' && isEven) {
                    multiplier = 2;
                } else if (betKey === 'low' && isLow) {
                    multiplier = 2;
                } else if (betKey === 'high' && isHigh) {
                    multiplier = 2;
                }

                totalWin += amount * multiplier;
            }

            const color = result === 0 ? 'GREEN' : (isRed ? 'RED' : 'BLACK');

            if (totalWin > 0) {
                updateMoney(totalWin);
                document.getElementById('rouletteResult').innerHTML = `${result} ${color}! +$${totalWin.toLocaleString()}`;
                document.getElementById('rouletteResult').style.color = '#7cfc00';
            } else {
                document.getElementById('rouletteResult').innerHTML = `${result} ${color}`;
                document.getElementById('rouletteResult').style.color = '#ff6b6b';
            }

            // Clear bets and chips
            rouletteBets = {};
            document.querySelectorAll('.chip-stack').forEach(stack => stack.remove());
            document.querySelectorAll('.mini-chip').forEach(chip => chip.remove());
        }

        // ==================== BLACKJACK FUNCTIONS ====================
        function createDeck() {
            const suits = ['', '', '', ''];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            deck = [];

            for (const suit of suits) {
                for (const value of values) {
                    deck.push({ suit, value });
                }
            }

            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function cardValue(card) {
            if (['J', 'Q', 'K'].includes(card.value)) return 10;
            if (card.value === 'A') return 11;
            return parseInt(card.value);
        }

        function handValue(hand) {
            let value = hand.reduce((sum, card) => sum + cardValue(card), 0);
            let aces = hand.filter(c => c.value === 'A').length;

            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }

            return value;
        }

        function renderCards() {
            const playerCardsEl = document.getElementById('playerCards');
            const dealerCardsEl = document.getElementById('dealerCards');

            playerCardsEl.innerHTML = '';
            dealerCardsEl.innerHTML = '';

            playerHand.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${['', ''].includes(card.suit) ? 'red' : 'black'}`;
                cardEl.innerHTML = `${card.value}<span class="card-suit">${card.suit}</span>`;
                playerCardsEl.appendChild(cardEl);
            });

            dealerHand.forEach((card, i) => {
                const cardEl = document.createElement('div');
                if (i === 1 && bjGameActive) {
                    cardEl.className = 'card face-down';
                } else {
                    cardEl.className = `card ${['', ''].includes(card.suit) ? 'red' : 'black'}`;
                    cardEl.innerHTML = `${card.value}<span class="card-suit">${card.suit}</span>`;
                }
                dealerCardsEl.appendChild(cardEl);
            });

            document.getElementById('playerValue').textContent = handValue(playerHand);
            document.getElementById('dealerValue').textContent = bjGameActive ? '?' : handValue(dealerHand);
        }

        function changeBjBet(amount) {
            bjBet = Math.max(100, Math.min(10000, bjBet + amount));
            document.getElementById('bjBet').textContent = bjBet;
        }

        function resetBlackjack() {
            playerHand = [];
            dealerHand = [];
            bjGameActive = false;
            document.getElementById('dealBtn').disabled = false;
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;
            document.getElementById('bjMessage').textContent = '';
            renderCards();
        }

        function dealCards() {
            if (money < bjBet) {
                document.getElementById('bjMessage').textContent = 'NOT ENOUGH!';
                return;
            }

            updateMoney(-bjBet);
            createDeck();

            playerHand = [deck.pop(), deck.pop()];
            dealerHand = [deck.pop(), deck.pop()];
            bjGameActive = true;

            document.getElementById('dealBtn').disabled = true;
            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            document.getElementById('bjMessage').textContent = '';

            renderCards();

            if (handValue(playerHand) === 21) {
                stand();
            }
        }

        function hit() {
            playerHand.push(deck.pop());
            renderCards();

            if (handValue(playerHand) > 21) {
                endBlackjack('BUST!', false);
            } else if (handValue(playerHand) === 21) {
                stand();
            }
        }

        function stand() {
            bjGameActive = false;
            renderCards();

            while (handValue(dealerHand) < 17) {
                dealerHand.push(deck.pop());
            }

            renderCards();

            const playerVal = handValue(playerHand);
            const dealerVal = handValue(dealerHand);

            if (dealerVal > 21) {
                endBlackjack('DEALER BUST!', true);
            } else if (playerVal > dealerVal) {
                endBlackjack('YOU WIN!', true);
            } else if (playerVal < dealerVal) {
                endBlackjack('DEALER WINS', false);
            } else {
                endBlackjack('PUSH', null);
            }
        }

        function endBlackjack(message, playerWins) {
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;
            document.getElementById('dealBtn').disabled = false;

            if (playerWins === true) {
                const payout = handValue(playerHand) === 21 && playerHand.length === 2 ? bjBet * 2.5 : bjBet * 2;
                updateMoney(Math.floor(payout));
                document.getElementById('bjMessage').innerHTML = `${message} +$${Math.floor(payout).toLocaleString()}`;
                document.getElementById('bjMessage').style.color = '#7cfc00';
            } else if (playerWins === false) {
                document.getElementById('bjMessage').textContent = message;
                document.getElementById('bjMessage').style.color = '#ff6b6b';
            } else {
                updateMoney(bjBet);
                document.getElementById('bjMessage').textContent = message;
                document.getElementById('bjMessage').style.color = '#ffd700';
            }
        }

        // ==================== WORLD DRAWING ====================
        function drawFloor() {
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#1a0a2e');
            gradient.addColorStop(0.5, '#2d1b4e');
            gradient.addColorStop(1, '#1a0a2e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);

            ctx.fillStyle = '#3d2b5e';
            for (let x = 0; x < 800; x += 40) {
                for (let y = 0; y < 600; y += 40) {
                    if ((x + y) % 80 === 0) {
                        ctx.fillRect(x, y, 20, 20);
                        ctx.fillRect(x + 20, y + 20, 20, 20);
                    }
                }
            }

            ctx.fillStyle = 'rgba(255, 215, 0, 0.1)';
            for (let x = 20; x < 800; x += 80) {
                for (let y = 20; y < 600; y += 80) {
                    ctx.beginPath();
                    ctx.moveTo(x, y - 10);
                    ctx.lineTo(x + 10, y);
                    ctx.lineTo(x, y + 10);
                    ctx.lineTo(x - 10, y);
                    ctx.closePath();
                    ctx.fill();
                }
            }

            sparkles.forEach(s => {
                s.life++;
                if (s.life > s.maxLife) {
                    s.life = 0;
                    s.x = Math.random() * 800;
                    s.y = Math.random() * 600;
                }
                const alpha = Math.sin((s.life / s.maxLife) * Math.PI);
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.4})`;
                const size = 2 + alpha * 2;
                ctx.fillRect(s.x - size/2, s.y - size/2, size, size);
            });
        }

        function drawCeilingLights() {
            ceilingLights.forEach((light, i) => {
                light.hue = (light.hue + 0.5) % 360;
                const pulse = Math.sin(gameTime / 20 + i) * 0.3 + 0.7;

                const grd = ctx.createRadialGradient(light.x, light.y, 0, light.x, light.y, 60);
                grd.addColorStop(0, `hsla(${light.hue}, 100%, 70%, ${0.3 * pulse})`);
                grd.addColorStop(1, 'transparent');
                ctx.fillStyle = grd;
                ctx.fillRect(light.x - 60, light.y - 30, 120, 90);

                ctx.fillStyle = '#333';
                ctx.fillRect(light.x - 15, light.y - 5, 30, 12);
                ctx.fillStyle = `hsl(${light.hue}, 100%, 70%)`;
                ctx.fillRect(light.x - 12, light.y, 24, 6);

                ctx.fillStyle = '#666';
                ctx.fillRect(light.x - 2, light.y - 20, 4, 15);
            });
        }

        function drawNeonSign() {
            const x = 400, y = 35;
            const pulse = Math.sin(gameTime / 10) * 0.2 + 0.8;

            ctx.shadowColor = '#ff69b4';
            ctx.shadowBlur = 20 * pulse;

            ctx.fillStyle = '#1a0a2e';
            ctx.fillRect(x - 100, y - 20, 200, 35);
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.strokeRect(x - 100, y - 20, 200, 35);

            ctx.fillStyle = `rgba(255, 105, 180, ${pulse})`;
            ctx.font = '14px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('LUCKY CASINO', x, y + 5);

            ctx.shadowBlur = 0;
        }

        function drawBigSlotMachine(obj) {
            const { x, y, width, height, theme } = obj;
            const isZombie = theme === 'zombie';
            const isLucky7 = theme === 'lucky7';

            // Cabinet - different colors for each theme
            const grad = ctx.createLinearGradient(x, y, x + width, y + height);
            if (isZombie) {
                grad.addColorStop(0, '#1a1a1a');
                grad.addColorStop(0.5, '#2a1a3a');
                grad.addColorStop(1, '#1a1a1a');
            } else if (isLucky7) {
                grad.addColorStop(0, '#3d0a0a');
                grad.addColorStop(0.5, '#5a1515');
                grad.addColorStop(1, '#3d0a0a');
            } else {
                grad.addColorStop(0, '#2c1810');
                grad.addColorStop(0.5, '#4a2820');
                grad.addColorStop(1, '#2c1810');
            }
            ctx.fillStyle = grad;
            ctx.fillRect(x, y, width, height);

            // Trim color per theme
            ctx.strokeStyle = isZombie ? '#7c4dff' : '#ffd700';
            ctx.lineWidth = 4;
            ctx.strokeRect(x + 2, y + 2, width - 4, height - 4);

            // Top sign
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 10, y + 8, width - 20, 20);

            const signPulse = Math.sin(gameTime / 8) * 0.3 + 0.7;
            let signColor, signText;
            if (isZombie) {
                signColor = `rgba(124, 252, 0, ${signPulse})`;
                signText = 'ZOMBIE';
            } else if (isLucky7) {
                signColor = `rgba(255, 215, 0, ${signPulse})`;
                signText = 'LUCKY 7';
            } else {
                signColor = `rgba(0, 255, 255, ${signPulse})`;
                signText = 'DIAMOND';
            }
            ctx.fillStyle = signColor;
            ctx.font = '7px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText(signText, x + width/2, y + 22);

            // Screen area
            ctx.fillStyle = '#111';
            ctx.fillRect(x + 10, y + 32, width - 20, 40);

            // Animated reels display
            for (let i = 0; i < 3; i++) {
                const reelX = x + 15 + i * 25;
                ctx.fillStyle = isZombie ? '#1a0d2a' : (isLucky7 ? '#1a0a0a' : '#1a1a2a');
                ctx.fillRect(reelX, y + 35, 20, 34);

                // Symbol placeholder - different symbols per theme
                if (isZombie) {
                    // Draw skull-like shape for zombie
                    ctx.fillStyle = `hsl(${100 + (gameTime * 2 + i * 40) % 60}, 70%, 50%)`;
                    ctx.beginPath();
                    ctx.arc(reelX + 10, y + 48, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.fillRect(reelX + 5, y + 45, 3, 3);
                    ctx.fillRect(reelX + 12, y + 45, 3, 3);
                    ctx.fillRect(reelX + 8, y + 52, 4, 4);
                } else if (isLucky7) {
                    // Draw 7 for Lucky 7
                    ctx.fillStyle = `hsl(${40 + (gameTime * 2 + i * 30) % 20}, 100%, 50%)`;
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('7', reelX + 10, y + 56);
                } else {
                    // Diamond shape
                    ctx.fillStyle = `hsl(${(gameTime * 3 + i * 40) % 360}, 70%, 60%)`;
                    ctx.beginPath();
                    ctx.moveTo(reelX + 10, y + 42);
                    ctx.lineTo(reelX + 17, y + 52);
                    ctx.lineTo(reelX + 10, y + 62);
                    ctx.lineTo(reelX + 3, y + 52);
                    ctx.closePath();
                    ctx.fill();
                }
            }

            // Lever
            const leverBob = Math.sin(gameTime / 15) * 2;
            ctx.fillStyle = '#666';
            ctx.fillRect(x + width - 12, y + 30, 6, 35);
            ctx.fillStyle = isZombie ? '#7cfc00' : (isLucky7 ? '#ffd700' : '#ff0000');
            ctx.beginPath();
            ctx.arc(x + width - 9, y + 26 + leverBob, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = isZombie ? '#7c4dff' : '#ffd700';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Coin slot
            ctx.fillStyle = '#333';
            ctx.fillRect(x + width/2 - 10, y + height - 20, 20, 5);

            // Animated lights - different per theme
            let lightColors;
            if (isZombie) {
                lightColors = ['#7cfc00', '#7c4dff', '#7cfc00', '#7c4dff', '#7cfc00'];
            } else if (isLucky7) {
                lightColors = ['#ffd700', '#ff6600', '#ffd700', '#ff6600', '#ffd700'];
            } else {
                lightColors = ['#ff0', '#f0f', '#0ff', '#f00', '#0f0'];
            }
            for (let i = 0; i < 5; i++) {
                const on = Math.sin(gameTime / 5 + i) > 0;
                ctx.fillStyle = on ? lightColors[i] : '#333';
                ctx.beginPath();
                ctx.arc(x + 12 + i * 18, y + height - 8, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawRouletteTable(obj) {
            const { x, y, width, height } = obj;

            ctx.fillStyle = '#0a5c0a';
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height/2, width/2, height/2, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 6;
            ctx.stroke();

            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height/2, width/3, height/3, 0, 0, Math.PI * 2);
            ctx.stroke();

            ctx.fillStyle = '#4a2810';
            ctx.beginPath();
            ctx.arc(x + width/2, y + height/2, 15, 0, Math.PI * 2);
            ctx.fill();

            for (let i = 0; i < 8; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#c62828' : '#212121';
                ctx.beginPath();
                ctx.moveTo(x + width/2, y + height/2);
                ctx.arc(x + width/2, y + height/2, 12, (i * Math.PI/4), ((i+1) * Math.PI/4));
                ctx.closePath();
                ctx.fill();
            }
        }

        function drawBlackjackTable(obj) {
            const { x, y, width, height } = obj;

            ctx.fillStyle = '#0a5c0a';
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height, width/2, height, 0, Math.PI, 0);
            ctx.fill();

            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 5;
            ctx.stroke();

            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height, width/2.5, height * 0.7, 0, Math.PI, 0);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(x + 15 + i * 22, y + height - 30, 16, 22);
            }
        }

        function drawPillar(obj) {
            const { x, y, width, height } = obj;

            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x - 5, y + height - 10, width + 10, 15);

            const gradient = ctx.createLinearGradient(x, 0, x + width, 0);
            gradient.addColorStop(0, '#daa520');
            gradient.addColorStop(0.3, '#ffd700');
            gradient.addColorStop(0.7, '#ffd700');
            gradient.addColorStop(1, '#b8860b');
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, width, height);

            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x - 5, y - 5, width + 10, 15);

            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(x + width/2, y - 10, 8, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawPlant(obj) {
            const { x, y, width, height } = obj;

            ctx.fillStyle = '#8b4513';
            ctx.beginPath();
            ctx.moveTo(x + 5, y + height - 20);
            ctx.lineTo(x + width - 5, y + height - 20);
            ctx.lineTo(x + width - 10, y + height);
            ctx.lineTo(x + 10, y + height);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = '#a0522d';
            ctx.fillRect(x + 2, y + height - 25, width - 4, 8);

            ctx.fillStyle = '#228b22';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.ellipse(x + width/2 + Math.cos(i * 1.2) * 12, y + 15 + Math.sin(i * 0.8) * 8, 12, 8, i * 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(x + width/2, y + 8, 5, 0, Math.PI * 2);
            ctx.arc(x + width/2 - 10, y + 15, 4, 0, Math.PI * 2);
            ctx.arc(x + width/2 + 10, y + 12, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawFountain(obj) {
            const { x, y, width, height } = obj;
            const centerX = x + width / 2;
            const centerY = y + height / 2;

            ctx.fillStyle = '#1565c0';
            ctx.beginPath();
            ctx.ellipse(centerX, centerY + 20, width/2, height/3, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'rgba(100, 200, 255, 0.5)';
            for (let i = 0; i < 5; i++) {
                const shimmerX = centerX + Math.cos(gameTime / 10 + i) * 20;
                const shimmerY = centerY + 15 + Math.sin(gameTime / 10 + i) * 10;
                ctx.beginPath();
                ctx.ellipse(shimmerX, shimmerY, 8, 4, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.ellipse(centerX, centerY + 20, width/2, height/3, 0, 0, Math.PI * 2);
            ctx.stroke();

            ctx.fillStyle = '#ffd700';
            ctx.fillRect(centerX - 8, centerY - 15, 16, 35);

            ctx.beginPath();
            ctx.arc(centerX, centerY - 20, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#b8860b';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('$', centerX, centerY - 16);

            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2 + gameTime / 30;
                const dist = 15 + Math.sin(gameTime / 5 + i * 2) * 5;
                const dropY = centerY - 10 + Math.abs(Math.sin(gameTime / 5 + i * 2)) * 25;
                const dropX = centerX + Math.cos(angle) * dist;

                ctx.fillStyle = 'rgba(100, 200, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(dropX, dropY, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawBar(obj) {
            const { x, y, width, height } = obj;

            ctx.fillStyle = '#5d4037';
            ctx.fillRect(x, y, width, height);

            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x - 5, y - 5, width + 10, 10);

            ctx.strokeStyle = '#4e342e';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(x, y + 10 + i * 10);
                ctx.lineTo(x + width, y + 10 + i * 10);
                ctx.stroke();
            }

            const bottleColors = ['#c62828', '#2e7d32', '#1565c0', '#ff9800', '#9c27b0'];
            for (let i = 0; i < 5; i++) {
                const bx = x + 10 + i * 16;
                const by = y + 5;

                ctx.fillStyle = bottleColors[i];
                ctx.fillRect(bx, by, 10, 20);
                ctx.fillRect(bx + 2, by - 6, 6, 8);
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(bx + 2, by - 8, 6, 3);
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(bx + 2, by + 2, 2, 12);
            }
        }

        function drawShark(obj) {
            const { x, y, width, height } = obj;
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            const bob = Math.sin(gameTime / 15) * 3;

            ctx.save();
            ctx.translate(centerX, centerY + bob);

            // When chasing, face toward player
            if (sharkChaseStarted) {
                const facingLeft = player.x < centerX;
                if (facingLeft) {
                    ctx.scale(-1, 1);
                }
                // Angry red glow
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 20;
            }

            // Body - blue-grey shark
            ctx.fillStyle = '#4a6fa5';
            ctx.beginPath();
            ctx.ellipse(0, 0, 28, 18, 0, 0, Math.PI * 2);
            ctx.fill();

            // Lighter underbelly
            ctx.fillStyle = '#b8c9e0';
            ctx.beginPath();
            ctx.ellipse(0, 6, 20, 10, 0, 0, Math.PI);
            ctx.fill();

            // Dorsal fin
            ctx.fillStyle = '#3a5a8a';
            ctx.beginPath();
            ctx.moveTo(-5, -18);
            ctx.lineTo(0, -30);
            ctx.lineTo(8, -18);
            ctx.closePath();
            ctx.fill();

            // Tail fin
            ctx.fillStyle = '#3a5a8a';
            ctx.beginPath();
            ctx.moveTo(-28, 0);
            ctx.lineTo(-42, -12);
            ctx.lineTo(-42, 12);
            ctx.closePath();
            ctx.fill();

            // Side fin
            ctx.fillStyle = '#4a6fa5';
            ctx.beginPath();
            ctx.moveTo(10, 8);
            ctx.lineTo(22, 18);
            ctx.lineTo(8, 14);
            ctx.closePath();
            ctx.fill();

            // Snout
            ctx.fillStyle = '#5a7faa';
            ctx.beginPath();
            ctx.moveTo(28, 0);
            ctx.lineTo(40, 2);
            ctx.lineTo(28, 5);
            ctx.closePath();
            ctx.fill();

            // Eye - red and angry when chasing
            if (sharkChaseStarted) {
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(18, -5, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(19, -5, 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(18, -5, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(19, -6, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.shadowBlur = 0;

            // Menacing grin with teeth
            ctx.fillStyle = '#2a3a5a';
            ctx.beginPath();
            ctx.moveTo(15, 5);
            ctx.quadraticCurveTo(25, 10, 35, 5);
            ctx.lineTo(35, 8);
            ctx.quadraticCurveTo(25, 13, 15, 8);
            ctx.closePath();
            ctx.fill();

            // Teeth
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(17 + i * 4, 5);
                ctx.lineTo(18 + i * 4, 9);
                ctx.lineTo(19 + i * 4, 5);
                ctx.closePath();
                ctx.fill();
            }

            ctx.restore();

            // Briefcase beside shark
            ctx.fillStyle = '#4e342e';
            ctx.fillRect(x + width + 5, y + height - 20, 20, 15);
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(x + width + 10, y + height - 18, 10, 2);
            ctx.fillRect(x + width + 13, y + height - 21, 4, 3);

            // Gold coins spilling out
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(x + width + 28, y + height - 10, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + width + 35, y + height - 8, 4, 0, Math.PI * 2);
            ctx.fill();

            // Sign above shark
            ctx.fillStyle = '#8b0000';
            ctx.fillRect(x - 5, y - 25, width + 30, 18);
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.strokeRect(x - 5, y - 25, width + 30, 18);
            ctx.fillStyle = '#ffd700';
            ctx.font = '8px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('LOANS', x + width / 2 + 10, y - 12);
        }

        function drawNPC(npc) {
            const { x, y, direction, type, bobPhase } = npc;
            const bob = Math.sin(gameTime / 20 + bobPhase) * 2;

            let bodyColor, headColor, hairColor, pantsColor;

            switch(type) {
                case 'dealer':
                    bodyColor = '#1a1a1a'; headColor = '#ffcc99'; hairColor = '#1a1a1a'; pantsColor = '#1a1a1a';
                    break;
                case 'security':
                    bodyColor = '#2c3e50'; headColor = '#8b6914'; hairColor = '#1a1a1a'; pantsColor = '#1a1a1a';
                    break;
                case 'bartender':
                    bodyColor = '#ffffff'; headColor = '#ffcc99'; hairColor = '#8b4513'; pantsColor = '#1a1a1a';
                    break;
                case 'drunk':
                    bodyColor = '#ff6b6b'; headColor = '#ffcccc'; hairColor = '#d4a574'; pantsColor = '#8b7355';
                    break;
                case 'sushi_chef':
                    bodyColor = '#ffffff'; headColor = '#ffe4c4'; hairColor = '#1a1a1a'; pantsColor = '#1a1a1a';
                    break;
                case 'businessman':
                    bodyColor = '#34495e'; headColor = '#ffcc99'; hairColor = '#2c2c2c'; pantsColor = '#2c3e50';
                    break;
                case 'tourist':
                    bodyColor = '#ff9800'; headColor = '#ffe4c4'; hairColor = '#ffd700'; pantsColor = '#4a6fa5';
                    break;
                case 'cat':
                    bodyColor = '#ff9800'; headColor = '#ffb74d'; hairColor = '#ff9800'; pantsColor = '#ff9800';
                    break;
                default:
                    // Random variety for player_npc type based on bobPhase
                    const variants = [
                        { body: '#4a90d9', hair: '#4a3728', pants: '#2c3e50' },
                        { body: '#9c27b0', hair: '#1a1a1a', pants: '#1a1a1a' },
                        { body: '#4caf50', hair: '#8b4513', pants: '#5d4037' },
                        { body: '#ff5722', hair: '#d4a574', pants: '#3e2723' },
                        { body: '#e91e63', hair: '#ffd700', pants: '#1a1a1a' },
                    ];
                    const v = variants[bobPhase % variants.length];
                    bodyColor = v.body; headColor = '#ffcc99'; hairColor = v.hair; pantsColor = v.pants;
            }

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 16, y + 30, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            const drawY = y + bob;

            // Body/shirt
            ctx.fillStyle = bodyColor;
            ctx.fillRect(x + 6, drawY + 14, 20, 14);

            // Pants
            ctx.fillStyle = pantsColor;
            ctx.fillRect(x + 8, drawY + 26, 6, 6);
            ctx.fillRect(x + 18, drawY + 26, 6, 6);

            // Head
            ctx.fillStyle = headColor;
            ctx.fillRect(x + 8, drawY + 2, 16, 14);

            // Hair
            ctx.fillStyle = type === 'cat' ? '#ff9800' : hairColor;
            ctx.fillRect(x + 8, drawY, 16, 6);

            ctx.fillStyle = '#000';
            if (direction === 'down') {
                if (type === 'cat') {
                    // Cat eyes - happy (closed ^_^) or normal
                    if (catHappy) {
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x + 12, drawY + 9, 3, Math.PI, 0);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.arc(x + 20, drawY + 9, 3, Math.PI, 0);
                        ctx.stroke();
                    } else {
                        ctx.fillRect(x + 11, drawY + 7, 2, 4);
                        ctx.fillRect(x + 19, drawY + 7, 2, 4);
                    }
                } else {
                    ctx.fillRect(x + 11, drawY + 8, 3, 3);
                    ctx.fillRect(x + 18, drawY + 8, 3, 3);
                }
                if (type !== 'cat') {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(x + 12, drawY + 8, 1, 1);
                    ctx.fillRect(x + 19, drawY + 8, 1, 1);
                }
            }

            if (type === 'cat') {
                ctx.fillStyle = '#ff9800';
                ctx.beginPath();
                ctx.moveTo(x + 8, drawY + 2);
                ctx.lineTo(x + 6, drawY - 8);
                ctx.lineTo(x + 14, drawY + 2);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(x + 18, drawY + 2);
                ctx.lineTo(x + 26, drawY - 8);
                ctx.lineTo(x + 24, drawY + 2);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#ff69b4';
                ctx.beginPath();
                ctx.arc(x + 16, drawY + 12, 2, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#ff9800';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x + 26, drawY + 25);
                const tailWag = Math.sin(gameTime / 8 + bobPhase) * 5;
                ctx.quadraticCurveTo(x + 35 + tailWag, drawY + 20, x + 38, drawY + 10 + tailWag);
                ctx.stroke();
            } else if (type === 'dealer') {
                // Red bow tie
                ctx.fillStyle = '#c62828';
                ctx.fillRect(x + 12, drawY + 14, 8, 4);
            } else if (type === 'bartender') {
                // Bow tie
                ctx.fillStyle = '#1a1a1a';
                ctx.beginPath();
                ctx.moveTo(x + 13, drawY + 15);
                ctx.lineTo(x + 16, drawY + 17);
                ctx.lineTo(x + 19, drawY + 15);
                ctx.lineTo(x + 16, drawY + 19);
                ctx.closePath();
                ctx.fill();
            } else if (type === 'sushi_chef') {
                // Chef headband
                ctx.fillStyle = '#c62828';
                ctx.fillRect(x + 6, drawY + 2, 20, 3);
            } else if (type === 'security') {
                // Badge
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(x + 10, drawY + 18, 4, 0, Math.PI * 2);
                ctx.fill();
            } else if (type === 'tourist') {
                // Camera
                ctx.fillStyle = '#333';
                ctx.fillRect(x + 22, drawY + 18, 8, 6);
                ctx.fillStyle = '#1a1a1a';
                ctx.beginPath();
                ctx.arc(x + 26, drawY + 21, 2, 0, Math.PI * 2);
                ctx.fill();
            } else if (type === 'businessman') {
                // Tie
                ctx.fillStyle = '#c62828';
                ctx.beginPath();
                ctx.moveTo(x + 14, drawY + 14);
                ctx.lineTo(x + 18, drawY + 14);
                ctx.lineTo(x + 17, drawY + 26);
                ctx.lineTo(x + 15, drawY + 26);
                ctx.closePath();
                ctx.fill();
            }

            if (type !== 'cat' && direction === 'down') {
                ctx.fillStyle = '#ffb6c1';
                ctx.fillRect(x + 8, drawY + 11, 3, 2);
                ctx.fillRect(x + 21, drawY + 11, 3, 2);
            }
        }

        function drawPlayer() {
            const { x, y, direction, frame } = player;

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 16, y + 30, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Nice dress shirt (light blue button-up)
            ctx.fillStyle = '#5ba3d9';
            ctx.fillRect(x + 6, y + 14, 20, 18);
            // Shirt collar
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(x + 10, y + 14);
            ctx.lineTo(x + 14, y + 18);
            ctx.lineTo(x + 18, y + 14);
            ctx.lineTo(x + 22, y + 14);
            ctx.lineTo(x + 18, y + 20);
            ctx.lineTo(x + 14, y + 16);
            ctx.lineTo(x + 10, y + 20);
            ctx.lineTo(x + 6, y + 14);
            ctx.closePath();
            ctx.fill();
            // Shirt buttons
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 15, y + 21, 2, 2);
            ctx.fillRect(x + 15, y + 26, 2, 2);

            // Nice dark slacks
            const legOffset = Math.sin(frame * 0.3) * 2;
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(x + 8, y + 28, 6, 6 + (keys['ArrowDown'] || keys['ArrowUp'] ? legOffset : 0));
            ctx.fillRect(x + 18, y + 28, 6, 6 - (keys['ArrowDown'] || keys['ArrowUp'] ? legOffset : 0));

            // Face
            ctx.fillStyle = '#ffcc99';
            ctx.fillRect(x + 8, y + 2, 16, 14);

            // Short black hair (styled, clean cut)
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(x + 7, y - 2, 18, 6);
            // Slight side part
            ctx.fillRect(x + 6, y + 1, 4, 4);
            ctx.fillRect(x + 22, y + 1, 4, 4);

            // Eyes - simple black dots
            ctx.fillStyle = '#000';
            if (direction === 'down') {
                ctx.fillRect(x + 11, y + 8, 3, 3);
                ctx.fillRect(x + 18, y + 8, 3, 3);
            } else if (direction === 'left') {
                ctx.fillRect(x + 10, y + 8, 3, 3);
            } else if (direction === 'right') {
                ctx.fillRect(x + 19, y + 8, 3, 3);
            }

            // Draw drink if holding one (no arms, drink just floats next to character)
            if (player.holdingDrink) {
                const drinkX = x + 27;
                const drinkY = y + 18;

                if (player.holdingDrink === 'shirley') {
                    // Shirley Temple - tall glass with red drink and cherry
                    ctx.fillStyle = 'rgba(255, 100, 100, 0.8)';
                    ctx.fillRect(drinkX - 4, drinkY, 8, 14);
                    ctx.strokeStyle = '#c0c0c0';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(drinkX - 4, drinkY, 8, 14);
                    // Bubbles
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.beginPath();
                    ctx.arc(drinkX - 1, drinkY + 8, 1, 0, Math.PI * 2);
                    ctx.arc(drinkX + 2, drinkY + 5, 1, 0, Math.PI * 2);
                    ctx.fill();
                    // Cherry on top
                    ctx.fillStyle = '#c62828';
                    ctx.beginPath();
                    ctx.arc(drinkX, drinkY - 2, 3, 0, Math.PI * 2);
                    ctx.fill();
                    // Cherry stem
                    ctx.strokeStyle = '#4caf50';
                    ctx.beginPath();
                    ctx.moveTo(drinkX, drinkY - 4);
                    ctx.lineTo(drinkX + 2, drinkY - 7);
                    ctx.stroke();
                } else if (player.holdingDrink === 'cosmo') {
                    // Cosmopolitan - martini glass with pink drink
                    ctx.fillStyle = '#c0c0c0';
                    ctx.beginPath();
                    ctx.moveTo(drinkX, drinkY);
                    ctx.lineTo(drinkX + 8, drinkY + 10);
                    ctx.lineTo(drinkX - 8, drinkY + 10);
                    ctx.closePath();
                    ctx.fill();
                    // Pink drink
                    ctx.fillStyle = 'rgba(255, 105, 180, 0.8)';
                    ctx.beginPath();
                    ctx.moveTo(drinkX, drinkY + 2);
                    ctx.lineTo(drinkX + 6, drinkY + 9);
                    ctx.lineTo(drinkX - 6, drinkY + 9);
                    ctx.closePath();
                    ctx.fill();
                    // Stem
                    ctx.fillStyle = '#c0c0c0';
                    ctx.fillRect(drinkX - 1, drinkY + 10, 2, 6);
                    ctx.fillRect(drinkX - 4, drinkY + 15, 8, 2);
                    // Lime wedge
                    ctx.fillStyle = '#7cb342';
                    ctx.beginPath();
                    ctx.arc(drinkX + 5, drinkY + 3, 3, 0, Math.PI);
                    ctx.fill();
                } else if (player.holdingDrink === 'maitai') {
                    // Mai Tai - tiki glass with orange drink and umbrella
                    ctx.fillStyle = 'rgba(255, 140, 0, 0.8)';
                    ctx.beginPath();
                    ctx.moveTo(drinkX - 5, drinkY);
                    ctx.lineTo(drinkX - 3, drinkY + 14);
                    ctx.lineTo(drinkX + 3, drinkY + 14);
                    ctx.lineTo(drinkX + 5, drinkY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#8b4513';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    // Paper umbrella
                    ctx.fillStyle = '#ff4081';
                    ctx.beginPath();
                    ctx.moveTo(drinkX - 1, drinkY - 6);
                    ctx.lineTo(drinkX + 6, drinkY);
                    ctx.lineTo(drinkX - 1, drinkY);
                    ctx.closePath();
                    ctx.fill();
                    // Umbrella stick
                    ctx.strokeStyle = '#8b4513';
                    ctx.beginPath();
                    ctx.moveTo(drinkX - 1, drinkY - 6);
                    ctx.lineTo(drinkX - 1, drinkY + 5);
                    ctx.stroke();
                    // Pineapple wedge
                    ctx.fillStyle = '#ffd54f';
                    ctx.fillRect(drinkX + 2, drinkY - 3, 4, 5);
                    ctx.fillStyle = '#4caf50';
                    ctx.beginPath();
                    ctx.moveTo(drinkX + 4, drinkY - 3);
                    ctx.lineTo(drinkX + 6, drinkY - 6);
                    ctx.lineTo(drinkX + 2, drinkY - 6);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        function drawInteractionIndicator() {
            if (!nearObject) return;

            const obj = nearObject;
            const centerX = obj.x + obj.width / 2;
            const bounce = Math.sin(Date.now() / 200) * 3;

            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.moveTo(centerX, obj.y - 20 + bounce);
            ctx.lineTo(centerX - 10, obj.y - 35 + bounce);
            ctx.lineTo(centerX + 10, obj.y - 35 + bounce);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = '#fff';
            for (let i = 0; i < 4; i++) {
                const angle = Date.now() / 500 + i * Math.PI / 2;
                const sx = centerX + Math.cos(angle) * 25;
                const sy = obj.y - 25 + Math.sin(angle) * 10;
                ctx.beginPath();
                ctx.arc(sx, sy, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ==================== GAME LOGIC ====================
        function checkCollision(newX, newY) {
            const playerBounds = { x: newX + 8, y: newY + 20, width: 16, height: 12 };
            const currentObjects = getCurrentObjects();

            for (const obj of currentObjects) {
                if (playerBounds.x < obj.x + obj.width &&
                    playerBounds.x + playerBounds.width > obj.x &&
                    playerBounds.y < obj.y + obj.height &&
                    playerBounds.y + playerBounds.height > obj.y) {
                    return true;
                }
            }

            // Check room boundaries - allow exit through openings
            const room = rooms[currentRoom];
            if (newX < 10 && !room.exits.left) return true;
            if (newX > 760 && !room.exits.right) return true;
            if (newY < 50 && !room.exits.up) return true;
            if (newY > 560 && !room.exits.down) return true;

            // Keep player within screen bounds generally (but allow edge movement for transitions)
            if (newX < -20 || newX > 790 || newY < 30 || newY > 580) {
                return true;
            }

            return false;
        }

        function checkNearObject() {
            nearObject = null;
            nearNPC = null;
            const interactDist = 60;
            const npcInteractDist = 50;

            // Check objects
            const currentObjects = getCurrentObjects();
            for (const obj of currentObjects) {
                const nonInteractive = ['pillar', 'plant', 'fountain', 'lounge_table', 'sushi_table', 'bonsai', 'aquarium', 'lucky_cat', 'jukebox'];
                if (nonInteractive.includes(obj.type)) continue;

                const dx = (player.x + 16) - (obj.x + obj.width / 2);
                const dy = (player.y + 16) - (obj.y + obj.height / 2);
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < interactDist) {
                    nearObject = obj;
                    break;
                }
            }

            // Check NPCs if no object is near
            if (!nearObject) {
                const currentNPCList = getCurrentNPCs();
                for (const npc of currentNPCList) {
                    const dx = (player.x + 16) - (npc.x + 16);
                    const dy = (player.y + 16) - (npc.y + 16);
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < npcInteractDist) {
                        nearNPC = npc;
                        break;
                    }
                }
            }

            const hint = document.getElementById('interactHint');
            if (nearObject) {
                hint.style.display = 'block';
                if (nearObject.type === 'shark') {
                    hint.textContent = 'SPACE to talk!';
                } else if (nearObject.type === 'bar_counter') {
                    hint.textContent = 'SPACE for drinks!';
                } else if (nearObject.type === 'sushi_bar') {
                    hint.textContent = 'SPACE for sushi!';
                } else if (nearObject.type === 'arcade') {
                    hint.textContent = 'SPACE for PONG!';
                } else {
                    hint.textContent = 'SPACE to play!';
                }
            } else if (nearNPC) {
                hint.style.display = 'block';
                if (nearNPC.action === 'pet') {
                    hint.textContent = 'SPACE to pet';
                } else if (nearNPC.action === 'drink_menu') {
                    hint.textContent = 'SPACE to order!';
                } else if (nearNPC.action === 'sushi_menu') {
                    hint.textContent = 'SPACE to order!';
                } else {
                    hint.textContent = 'SPACE to talk!';
                }
            } else {
                hint.style.display = 'none';
            }
        }

        function updatePlayer() {
            if (currentMinigame) return;

            let dx = 0, dy = 0;

            if (keys['ArrowUp'] || keys['w'] || keys['W']) { dy = -player.speed; player.direction = 'up'; }
            if (keys['ArrowDown'] || keys['s'] || keys['S']) { dy = player.speed; player.direction = 'down'; }
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) { dx = -player.speed; player.direction = 'left'; }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) { dx = player.speed; player.direction = 'right'; }

            if (dx !== 0 || dy !== 0) {
                player.frameTimer++;
                if (player.frameTimer > 5) {
                    player.frame++;
                    player.frameTimer = 0;
                }

                if (!checkCollision(player.x + dx, player.y)) player.x += dx;
                if (!checkCollision(player.x, player.y + dy)) player.y += dy;
            }

            checkNearObject();
        }

        function spawnCoins(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 8 - 4,
                    life: 60 + Math.random() * 30,
                    rotation: Math.random() * Math.PI * 2
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.3;
                p.rotation += 0.2;
                p.life--;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation);
                const alpha = Math.min(1, p.life / 20);
                ctx.fillStyle = `rgba(255, 215, 0, ${alpha})`;
                ctx.beginPath();
                ctx.ellipse(0, 0, 6, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = `rgba(255, 255, 200, ${alpha * 0.5})`;
                ctx.beginPath();
                ctx.ellipse(-2, -1, 2, 1, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        function updateMoney(amount) {
            money += amount;
            if (money < 0) money = 0;
            document.getElementById('moneyDisplay').textContent = '$' + money.toLocaleString();
            document.getElementById('floatingAmount').textContent = '$' + money.toLocaleString();

            // Update debt display
            const debtEl = document.getElementById('floatingDebt');
            if (debt > 0) {
                debtEl.textContent = 'DEBT: $' + debt.toLocaleString();
                debtEl.classList.add('active');
            } else {
                debtEl.classList.remove('active');
            }

            if (amount > 0 && amount >= 100) {
                spawnCoins(player.x + 16, player.y, Math.min(20, Math.floor(amount / 100)));
            }

            // Must have $1M AND no debt to win
            if (money >= GOAL && debt === 0) {
                showWinScreen();
            }
        }

        function showWinScreen() {
            const winScreen = document.getElementById('winScreen');
            winScreen.style.display = 'flex';
            document.getElementById('finalAmount').textContent = '$' + money.toLocaleString();

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = ['#ff0', '#f0f', '#0ff', '#f00', '#0f0', '#ffd700'][Math.floor(Math.random() * 6)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                winScreen.appendChild(confetti);
            }
        }

        function resetGame() {
            money = 10000;
            debt = 0;
            updateMoney(0);
            document.getElementById('winScreen').style.display = 'none';
            document.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        // ==================== PONG GAME FUNCTIONS ====================
        let pongCanvas, pongCtx;
        let pongBall = { x: 300, y: 200, vx: 5, vy: 3, radius: 8 };
        let pongPlayer = { x: 20, y: 170, width: 10, height: 60 };
        let pongCpu = { x: 570, y: 170, width: 10, height: 60 };
        let pongPlayerScore = 0;
        let pongCpuScore = 0;
        let pongRunning = false;
        let pongAnimationId = null;
        let pongKeys = { up: false, down: false };

        function initPong() {
            pongCanvas = document.getElementById('pongCanvas');
            pongCtx = pongCanvas.getContext('2d');
            pongPlayerScore = 0;
            pongCpuScore = 0;
            pongRunning = false;
            document.getElementById('pongPlayerScore').textContent = '0';
            document.getElementById('pongCpuScore').textContent = '0';
            document.getElementById('pongMessage').textContent = 'Press SPACE to start!';
            resetPongBall();
            drawPong();
        }

        function resetPongBall() {
            pongBall.x = 300;
            pongBall.y = 200;
            pongBall.vx = (Math.random() > 0.5 ? 5 : -5);
            pongBall.vy = (Math.random() - 0.5) * 6;
            pongPlayer.y = 170;
            pongCpu.y = 170;
        }

        function startPong() {
            if (pongRunning) return;
            pongRunning = true;
            document.getElementById('pongMessage').textContent = '';
            pongLoop();
        }

        function pongLoop() {
            if (!pongRunning) return;
            updatePong();
            drawPong();
            pongAnimationId = requestAnimationFrame(pongLoop);
        }

        function updatePong() {
            // Player paddle movement
            if (pongKeys.up && pongPlayer.y > 0) {
                pongPlayer.y -= 6;
            }
            if (pongKeys.down && pongPlayer.y < 400 - pongPlayer.height) {
                pongPlayer.y += 6;
            }

            // CPU AI - follows ball with some delay/imperfection
            const cpuCenter = pongCpu.y + pongCpu.height / 2;
            const cpuSpeed = 4;
            if (pongBall.y < cpuCenter - 10) {
                pongCpu.y -= cpuSpeed;
            } else if (pongBall.y > cpuCenter + 10) {
                pongCpu.y += cpuSpeed;
            }
            pongCpu.y = Math.max(0, Math.min(400 - pongCpu.height, pongCpu.y));

            // Ball movement
            pongBall.x += pongBall.vx;
            pongBall.y += pongBall.vy;

            // Top/bottom wall collision
            if (pongBall.y - pongBall.radius < 0 || pongBall.y + pongBall.radius > 400) {
                pongBall.vy *= -1;
                pongBall.y = Math.max(pongBall.radius, Math.min(400 - pongBall.radius, pongBall.y));
            }

            // Player paddle collision
            if (pongBall.x - pongBall.radius < pongPlayer.x + pongPlayer.width &&
                pongBall.x + pongBall.radius > pongPlayer.x &&
                pongBall.y > pongPlayer.y &&
                pongBall.y < pongPlayer.y + pongPlayer.height) {
                pongBall.vx = Math.abs(pongBall.vx) * 1.05; // Speed up slightly
                const hitPos = (pongBall.y - pongPlayer.y) / pongPlayer.height;
                pongBall.vy = (hitPos - 0.5) * 10;
                pongBall.x = pongPlayer.x + pongPlayer.width + pongBall.radius;
            }

            // CPU paddle collision
            if (pongBall.x + pongBall.radius > pongCpu.x &&
                pongBall.x - pongBall.radius < pongCpu.x + pongCpu.width &&
                pongBall.y > pongCpu.y &&
                pongBall.y < pongCpu.y + pongCpu.height) {
                pongBall.vx = -Math.abs(pongBall.vx) * 1.05;
                const hitPos = (pongBall.y - pongCpu.y) / pongCpu.height;
                pongBall.vy = (hitPos - 0.5) * 10;
                pongBall.x = pongCpu.x - pongBall.radius;
            }

            // Scoring
            if (pongBall.x < 0) {
                pongCpuScore++;
                document.getElementById('pongCpuScore').textContent = pongCpuScore;
                checkPongWin();
                resetPongBall();
            } else if (pongBall.x > 600) {
                pongPlayerScore++;
                document.getElementById('pongPlayerScore').textContent = pongPlayerScore;
                checkPongWin();
                resetPongBall();
            }

            // Cap ball speed
            const maxSpeed = 12;
            pongBall.vx = Math.sign(pongBall.vx) * Math.min(Math.abs(pongBall.vx), maxSpeed);
        }

        function checkPongWin() {
            if (pongPlayerScore >= 5) {
                pongRunning = false;
                document.getElementById('pongMessage').textContent = 'YOU WIN! Press SPACE to play again';
                updateMoney(1000);
            } else if (pongCpuScore >= 5) {
                pongRunning = false;
                document.getElementById('pongMessage').textContent = 'CPU WINS! Press SPACE to play again';
            }
        }

        function drawPong() {
            pongCtx.fillStyle = '#000';
            pongCtx.fillRect(0, 0, 600, 400);

            // Center line
            pongCtx.strokeStyle = '#00ff00';
            pongCtx.setLineDash([10, 10]);
            pongCtx.beginPath();
            pongCtx.moveTo(300, 0);
            pongCtx.lineTo(300, 400);
            pongCtx.stroke();
            pongCtx.setLineDash([]);

            // Paddles
            pongCtx.fillStyle = '#00ff00';
            pongCtx.fillRect(pongPlayer.x, pongPlayer.y, pongPlayer.width, pongPlayer.height);
            pongCtx.fillRect(pongCpu.x, pongCpu.y, pongCpu.width, pongCpu.height);

            // Ball
            pongCtx.beginPath();
            pongCtx.arc(pongBall.x, pongBall.y, pongBall.radius, 0, Math.PI * 2);
            pongCtx.fill();
        }

        function stopPong() {
            pongRunning = false;
            if (pongAnimationId) {
                cancelAnimationFrame(pongAnimationId);
                pongAnimationId = null;
            }
        }

        // Pong key handlers
        document.addEventListener('keydown', (e) => {
            if (currentMinigame === 'arcade') {
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                    pongKeys.up = true;
                    e.preventDefault();
                }
                if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                    pongKeys.down = true;
                    e.preventDefault();
                }
                if (e.key === ' ') {
                    e.preventDefault();
                    if (!pongRunning) {
                        if (pongPlayerScore >= 5 || pongCpuScore >= 5) {
                            pongPlayerScore = 0;
                            pongCpuScore = 0;
                            document.getElementById('pongPlayerScore').textContent = '0';
                            document.getElementById('pongCpuScore').textContent = '0';
                        }
                        startPong();
                    }
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                pongKeys.up = false;
            }
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                pongKeys.down = false;
            }
        });

        // ==================== SHARK LOAN FUNCTIONS ====================
        let currentSharkNode = 'start';

        function openSharkDialog() {
            sharkDialogOpen = true;
            currentSharkNode = 'start';
            document.getElementById('sharkDialog').classList.add('active');
            document.getElementById('loanOptions').classList.remove('active');
            showSharkNode('start');
        }

        function closeSharkDialog() {
            sharkDialogOpen = false;
            document.getElementById('sharkDialog').classList.remove('active');
        }

        function showSharkNode(nodeId) {
            const node = sharkDialogTree[nodeId];
            if (!node) return;

            document.getElementById('sharkText').textContent = node.text;
            const choicesContainer = document.getElementById('sharkChoices');
            choicesContainer.innerHTML = '';

            if (node.choices === 'loan_options') {
                // Show loan options
                choicesContainer.style.display = 'none';
                document.getElementById('loanOptions').classList.add('active');
                updatePayBackButton();
            } else if (node.choices === 'close') {
                // Auto close after delay
                choicesContainer.innerHTML = '<button class="shark-btn" onclick="closeSharkDialog()">Bye Finley!</button>';
                choicesContainer.style.display = 'flex';
            } else if (Array.isArray(node.choices)) {
                // Show choice buttons
                choicesContainer.style.display = 'flex';
                node.choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'shark-btn';
                    btn.textContent = choice.label;
                    btn.onclick = () => showSharkNode(choice.next);
                    choicesContainer.appendChild(btn);
                });
            }
        }

        function takeLoan(amount) {
            money += amount;
            debt += amount;
            document.getElementById('moneyDisplay').textContent = '$' + money.toLocaleString();
            document.getElementById('floatingAmount').textContent = '$' + money.toLocaleString();

            // Update debt display
            const debtEl = document.getElementById('floatingDebt');
            debtEl.textContent = 'DEBT: $' + debt.toLocaleString();
            debtEl.classList.add('active');

            // Show funny response
            const responses = [
                "Pleasure doing business! *snaps fin*",
                "Smart fish! Now go make us both rich!",
                "Excellent choice! I knew I liked you!",
                "Remember, Finley ALWAYS collects...",
                "Don't forget about your ol' pal Finley!"
            ];
            document.getElementById('sharkText').textContent = responses[Math.floor(Math.random() * responses.length)];
            document.getElementById('loanOptions').classList.remove('active');

            setTimeout(() => {
                closeSharkDialog();
                spawnCoins(player.x + 16, player.y, 30);
            }, 1500);

            updatePayBackButton();
        }

        function payBackDebt() {
            if (money >= debt) {
                money -= debt;
                const paidAmount = debt;
                debt = 0;
                document.getElementById('moneyDisplay').textContent = '$' + money.toLocaleString();
                document.getElementById('floatingAmount').textContent = '$' + money.toLocaleString();
                document.getElementById('floatingDebt').classList.remove('active');

                document.getElementById('sharkText').textContent =
                    "You paid off $" + paidAmount.toLocaleString() + "! We're square, friend. Come back anytime!";
                document.getElementById('loanOptions').classList.remove('active');

                setTimeout(() => {
                    closeSharkDialog();
                    // Check win condition after paying debt
                    if (money >= GOAL && debt === 0) {
                        showWinScreen();
                    }
                }, 2000);
            } else {
                document.getElementById('sharkText').textContent =
                    "You don't have enough to pay me back! You owe $" + debt.toLocaleString() + " but only have $" + money.toLocaleString() + "...";
            }
            updatePayBackButton();
        }

        function updatePayBackButton() {
            const payBackBtn = document.getElementById('payBackBtn');
            if (debt > 0 && money >= debt) {
                payBackBtn.style.display = 'block';
                payBackBtn.textContent = 'Pay Back $' + debt.toLocaleString();
                payBackBtn.disabled = false;
            } else if (debt > 0) {
                payBackBtn.style.display = 'block';
                payBackBtn.textContent = 'Pay Back $' + debt.toLocaleString() + ' (need $' + (debt - money).toLocaleString() + ' more)';
                payBackBtn.disabled = true;
                payBackBtn.style.opacity = '0.5';
            } else {
                payBackBtn.style.display = 'none';
            }
        }

        // ==================== ROOM TRANSITION FUNCTIONS ====================
        function transitionToRoom(direction) {
            const room = rooms[currentRoom];
            const targetRoom = room.exits[direction];
            if (!targetRoom || roomTransitioning) return;

            roomTransitioning = true;
            const transition = document.getElementById('roomTransition');
            transition.classList.add('active');

            setTimeout(() => {
                currentRoom = targetRoom;
                // Position player based on entry direction
                if (direction === 'right') {
                    player.x = 30;
                    player.y = 300;
                } else if (direction === 'left') {
                    player.x = 740;
                    player.y = 300;
                } else if (direction === 'down') {
                    player.x = 400;
                    player.y = 70;
                } else if (direction === 'up') {
                    player.x = 400;
                    player.y = 530;
                }
                companion.x = player.x - 40;
                companion.y = player.y;

                // Show room name
                const roomNameEl = document.getElementById('roomName');
                roomNameEl.textContent = rooms[currentRoom].name;
                roomNameEl.classList.add('show');
                setTimeout(() => roomNameEl.classList.remove('show'), 2000);

                setTimeout(() => {
                    transition.classList.remove('active');
                    roomTransitioning = false;
                }, 300);
            }, 300);
        }

        function checkRoomTransition() {
            const room = rooms[currentRoom];
            if (!room.exits) return;

            // Check edges
            if (player.x > 760 && room.exits.right) {
                transitionToRoom('right');
            } else if (player.x < 20 && room.exits.left) {
                transitionToRoom('left');
            } else if (player.y > 560 && room.exits.down) {
                transitionToRoom('down');
            } else if (player.y < 50 && room.exits.up) {
                transitionToRoom('up');
            }
        }

        // ==================== NPC INTERACTION FUNCTIONS ====================
        let npcDialogOpen = false;
        let catHappy = false;

        function openNPCDialog(npc) {
            npcDialogOpen = true;
            const dialog = document.getElementById('npcDialog');
            const textEl = document.getElementById('npcDialogText');
            const buttonsEl = document.getElementById('npcDialogButtons');

            if (npc.action === 'pet') {
                catHappy = true;
                textEl.innerHTML = `<div style="font-size:24px"></div>${npc.interactText}`;
                buttonsEl.innerHTML = '<button class="npc-dialog-btn" onclick="closeNPCDialog()"></button>';
            } else if (npc.action === 'drink_menu') {
                // Show drink menu
                textEl.innerHTML = 'What\'ll it be, sugar?<br><small>(All drinks $20)</small>';
                buttonsEl.innerHTML = `
                    <button class="npc-dialog-btn gold" onclick="buyDrink('shirley')"> Shirley Temple<br><small style="font-size:6px">Ginger ale, grenadine, maraschino cherry</small></button>
                    <button class="npc-dialog-btn gold" onclick="buyDrink('cosmo')"> Cosmopolitan<br><small style="font-size:6px">Vodka, triple sec, cranberry, lime</small></button>
                    <button class="npc-dialog-btn gold" onclick="buyDrink('maitai')"> Mai Tai<br><small style="font-size:6px">Rum, lime juice, orgeat, curaao</small></button>
                    <button class="npc-dialog-btn" onclick="closeNPCDialog()">No thanks</button>
                `;
            } else if (npc.action === 'sushi_menu') {
                textEl.innerHTML = 'Irasshaimase!<br><small>Omakase: $250 per person ($500 for two)</small>';
                buttonsEl.innerHTML = `
                    <button class="npc-dialog-btn gold" onclick="buySushi()"> Order Omakase</button>
                    <button class="npc-dialog-btn" onclick="closeNPCDialog()">Just looking</button>
                `;
            } else {
                textEl.textContent = npc.interactText || "...";
                buttonsEl.innerHTML = '<button class="npc-dialog-btn" onclick="closeNPCDialog()">OK</button>';
            }

            dialog.classList.add('active');
        }

        function closeNPCDialog() {
            npcDialogOpen = false;
            document.getElementById('npcDialog').classList.remove('active');
        }

        function buyDrink(type) {
            if (money < 20) {
                document.getElementById('npcDialogText').textContent = "Sorry, you can't afford that!";
                return;
            }
            updateMoney(-20);
            player.holdingDrink = type;
            document.getElementById('npcDialogText').textContent = `Here's your ${type}! Enjoy!`;
            document.getElementById('npcDialogButtons').innerHTML = '<button class="npc-dialog-btn" onclick="closeNPCDialog()">Thanks!</button>';
        }

        let sushiEatingPhase = 0;
        let billySilentUntil = 0; // Frame time until Billy can speak randomly again

        function buySushi() {
            if (money < 500) {
                document.getElementById('npcDialogText').textContent = "Sorry, not enough for omakase! ($500)";
                return;
            }
            updateMoney(-500);
            closeNPCDialog();
            sushiEatingPhase = 1;
            billySilentUntil = gameTime + 300; // Silence Billy for 5 seconds during sushi
            showSushiSequence();
        }

        function showSushiSequence() {
            const billyBubble = document.getElementById('companionBubble');
            const fedeBubble = document.getElementById('fedeBubble');

            if (sushiEatingPhase === 1) {
                // Billy's reaction - show above companion
                billyBubble.textContent = "Qu rico!";
                billyBubble.style.left = (companion.x - 50) + 'px';
                billyBubble.style.top = (companion.y - 50) + 'px';
                billyBubble.classList.add('active');

                setTimeout(() => {
                    sushiEatingPhase = 2;
                    showSushiSequence();
                }, 2000);
            } else if (sushiEatingPhase === 2) {
                // Hide Billy's bubble
                billyBubble.classList.remove('active');

                // Fede's reaction - show above player
                fedeBubble.textContent = "Le falt salmn.";
                fedeBubble.style.left = (player.x - 50) + 'px';
                fedeBubble.style.top = (player.y - 50) + 'px';
                fedeBubble.classList.add('active');

                setTimeout(() => {
                    sushiEatingPhase = 0;
                    fedeBubble.classList.remove('active');
                }, 2000);
            }
        }

        // ==================== COMPANION FUNCTIONS ====================
        function updateCompanion() {
            // Update fear level based on debt
            if (debt > 100000) {
                companion.fearLevel = 2;
            } else if (debt > 0) {
                companion.fearLevel = 1;
            } else {
                companion.fearLevel = 0;
            }

            // Follow player (stay to the left)
            const targetX = player.x - 35;
            const targetY = player.y + 5;

            const dx = targetX - companion.x;
            const dy = targetY - companion.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > 5) {
                companion.x += dx * 0.08;
                companion.y += dy * 0.08;

                // Update direction based on movement
                if (Math.abs(dx) > Math.abs(dy)) {
                    companion.direction = dx > 0 ? 'right' : 'left';
                } else {
                    companion.direction = dy > 0 ? 'down' : 'up';
                }
            }

            // Random comments (skip if silenced during sushi)
            companionCommentTimer++;
            if (companionCommentTimer > 600 && Math.random() < 0.01 && gameTime > billySilentUntil) { // ~every 10 seconds average
                companionCommentTimer = 0;
                let commentList;
                if (companion.fearLevel === 2) {
                    commentList = companion.scaredComments;
                } else if (companion.fearLevel === 1) {
                    commentList = companion.worriedComments;
                } else {
                    commentList = companion.comments;
                }
                companionComment = commentList[Math.floor(Math.random() * commentList.length)];

                // Show bubble
                const bubble = document.getElementById('companionBubble');
                bubble.textContent = companionComment;
                bubble.style.left = (companion.x - 30) + 'px';
                bubble.style.top = (companion.y - 60) + 'px';
                bubble.classList.add('active');

                setTimeout(() => {
                    bubble.classList.remove('active');
                }, 3000);
            }
        }

        function drawCompanion() {
            const { x, y, direction, fearLevel } = companion;

            ctx.save();

            // Face color based on fear level
            let faceColor;
            if (fearLevel === 2) {
                faceColor = '#ddddee'; // Pale/scared
            } else if (fearLevel === 1) {
                faceColor = '#eeddcc'; // Worried
            } else {
                faceColor = '#ffcc99'; // Normal
            }

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 12, y + 28, 10, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // Plain grey t-shirt (casual, not dressed up)
            ctx.fillStyle = fearLevel === 2 ? '#666677' : (fearLevel === 1 ? '#777766' : '#708090');
            ctx.fillRect(x + 4, y + 12, 16, 15);
            // T-shirt neckline (simple round neck)
            ctx.fillStyle = faceColor;
            ctx.beginPath();
            ctx.arc(x + 12, y + 13, 4, 0, Math.PI);
            ctx.fill();

            // Jeans (blue denim)
            ctx.fillStyle = '#4a6fa5';
            ctx.fillRect(x + 5, y + 25, 6, 8);
            ctx.fillRect(x + 13, y + 25, 6, 8);

            // Head
            ctx.fillStyle = faceColor;
            ctx.beginPath();
            ctx.arc(x + 12, y + 8, 10, 0, Math.PI * 2);
            ctx.fill();

            // Black hair (messy when scared)
            ctx.fillStyle = '#1a1a1a';
            if (fearLevel === 2) {
                // Messy scared hair
                ctx.beginPath();
                ctx.arc(x + 12, y + 3, 8, Math.PI, 0);
                ctx.fill();
                ctx.fillRect(x + 4, y - 2, 3, 6);
                ctx.fillRect(x + 17, y - 2, 3, 6);
                ctx.fillRect(x + 10, y - 4, 4, 4);
            } else {
                ctx.beginPath();
                ctx.arc(x + 12, y + 4, 8, Math.PI, 0);
                ctx.fill();
            }

            // Eyes - simple dots
            ctx.fillStyle = '#000';
            if (fearLevel === 2) {
                // Wide scared eyes
                ctx.beginPath();
                ctx.arc(x + 8, y + 7, 3, 0, Math.PI * 2);
                ctx.arc(x + 16, y + 7, 3, 0, Math.PI * 2);
                ctx.fill();
                // Sweat drop
                ctx.fillStyle = '#88ccff';
                ctx.beginPath();
                ctx.ellipse(x + 20, y + 3, 2, 3, 0, 0, Math.PI * 2);
                ctx.fill();
            } else if (fearLevel === 1) {
                // Worried eyes
                ctx.beginPath();
                ctx.arc(x + 8, y + 8, 2, 0, Math.PI * 2);
                ctx.arc(x + 16, y + 8, 2, 0, Math.PI * 2);
                ctx.fill();
                // Worried eyebrows
                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + 5, y + 3);
                ctx.lineTo(x + 10, y + 5);
                ctx.moveTo(x + 19, y + 3);
                ctx.lineTo(x + 14, y + 5);
                ctx.stroke();
            } else {
                ctx.beginPath();
                ctx.arc(x + 8, y + 8, 2, 0, Math.PI * 2);
                ctx.arc(x + 16, y + 8, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Mouth
            ctx.strokeStyle = '#000';
            if (fearLevel === 2) {
                // Scared O mouth
                ctx.beginPath();
                ctx.arc(x + 12, y + 14, 2, 0, Math.PI * 2);
                ctx.stroke();
            } else if (fearLevel === 1) {
                // Worried frown
                ctx.beginPath();
                ctx.arc(x + 12, y + 15, 2, Math.PI, 0);
                ctx.stroke();
            } else {
                // Neutral line
                ctx.beginPath();
                ctx.moveTo(x + 10, y + 14);
                ctx.lineTo(x + 14, y + 14);
                ctx.stroke();
            }

            ctx.restore();
        }

        function openMinigame(type, theme) {
            currentMinigame = type;
            document.getElementById('minigameOverlay').style.display = 'flex';
            document.querySelectorAll('.minigame-container').forEach(c => c.classList.remove('active'));

            if (type === 'slots') {
                if (theme === 'zombie') {
                    currentSlotTheme = 'zombie';
                    document.getElementById('zombieSlotsGame').classList.add('active');
                    initializeZombieReels();
                } else if (theme === 'lucky7') {
                    currentSlotTheme = 'lucky7';
                    document.getElementById('lucky7SlotsGame').classList.add('active');
                    initializeLucky7Reels();
                } else {
                    currentSlotTheme = 'diamond';
                    document.getElementById('slotsGame').classList.add('active');
                    initializeReels();
                }
            } else if (type === 'roulette') {
                document.getElementById('rouletteGame').classList.add('active');
                initRouletteBoard();
                drawRouletteWheel();
            } else if (type === 'blackjack') {
                document.getElementById('blackjackGame').classList.add('active');
                resetBlackjack();
            } else if (type === 'arcade') {
                document.getElementById('pongGame').classList.add('active');
                initPong();
            }
        }

        function closeMinigame() {
            // Stop pong if it was running
            stopPong();
            // Reset Lucky 7 free spins state
            if (isLucky7AutoSpinning) {
                isLucky7AutoSpinning = false;
                lucky7FreeSpins = 0;
                stickyCloverPositions.clear();
                lucky7Multiplier = 1;
                lucky7AccumulatedWins = 0;
                clearFrozenClovers();
                document.getElementById('lucky7AutoIndicator').classList.remove('active');
            }
            currentMinigame = null;
            document.getElementById('minigameOverlay').style.display = 'none';
            document.querySelectorAll('.minigame-container').forEach(c => c.classList.remove('active'));
        }

        // ==================== SHARK CHASE FUNCTIONS ====================
        function getSharkObject() {
            // Find the shark object in the casino room
            return rooms.casino.objects.find(obj => obj.type === 'shark');
        }

        function updateSharkChase() {
            // Activate chase if debt > $600K
            if (debt > 600000 && !sharkChaseActive && !gameOver) {
                sharkChaseActive = true;
                sharkChaseTimer = 0; // Start 5-second timer (silent)
            }

            if (!sharkChaseActive || gameOver) return;

            // Wait 5 seconds (300 frames) before starting chase
            if (!sharkChaseStarted) {
                sharkChaseTimer++;
                if (sharkChaseTimer >= 300) {
                    sharkChaseStarted = true;
                }
                return;
            }

            // Only chase in casino room
            if (currentRoom !== 'casino') return;

            // Get the existing shark object and modify its position
            const shark = getSharkObject();
            if (!shark) return;

            // Move shark slowly toward player
            const speed = 1.2;
            const sharkCenterX = shark.x + shark.width / 2;
            const sharkCenterY = shark.y + shark.height / 2;
            const dx = player.x - sharkCenterX;
            const dy = player.y - sharkCenterY;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > 0) {
                shark.x += (dx / dist) * speed;
                shark.y += (dy / dist) * speed;
            }

            // Check collision with player
            const catchDist = 30;
            if (dist < catchDist) {
                triggerDeath();
            }
        }


        function triggerDeath() {
            gameOver = true;
            document.getElementById('deathScreen').classList.add('active');
        }

        function triggerWin() {
            gameWon = true;
            document.getElementById('winScreen').classList.add('active');
        }

        function checkWinCondition() {
            if (money >= 1000000 && !gameWon && !gameOver) {
                triggerWin();
            }
        }

        // ==================== MAIN GAME LOOP ====================
        function gameLoop() {
            if (gameOver || gameWon) {
                requestAnimationFrame(gameLoop);
                return;
            }
            gameTime++;

            // Check win condition
            checkWinCondition();

            // Draw room background
            const room = rooms[currentRoom];
            ctx.fillStyle = room.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawFloor();
            drawCeilingLights();

            // Get current room's objects
            const currentObjects = getCurrentObjects();
            const sortedObjects = [...currentObjects].sort((a, b) => a.y - b.y);

            sortedObjects.forEach(obj => {
                if (obj.type === 'slots') drawBigSlotMachine(obj);
                else if (obj.type === 'roulette') drawRouletteTable(obj);
                else if (obj.type === 'blackjack') drawBlackjackTable(obj);
                else if (obj.type === 'pillar') drawPillar(obj);
                else if (obj.type === 'plant') drawPlant(obj);
                else if (obj.type === 'fountain') drawFountain(obj);
                else if (obj.type === 'bar') drawBar(obj);
                else if (obj.type === 'shark') drawShark(obj);
                else if (obj.type === 'bar_counter') drawBarCounter(obj);
                else if (obj.type === 'lounge_table') drawLoungeTable(obj);
                else if (obj.type === 'jukebox') drawJukebox(obj);
                else if (obj.type === 'arcade') drawArcade(obj);
                else if (obj.type === 'sushi_bar') drawSushiBar(obj);
                else if (obj.type === 'sushi_table') drawSushiTable(obj);
                else if (obj.type === 'lucky_cat') drawLuckyCat(obj);
                else if (obj.type === 'aquarium') drawAquarium(obj);
                else if (obj.type === 'bonsai') drawBonsai(obj);
            });

            // Draw NPCs for current room
            const currentNPCList = getCurrentNPCs();
            currentNPCList.forEach(drawNPC);

            // Update and draw companion
            updateCompanion();
            drawCompanion();

            updatePlayer();
            drawPlayer();

            // Shark chase (if debt > $600K)
            updateSharkChase();

            // Check room transitions
            checkRoomTransition();

            updateParticles();
            drawParticles();

            drawInteractionIndicator();

            // Draw room-appropriate sign
            if (currentRoom === 'casino') {
                drawNeonSign();
            } else if (currentRoom === 'lounge') {
                drawLoungeSign();
            } else if (currentRoom === 'sushi') {
                drawSushiSign();
            }

            // Draw exit indicators
            drawExitIndicators();

            requestAnimationFrame(gameLoop);
        }

        // Draw functions for new room objects
        function drawBarCounter(obj) {
            const { x, y, width, height } = obj;
            // Counter top
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(x, y, width, height);
            // Wood grain pattern
            ctx.strokeStyle = '#4e342e';
            ctx.lineWidth = 1;
            for (let i = 0; i < 6; i++) {
                ctx.beginPath();
                ctx.moveTo(x, y + 10 + i * 10);
                ctx.lineTo(x + width, y + 10 + i * 10);
                ctx.stroke();
            }
            // Bottles on shelf
            const bottles = ['#c62828', '#2e7d32', '#1565c0', '#ff9800', '#9c27b0', '#00bcd4', '#ffd700'];
            for (let i = 0; i < 12; i++) {
                const bx = x + 20 + i * 30;
                ctx.fillStyle = bottles[i % bottles.length];
                ctx.fillRect(bx, y + 5, 12, 25);
                ctx.fillRect(bx + 3, y - 5, 6, 12);
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(bx + 3, y - 8, 6, 3);
            }
            // Counter edge
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x, y + height - 5, width, 8);
        }

        function drawLoungeTable(obj) {
            const { x, y, width, height } = obj;
            // Table top
            ctx.fillStyle = '#3e2723';
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height/2, width/2, height/3, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#1a0e0a';
            ctx.lineWidth = 2;
            ctx.stroke();
            // Candle
            ctx.fillStyle = '#fff5e1';
            ctx.fillRect(x + width/2 - 4, y + height/2 - 15, 8, 12);
            // Flame
            ctx.fillStyle = '#ff9800';
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height/2 - 18, 3, 5, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawJukebox(obj) {
            const { x, y, width, height } = obj;
            // Body
            ctx.fillStyle = '#b71c1c';
            ctx.fillRect(x, y + 20, width, height - 20);
            // Top curve
            ctx.fillStyle = '#d32f2f';
            ctx.beginPath();
            ctx.arc(x + width/2, y + 20, width/2, Math.PI, 0);
            ctx.fill();
            // Display window
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(x + 10, y + 40, width - 20, 30);
            // Animated lights
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = (gameTime + i * 10) % 30 < 15 ? '#ffff00' : '#ff6600';
                ctx.beginPath();
                ctx.arc(x + 15 + i * 12, y + 80, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            // Speaker grille
            ctx.fillStyle = '#1a1a1a';
            for (let i = 0; i < 4; i++) {
                ctx.fillRect(x + 10, y + 90 + i * 8, width - 20, 3);
            }
        }

        function drawArcade(obj) {
            const { x, y, width, height } = obj;
            // Cabinet
            ctx.fillStyle = '#1a237e';
            ctx.fillRect(x, y, width, height);
            // Screen
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 5, y + 5, width - 10, 40);
            // Animated screen content
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(x + 10 + (gameTime % 30), y + 20, 5, 15);
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(x + 30, y + 10 + Math.sin(gameTime / 10) * 10, 8, 8);
            // Controls
            ctx.fillStyle = '#ffeb3b';
            ctx.beginPath();
            ctx.arc(x + width/3, y + 55, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#f44336';
            ctx.beginPath();
            ctx.arc(x + width*2/3, y + 55, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawSushiBar(obj) {
            const { x, y, width, height } = obj;
            // Conveyor belt frame
            ctx.fillStyle = '#37474f';
            ctx.fillRect(x, y, width, height);
            // Conveyor belt
            ctx.fillStyle = '#263238';
            ctx.fillRect(x + 10, y + 15, width - 20, height - 30);
            // Moving sushi plates
            for (let i = 0; i < 6; i++) {
                const px = x + 20 + ((gameTime/2 + i * 80) % (width - 40));
                const py = y + 25;
                // Plate
                ctx.fillStyle = ['#e91e63', '#2196f3', '#4caf50', '#ff9800'][i % 4];
                ctx.beginPath();
                ctx.ellipse(px, py, 15, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                // Sushi
                ctx.fillStyle = '#fff';
                ctx.fillRect(px - 8, py - 8, 16, 6);
                ctx.fillStyle = '#ff5722';
                ctx.fillRect(px - 6, py - 12, 12, 5);
            }
            // Counter edge
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(x, y + height - 10, width, 12);
        }

        function drawSushiTable(obj) {
            const { x, y, width, height } = obj;
            // Table
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(x, y, width, height);
            ctx.fillStyle = '#3e2723';
            ctx.fillRect(x + 5, y + 5, width - 10, height - 10);
            // Place settings
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 15, y + 15, 20, 15);
            ctx.fillRect(x + width - 35, y + 15, 20, 15);
            // Chopsticks
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x + 40, y + 18, 2, 10);
            ctx.fillRect(x + 44, y + 18, 2, 10);
        }

        function drawLuckyCat(obj) {
            const { x, y, width, height } = obj;
            const wave = Math.sin(gameTime / 10) * 15; // Waving arm
            // Body
            ctx.fillStyle = '#fff5e1';
            ctx.beginPath();
            ctx.ellipse(x + width/2, y + height - 30, 25, 35, 0, 0, Math.PI * 2);
            ctx.fill();
            // Head
            ctx.beginPath();
            ctx.arc(x + width/2, y + 30, 22, 0, Math.PI * 2);
            ctx.fill();
            // Ears
            ctx.beginPath();
            ctx.moveTo(x + 15, y + 15);
            ctx.lineTo(x + 25, y + 30);
            ctx.lineTo(x + 8, y + 30);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x + width - 15, y + 15);
            ctx.lineTo(x + width - 25, y + 30);
            ctx.lineTo(x + width - 8, y + 30);
            ctx.fill();
            // Eyes
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(x + width/2 - 8, y + 28, 3, 0, Math.PI * 2);
            ctx.arc(x + width/2 + 8, y + 28, 3, 0, Math.PI * 2);
            ctx.fill();
            // Waving arm
            ctx.fillStyle = '#fff5e1';
            ctx.save();
            ctx.translate(x + width - 15, y + 50);
            ctx.rotate(wave * Math.PI / 180);
            ctx.fillRect(-5, -20, 10, 25);
            ctx.restore();
            // Coin
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(x + width/2, y + height - 25, 12, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawAquarium(obj) {
            const { x, y, width, height } = obj;
            // Frame
            ctx.fillStyle = '#4e342e';
            ctx.fillRect(x - 5, y - 5, width + 10, height + 10);
            // Water
            ctx.fillStyle = 'rgba(0, 150, 200, 0.7)';
            ctx.fillRect(x, y, width, height);
            // Fish
            for (let i = 0; i < 4; i++) {
                const fx = x + 10 + ((gameTime/3 + i * 40) % (width - 20));
                const fy = y + 20 + i * 30 + Math.sin(gameTime/20 + i) * 10;
                ctx.fillStyle = ['#ff5722', '#ffc107', '#e91e63', '#00bcd4'][i];
                ctx.beginPath();
                ctx.ellipse(fx, fy, 8, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                // Tail
                ctx.beginPath();
                ctx.moveTo(fx - 8, fy);
                ctx.lineTo(fx - 15, fy - 5);
                ctx.lineTo(fx - 15, fy + 5);
                ctx.fill();
            }
            // Bubbles
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            for (let i = 0; i < 5; i++) {
                const bx = x + 20 + i * 15;
                const by = y + height - ((gameTime + i * 20) % height);
                ctx.beginPath();
                ctx.arc(bx, by, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawBonsai(obj) {
            const { x, y, width, height } = obj;
            // Pot
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(x + 10, y + height - 25, width - 20, 25);
            ctx.fillStyle = '#3e2723';
            ctx.fillRect(x + 5, y + height - 30, width - 10, 8);
            // Trunk
            ctx.fillStyle = '#4a3728';
            ctx.fillRect(x + width/2 - 4, y + 30, 8, height - 55);
            // Foliage (cloud-like)
            ctx.fillStyle = '#2e7d32';
            ctx.beginPath();
            ctx.arc(x + width/2, y + 25, 20, 0, Math.PI * 2);
            ctx.arc(x + width/2 - 15, y + 35, 12, 0, Math.PI * 2);
            ctx.arc(x + width/2 + 15, y + 35, 12, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawLoungeSign() {
            ctx.fillStyle = '#ffd700';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('The Tipsy Dolphin', 400, 50);
        }

        function drawSushiSign() {
            ctx.fillStyle = '#ff6b6b';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('Sakura Sushi', 400, 50);
        }

        function drawExitIndicators() {
            const room = rooms[currentRoom];
            ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'center';

            if (room.exits.right) {
                ctx.beginPath();
                ctx.moveTo(790, 280);
                ctx.lineTo(780, 300);
                ctx.lineTo(790, 320);
                ctx.fill();
                ctx.fillText(rooms[room.exits.right].name.split(' ')[0], 750, 340);
            }
            if (room.exits.left) {
                ctx.beginPath();
                ctx.moveTo(10, 280);
                ctx.lineTo(20, 300);
                ctx.lineTo(10, 320);
                ctx.fill();
                ctx.fillText(rooms[room.exits.left].name.split(' ')[0], 60, 340);
            }
            if (room.exits.down) {
                ctx.beginPath();
                ctx.moveTo(380, 590);
                ctx.lineTo(400, 580);
                ctx.lineTo(420, 590);
                ctx.fill();
            }
            if (room.exits.up) {
                ctx.beginPath();
                ctx.moveTo(380, 60);
                ctx.lineTo(400, 70);
                ctx.lineTo(420, 60);
                ctx.fill();
            }
        }

        // Start the game
        gameLoop();
    </script>
</body>
</html>

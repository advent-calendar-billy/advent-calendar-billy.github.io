<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async RPG Adventure</title>
    <!-- jsrsasign library for JWT signing (Service Account Auth) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.8.6/jsrsasign-all-min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; line-height: 1.6; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: auto;}
        h1, h2, h3 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 20px; }
        h2 { border-bottom: 1px solid #ecf0f1; padding-bottom: 10px; margin-top: 30px;}
        textarea { width: 98%; padding: 10px; margin-bottom: 10px; border: 1px solid #bdc3c7; border-radius: 4px; min-height: 70px; font-size: 1em; }
        button { padding: 10px 18px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 5px; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #adminLoginSection, #dmControlsSection, #playerActionSection, #playerViewSection, #playerLoginSection { margin-bottom: 20px; padding: 15px; background-color:#fdfdfd; border:1px solid #ecf0f1; border-radius:5px;}
        #dmControlsSection, .dm-thoughts-log-container { display: none; }
        .error { color: #e74c3c; font-weight: bold; font-size: 0.9em; }
        .status { color: #27ae60; font-size: 0.9em; margin-top: 10px; }
        .log-entry { margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #ecf0f1; background-color: #f9f9f9; border-radius: 3px;}
        .log-entry:last-child { border-bottom: none; }
        .log-entry strong { color: #2980b9; }
        .log-entry .meta { font-size: 0.8em; color: #7f8c8d; display: block; margin-bottom: 3px;}
        #adminPassword, #playerPassword { padding: 8px; border-radius: 4px; border: 1px solid #bdc3c7; font-size: 1em; margin-right: 5px;}
        #gameLogDisplay, #dmOnlyLogDisplay { max-height: 450px; overflow-y: auto; border: 1px solid #ecf0f1; padding: 15px; background-color: #fdfdfd; margin-top:10px; border-radius: 4px;}
        label { margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Async RPG Adventure</h1>

        <div id="playerLoginSection">
            <h2>Player Login</h2>
            <input type="password" id="playerPassword" placeholder="Player Password">
            <button onclick="loginAsPlayer()">Login</button>
            <p id="playerLoginError" class="error"></p>
        </div>

        <div id="adminLoginSection">
            <h2>DM Login</h2>
            <input type="password" id="adminPassword" placeholder="DM Password">
            <button onclick="loginAsAdmin()">Login</button>
            <p id="adminLoginError" class="error"></p>
        </div>

        <div id="dmControlsSection">
            <h2>DM Controls</h2>
            <textarea id="dmThoughtInput" placeholder="DM Thoughts (secret, only for you)"></textarea>
            <textarea id="dmPlayerMessageInput" placeholder="Prompt or Outcome (visible to player)"></textarea>
            <button onclick="postDmMessage()">Post Message</button>
            <div class="dm-thoughts-log-container">
                <h3>DM Secret Thoughts Log:</h3>
                <div id="dmOnlyLogDisplay"></div>
            </div>
        </div>

        <div id="playerViewSection">
            <h2>Game Log</h2>
            <button onclick="loadGameData()" id="refreshGameButton">Refresh Game</button>
            <div id="gameLogDisplay">Login to view the story...</div>
        </div>

        <div id="playerActionSection">
            <h2>Player Action</h2>
            <textarea id="playerActionInput" placeholder="What is your action, space traveler?"></textarea>
            <input type="checkbox" id="spaceTravelerCheckbox">
            <label for="spaceTravelerCheckbox">I'm a space traveler</label>
            <br><br>
            <button onclick="submitPlayerAction()" id="submitPlayerActionButton">Submit Action</button>
            <p id="playerActionError" class="error"></p>
        </div>

        <p id="statusMessage" class="status"></p>
    </div>

    <script>
/* ---------- CONFIG ---------- */
const PLAYER_PASSWORD = 'space';
const DM_PASSWORD = 'dm2';

/* Google Sheet IDs */
const SPREADSHEET_ID = '1SXE6BwnRqVR93MFp-zSI83bBgcqZ5y53Hg197VrzjSo';
const SHEET_NAME = 'Sheet1';
const DATA_RANGE = `${SHEET_NAME}!A:D`;

/* ---------- GLOBAL STATE ---------- */
let isPlayerLoggedIn = false;
let isAdminLoggedIn  = false;
let serviceAccountCredentials = null;
let accessToken      = null;
let tokenExpiryTime  = 0;
let isLoading        = false;
let playerCredentials = null;
let dmCredentials = null;

/* ---------- DOM ---------- */
const playerLoginSection    = document.getElementById('playerLoginSection');
const playerPasswordInput   = document.getElementById('playerPassword');
const playerLoginError      = document.getElementById('playerLoginError');

const adminLoginSection     = document.getElementById('adminLoginSection');
const adminPasswordInput    = document.getElementById('adminPassword');
const adminLoginError       = document.getElementById('adminLoginError');

const dmControlsSection     = document.getElementById('dmControlsSection');
const dmThoughtInput        = document.getElementById('dmThoughtInput');
const dmPlayerMessageInput  = document.getElementById('dmPlayerMessageInput');
const dmOnlyLogDisplay      = document.getElementById('dmOnlyLogDisplay');
const dmThoughtsLogContainer= document.querySelector('.dm-thoughts-log-container');

const gameLogDisplay        = document.getElementById('gameLogDisplay');
const playerActionInput     = document.getElementById('playerActionInput');
const spaceTravelerCheckbox = document.getElementById('spaceTravelerCheckbox');
const playerActionError     = document.getElementById('playerActionError');
const statusMessage         = document.getElementById('statusMessage');

/* ---------- UI helpers ---------- */
function showLoading(msg='Processing...') {
    isLoading = true;
    statusMessage.textContent = msg;
    document.querySelectorAll('button').forEach(b => b.disabled = true);
}
function hideLoading(msg='Ready.') {
    isLoading = false;
    statusMessage.textContent = msg;
    document.querySelectorAll('button').forEach(b => b.disabled = false);
}

/* ---------- CREDENTIALS LOADING ---------- */
async function loadCredentials() {
    try {
        // Load player credentials
        const playerResponse = await fetch('player_credentials.hex');
        if (!playerResponse.ok) throw new Error('Failed to load player credentials');
        playerCredentials = await playerResponse.text();
        
        // Load DM credentials
        const dmResponse = await fetch('dm_credentials.hex');
        if (!dmResponse.ok) throw new Error('Failed to load DM credentials');
        dmCredentials = await dmResponse.text();
        
        hideLoading('Credentials loaded successfully.');
        return true;
    } catch (e) {
        console.error('Error loading credentials', e);
        statusMessage.textContent = 'CRITICAL: Could not load credentials files.';
        return false;
    }
}

/* ---------- XOR helper ---------- */
function xorDecrypt(hex, key) {
    const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
    const keyB = new TextEncoder().encode(key);
    const plain = bytes.map((b, i) => b ^ keyB[i % keyB.length]);
    return new TextDecoder().decode(plain);
}

/* ---------- LOGIN ---------- */
async function initialiseCredentials(cipherHex, pass) {
    if (serviceAccountCredentials) return true;
    try {
        const json = xorDecrypt(cipherHex, pass);
        serviceAccountCredentials = JSON.parse(json);
        return true;
    } catch (e) {
        console.error('SA decrypt/parse error', e);
        statusMessage.textContent = 'CRITICAL: Could not load service account creds.';
        return false;
    }
}

async function loginAsPlayer() {
    if (playerPasswordInput.value !== PLAYER_PASSWORD) {
        playerLoginError.textContent = 'Incorrect password.';
        return;
    }
    
    if (!playerCredentials) {
        if (!await loadCredentials()) {
            playerLoginError.textContent = 'Failed to load credentials.';
            return;
        }
    }
    
    if (!await initialiseCredentials(playerCredentials, PLAYER_PASSWORD)) {
        playerLoginError.textContent = 'Failed to initialize credentials.';
        return;
    }
    
    playerLoginError.textContent = '';
    isPlayerLoggedIn = true;
    playerLoginSection.style.display = 'none';
    statusMessage.textContent = 'Player logged in.';
    loadGameData();
}

async function loginAsAdmin() {
    if (adminPasswordInput.value !== DM_PASSWORD) {
        adminLoginError.textContent = 'Incorrect password.';
        return;
    }
    
    if (!dmCredentials) {
        if (!await loadCredentials()) {
            adminLoginError.textContent = 'Failed to load credentials.';
            return;
        }
    }
    
    if (!await initialiseCredentials(dmCredentials, DM_PASSWORD)) {
        adminLoginError.textContent = 'Failed to initialize credentials.';
        return;
    }
    
    adminLoginError.textContent = '';
    isAdminLoggedIn = true;
    adminLoginSection.style.display = 'none';
    dmControlsSection.style.display = 'block';
    dmThoughtsLogContainer.style.display = 'block';
    statusMessage.textContent = 'DM logged in.';
    loadGameData();
}

/* ---------- GOOGLE AUTH ---------- */
async function getAccessToken() {
    if (accessToken && Date.now() < tokenExpiryTime) return accessToken;
    if (!serviceAccountCredentials) throw new Error('Not logged in.');
    const header = { alg: 'RS256', typ: 'JWT' };
    const now = Math.floor(Date.now() / 1000);
    const claims = {
        iss: serviceAccountCredentials.client_email,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        aud: 'https://oauth2.googleapis.com/token',
        exp: now + 3500,
        iat: now
    };
    const sJWT = KJUR.jws.JWS.sign(
        'RS256',
        JSON.stringify(header),
        JSON.stringify(claims),
        serviceAccountCredentials.private_key
    );
    const res = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=' + sJWT
    });
    if (!res.ok) {
        const err = await res.json(); throw new Error('Token exchange failed: ' + JSON.stringify(err));
    }
    const data = await res.json();
    accessToken = data.access_token;
    tokenExpiryTime = Date.now() + data.expires_in * 1000 - 60000;
    return accessToken;
}

/* ---------- SHEET HELPERS ---------- */
async function appendToSheet(values) {
    const token = await getAccessToken();
    const rangeForAppend = `${SHEET_NAME}!A1`;
    const body = { values };
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeForAppend}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    if (!res.ok) {
        const err = await res.json(); throw new Error('Append failed: ' + err.error.message);
    }
    return res.json();
}

async function readSheet() {
    const token = await getAccessToken();
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}`, {
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) {
        const err = await res.json(); throw new Error('Read failed: ' + err.error.message);
    }
    const data = await res.json();
    return data.values || [];
}

/* ---------- DM ---------- */
async function postDmMessage() {
    if (isLoading) return;
    if (!isAdminLoggedIn) { statusMessage.textContent = 'You must be logged in as DM.'; return; }
    const thought = dmThoughtInput.value.trim();
    const playerMsg = dmPlayerMessageInput.value.trim();
    if (!thought && !playerMsg) { statusMessage.textContent = 'Enter a message or thought.'; return; }
    showLoading('Posting DM message...');
    const ts = new Date().toISOString();
    const rows = [];
    if (playerMsg) rows.push([ts, 'DM', 'NARRATION', playerMsg]);
    if (thought) rows.push([ts, 'DM', 'DM_THOUGHT', thought]);
    try {
        await appendToSheet(rows);
        dmThoughtInput.value = '';
        dmPlayerMessageInput.value = '';
        await loadGameData();
        hideLoading('DM message posted.');
    } catch (e) {
        hideLoading('Error: ' + e.message);
    }
}

/* ---------- PLAYER ---------- */
async function submitPlayerAction() {
    if (isLoading) return;
    if (!isPlayerLoggedIn) { playerActionError.textContent = 'Login first.'; return; }
    if (!spaceTravelerCheckbox.checked) {
        playerActionError.textContent = 'Confirm you are a space traveler.'; return; }
    const actionText = playerActionInput.value.trim();
    if (!actionText) { playerActionError.textContent = 'Enter your action.'; return; }
    playerActionError.textContent = '';
    showLoading('Submitting action...');
    const ts = new Date().toISOString();
    try {
        await appendToSheet([[ts, 'PLAYER', 'ACTION', actionText]]);
        playerActionInput.value = '';
        await loadGameData();
        hideLoading('Action submitted.');
    } catch (e) {
        hideLoading('Error: ' + e.message);
        playerActionError.textContent = 'Error: ' + e.message;
    }
}

/* ---------- GAME LOG ---------- */
async function loadGameData() {
    if (!isPlayerLoggedIn && !isAdminLoggedIn) { return; }
    showLoading('Loading game data...');
    try {
        const rows = await readSheet();
        gameLogDisplay.innerHTML = '';
        if (isAdminLoggedIn) dmOnlyLogDisplay.innerHTML = '';
        if (rows.length === 0) {
            gameLogDisplay.innerHTML = '<p>No game entries yet.</p>';
            if (isAdminLoggedIn) dmOnlyLogDisplay.innerHTML = '<p>No DM thoughts yet.</p>';
            hideLoading('Game log empty.');
            return;
        }
        rows.forEach(r => {
            if (!r || r.length < 4) return;
            const [ts, author, type, content] = r;
            const d = new Date(ts);
            const time = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
            const date = d.toLocaleDateString([], {weekday:'short',month:'short',day:'numeric'});
            if (type === 'DM_THOUGHT') {
                if (isAdminLoggedIn) {
                    const div = document.createElement('div');
                    div.classList.add('log-entry');
                    div.innerHTML = `<span class="meta">[THOUGHT] ${date} ${time}</span>${content}`;
                    dmOnlyLogDisplay.appendChild(div);
                }
            } else {
                const div = document.createElement('div');
                div.classList.add('log-entry');
                let displayAuthor = author;
                if (author === 'DM' && type === 'NARRATION') displayAuthor = 'Narrator';
                else if (author === 'PLAYER' && type === 'ACTION') displayAuthor = 'Player';
                div.innerHTML = `<span class="meta">${displayAuthor} - ${date} ${time}</span><strong>${content}</strong>`;
                gameLogDisplay.appendChild(div);
            }
        });
        gameLogDisplay.scrollTop = gameLogDisplay.scrollHeight;
        if (isAdminLoggedIn) dmOnlyLogDisplay.scrollTop = dmOnlyLogDisplay.scrollHeight;
        hideLoading('Game data loaded.');
    } catch (e) {
        hideLoading('Failed: ' + e.message);
        gameLogDisplay.innerHTML = '<p class="error">Error loading game data: ' + e.message + '</p>';
    }
}

/* ---------- On first load ---------- */
window.onload = async () => {
    if (typeof KJUR === 'undefined') {
        const msg = 'CRITICAL: jsrsasign failed to load.';
        statusMessage.textContent = msg;
        document.querySelectorAll('button').forEach(b => b.disabled = true);
    } else {
        loadCredentials();
        hideLoading('Welcome! Please log in.');
    }
};
    </script>
</body>
</html>
